---
title: "Code"
author: "Edna Chiang"
date: "July 17, 2018"
output: html_document
---
### Load Libraries
```{r}
library(ape)
library(dplyr)
library(ggplot2)
library(gplots)
library(phangorn)
library(tidyr)
library(vegan)
library(phyloseq)
library(grid)
library(pgirmess)
library(lme4)
theme_set(theme_bw())
set.seed(1)
```

### Load Functions
```{r}
veganCovEllipse <- function(cov, center = c(0, 0), scale = 1, npoints = 100) {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
}
```

### Import Data
```{r}
# Link files
shared = "mothur_outputs/final.shared"
taxonomy = "mothur_outputs/final.taxonomy"


# Import mothur data
mothurdata = import_mothur(
  mothur_shared_file = shared,
  mothur_constaxonomy_file = taxonomy)

# Add OTU column in taxonomy table
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
                               row.names(tax_table(mothurdata)))

# Rename taxonomy table columns
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")

```

### Explore mothurdata object
```{r}
samp.sum <- data.frame(colSums(otu_table(mothurdata)))
colnames(samp.sum) <- "Sample_TotalSeqs"
samp.sum$sample <- row.names(samp.sum)
samp.sum <- arrange(samp.sum, Sample_TotalSeqs)

ggplot(samp.sum, aes(x=reorder(sample, Sample_TotalSeqs), y=Sample_TotalSeqs)) +
  ylab("Number of Sequences per Sample") +
  geom_bar(stat="identity", colour="black", fill="cornflowerblue") +
  xlab("Sample Name") +
  ggtitle("Total Number of Sequences per Sample") + 
  theme(axis.text.x = element_text(colour = "black", size=6, angle=45,hjust = 1,
                                   vjust = 1))

ggplot(data.frame(sum = sample_sums(mothurdata)), aes(sum)) + 
  geom_histogram(colour = "white", fill = "blue", bins=60) + 
  ggtitle("Sample read counts") + 
  xlab("total sequences")


# Min, Mean, Max of sample read counts
min(sample_sums(mothurdata))
mean(sample_sums(mothurdata))
median(sample_sums(mothurdata))
max(sample_sums(mothurdata))
```


### Create Phyloseq Object
```{r}
meta <- read.csv("metadata.csv")
colnames(meta)[1] <- "Sample_ID"
rownames(meta) <- meta$Sample
meta$Time <- ordered(meta$Time, levels=c("Pre-treatment", "Post-treatment"))
divsum <- read.table("mothur_outputs/final.summary", header=T)


# Add in diversity summaries
meta[,7:17] <- divsum[,3:12]

# Create intermin phyloseq object
physeq <- merge_phyloseq(mothurdata, sample_data(meta))

#save(physeq, file="Physeq.RData")

# Subset out paired samples
physeq.pair <- subset_samples(physeq, Sample_ID != "HF8C")
physeq.pair <- subset_samples(physeq.pair, Sample_ID != "SC4A")
physeq.pair <- subset_samples(physeq.pair, Sample_ID != "TV2A")
physeq.pair <- subset_samples(physeq.pair, Sample_ID != "TV8A")
#save(physeq.pair, file="Physeq.pair.RData")

# Subset out Pre vs. Post
physeq.pre <- subset_samples(physeq.pair, Time == "Pre-treatment")
#save(physeq.pre, file="Physeq.pre.RData")
physeq.post <- subset_samples(physeq.pair, Time == "Post-treatment")
#save(physeq.post, file="Physeq.post.RData")

# Subset Post w/o Low Fat (due to skewing)
physeq.post.rem <- subset_samples(physeq.post, Treatment != "Low Fat")
#save(physeq.post.rem, file="Physeq.post.rem.RData")

# Subset out Female vs. Male
physeq.fem <- subset_samples(physeq.pair, Sex == "Female")
#save(physeq.fem, file="Physeq.fem.RData")
physeq.mal <- subset_samples(physeq.pair, Sex == "Male")
#save(physeq.mal, file="Physeq.mal.RData")

# Subset out Sex + Time
physeq.pre.fem <- subset_samples(physeq.pre, Sex == "Female")
#save(physeq.pre.fem, file="Physeq.pre.fem.RData")
physeq.pre.mal <- subset_samples(physeq.pre, Sex == "Male")
#save(physeq.pre.mal, file="Physeq.pre.mal.RData")
physeq.post.fem <- subset_samples(physeq.post, Sex == "Female")
#save(physeq.post.fem, file="Physeq.post.fem.RData")
physeq.post.mal <- subset_samples(physeq.post, Sex == "Male")
#save(physeq.post.mal, file="Physeq.post.mal.RData")

# Remove Low Fat from Sex + Post subsets
physeq.post.fem.rem <- subset_samples(physeq.post.fem, Treatment != "Low Fat")
#save(physeq.post.fem.rem, file="Physeq.post.fem.rem.RData")
physeq.post.mal.rem <- subset_samples(physeq.post.mal, Treatment != "Low Fat")
#save(physeq.post.mal.rem, file="Physeq.post.mal.rem.RData")

# Subset out treatments
physeq.hf <- subset_samples(physeq.pair, Treatment == "High Fat")
#save(physeq.hf, file = "Physeq.hf.RData")
physeq.lf <- subset_samples(physeq.pair, Treatment == "Low Fat")
#save(physeq.hf, file = "Physeq.lf.RData")
physeq.sc <- subset_samples(physeq.pair, Treatment == "Saccharin")
#save(physeq.hf, file = "Physeq.sc.RData")
physeq.tv <- subset_samples(physeq.pair, Treatment == "Stevia")
#save(physeq.hf, file = "Physeq.tv.RData")

```

### Load Phyloseq Object
```{r}
load("Physeq.RData")
load("Physeq.pair.RData")
load("Physeq.pre.RData")
load("Physeq.post.RData")
load("Physeq.post.rem.RData")
load("Physeq.fem.RData")
load("Physeq.mal.RData")
load("Physeq.pre.fem.RData")
load("Physeq.pre.mal.RData")
load("Physeq.post.fem.RData")
load("Physeq.post.mal.RData")
load("Physeq.post.fem.rem.RData")
load("Physeq.post.mal.rem.RData")
load("Physeq.hf.RData")
load("Physeq.lf.RData")
load("Physeq.sc.RData")
load("Physeq.tv.RData")
```

### Alpha Div
```{r}
adiv <- data.frame(sample_data(physeq))
adiv.pair <- data.frame(sample_data(physeq.pair))

### Coverage
# Plot
ggplot(adiv.pair, aes(x=Treatment, y= coverage, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  xlab("Treatment") +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  ylab("Coverage")
# Test normality
hist(adiv.pair$coverage, breaks=10)
qqnorm(adiv.pair$coverage)
qqline(adiv.pair$coverage)
shapiro.test(adiv.pair$coverage)
  # p-value = 0.003709
  # Not normal


### Total OTUs
otu.tot <- data.frame(sample_names(physeq.pair))
# Pull out # of OTUs from all samples
otu.tot$Total_OTUs <- rep("NA", 72)
for(i in 1:72){
  otu.tot[i,2] <- length(which(otu_table(physeq.pair)[,i] != 0))
}
adiv.pair$Total_OTUs <- otu.tot$Total_OTUs
adiv.pair$Total_OTUs <- as.numeric(adiv.pair$Total_OTUs)
adiv.pair.pre <- adiv.pair[which(adiv.pair$Time == "Pre-treatment"),]
adiv.pair.post <- adiv.pair[which(adiv.pair$Time == "Post-treatment"),]
# Plot
ggplot(adiv.pair, aes(x=Treatment, y=Total_OTUs, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  xlab("Treatment") +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  ylab("Total OTUs")
# Test normality
hist(adiv.pair$Total_OTUs, breaks=10)
qqnorm(adiv.pair$Total_OTUs)
qqline(adiv.pair$Total_OTUs)
shapiro.test(adiv.pair$Total_OTUs)
  # p-value = 0.002107
  # Not normal
# Stats
kruskal.test(formula = Total_OTUs ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # All Pre-treatment
  # p-value = 0.003924
kruskalmc(resp = Total_OTUs ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Significant:  
      # Low fat - saccharin
kruskal.test(formula = Total_OTUs ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # All Post-treatment
  # p-value = 0.009035
kruskalmc(resp = Total_OTUs ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Significant:
    # High Fat - Low Fat
#friedman.test(formula = Total_OTUs ~ Treatment | Time, data = adiv.pair)
wilcox.test(Total_OTUs ~ Time, data=adiv.pair, paired=T)
  # p-value = 0.5245
wilcox.test(Total_OTUs ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 0.6015
wilcox.test(Total_OTUs ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.1589
# Repeated Measure
summary(lmer(Total_OTUs ~ Time + Treatment + Sex + (1|Subj_ID), data=adiv.pair))
  # Variance explained by Subj_ID = 0.0

### Chao
# Plot
tiff("Chao.tiff", width=6.5, height=3, units="in", res=600)
ggplot(adiv.pair, aes(x=Treatment, y=chao, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  xlab("Treatment") +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  ylab("Chao Richness")
dev.off()
# Test normality
hist(adiv.pair$chao, breaks=10)
qqnorm(adiv.pair$chao)
qqline(adiv.pair$chao)
shapiro.test(adiv.pair$chao)
  # p-value = 5.717e-05
  # Not normal
# Stats
kruskal.test(formula = chao ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # All Pre-treatment
  # p-value = 0.4731
kruskal.test(formula = chao ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # All Post-treatment
  # p-value = 0.0003939
kruskalmc(resp = chao ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Significant:
    # High Fat - Low Fat
    # Low Fat - Saccharin
#friedman.test(formula = chao ~ Treatment | Time, data = adiv.pair)
wilcox.test(chao ~ Time, data=adiv.pair, paired=T)
  # p-value = 0.02096
wilcox.test(chao ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "High Fat"),], paired=T)
  # High Fat
  # p-value = 0.003906
wilcox.test(chao ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Low Fat"),], paired=T)
  # Low Fat
  # p-value = 0.4316
wilcox.test(chao ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Saccharin"),], paired=T)
  # Saccharin
  # p-value = 0.07422
wilcox.test(chao ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Stevia"),], paired=T)
  # p-value = 0.3125
wilcox.test(chao ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 1
wilcox.test(chao ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.8147
# Repeated Measures
summary(lmer(chao ~ Time + Treatment + Sex + (1|Subj_ID), data=adiv.pair))
  # Variance explained by Subj_ID = 1.376e-13

### Berger-Parker
# Plot
ggplot(adiv.pair, aes(x=Treatment, y=bergerparker, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  xlab("Treatment") +
  ylab("Berger-Parker")
# Test normality
hist(adiv.pair$bergerparker, breaks=10)
qqnorm(adiv.pair$bergerparker)
qqline(adiv.pair$bergerparker)
shapiro.test(adiv.pair$bergerparker)
  # p-value = 0.00269
  # Not normal
# Stats
kruskal.test(formula = bergerparker ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # All Pre-treatment
  # p-value = 0.1931
kruskal.test(formula = bergerparker ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # All Post-treatment
  # p-value = 0.2489
#friedman.test(formula = bergerparker ~ Treatment | Time, data = adiv.pair)
wilcox.test(bergerparker ~ Time, data=adiv.pair, paired=T)
  # p-value = 0.01098
wilcox.test(bergerparker ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "High Fat"),], paired=T)
  # High Fat
  # p-value = 0.07422
wilcox.test(bergerparker ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Low Fat"),], paired=T)
  # Low Fat
  # p-value = 0.1934
wilcox.test(bergerparker ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Saccharin"),], paired=T)
  # Saccharin
  # p-value = 0.8203
wilcox.test(bergerparker ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Stevia"),], paired=T)
  # p-value = 0.1484
wilcox.test(bergerparker ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 0.6279
wilcox.test(bergerparker ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.006402
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Female"),], paired=T)
  # Female High Fat Time
  # p-value = 0.375
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Male"),], paired=T)
  # Male High Fat Time
  # p-value = 0.3125
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Female"),], paired=T)
  # Female Low Fat Time
  # p-value = 0.1875
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Male"),], paired=T)
  # Male Low Fat Time
  # p-value = 0.8125
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Female"),], paired=T)
  # Female Saccharin Time
  # p-value = 0.125
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Male"),], paired=T)
  # Male Saccharin Time
  # p-value = 1
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Female"),], paired=T)
  # Female Stevia Time
  # p-value = 0.625
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Male"),], paired=T)
  # Male Stevia Time
  # p-value = 0.375
# Repeated Measures
summary(lmer(bergerparker ~ Time + Treatment + Sex + (1|Subj_ID), data=adiv.pair))
  # Variance explained by Subj_ID = 0

### Shannon
# Plot
ggplot(adiv.pair, aes(x=Treatment, y=shannon, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  xlab("Treatment") +
  ylab("Shannon Diversity")
# Test normality
hist(adiv.pair$shannon, breaks=10)
qqnorm(adiv.pair$shannon)
qqline(adiv.pair$shannon)
shapiro.test(adiv.pair$shannon)
  # p-value = 0.5704
  # Normal
# Stats
summary(aov(shannon ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),]))
  # Pre-treatment
  # P-value = 0.589
summary(aov(shannon ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),]))
  # Post-treatment
  # P-value = 0.043
TukeyHSD(aov(shannon ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),]))
  # Post-treamtent Significance:
    # Saccharin - Low Fat
t.test(shannon ~ Time, data = adiv.pair, paired=T)
  # p-value = 0.9899
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "High Fat"),], paired=T)
  # High Fat
  # p-value = 0.9751
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Low Fat"),], paired=T)
  # Low Fat
  # p-value = 0.03614
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Saccharin"),], paired=T)
  # Saccharin
  # p-value = 0.192
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Stevia"),], paired=T)
  # Stevia
  # p-value = 0.1537
t.test(shannon ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 0.6813
t.test(shannon ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.01769
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Female"),], paired=T)
  # Female High Fat Time
  # p-value = 0.4814
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Male"),], paired=T)
  # Male High Fat Time
  # p-value = 0.05131
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Female"),], paired=T)
  # Female Low Fat Time
  # p-value = 0.11
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Male"),], paired=T)
  # Male Low Fat Time
  # p-value = 0.2679
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Female"),], paired=T)
  # Female Saccharin Time
  # p-value = 0.1392
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Male"),], paired=T)
  # Male Saccharin Time
  # p-value = 0.2168
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Female"),], paired=T)
  # Female Stevia Time
  # p-value = 0.5392
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Male"),], paired=T)
  # Male Stevia Time
  # p-value = 0.05621
# Repeated Measure
summary(lmer(shannon ~ Time + Treatment + Sex + (1|Subj_ID), data=adiv.pair))
  # Variance explained by Subj_ID = 0

### Inverse Simpson
# Plot
tiff("InvSimp.tiff", width=6.5, height=3, units="in", res=600)
ggplot(adiv.pair, aes(x=Treatment, y= invsimpson, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  xlab("Treatment") +
  ylab("Inverse Simpson Weighted Diversity")
dev.off()
# Test normality
hist(adiv.pair$invsimpson, breaks=10)
qqnorm(adiv.pair$invsimpson)
qqline(adiv.pair$invsimpson)
shapiro.test(adiv.pair$invsimpson)
  # p-value = 0.2751
  # Normal
# Stats
summary(aov(invsimpson ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),]))
  # Pre-treatment
  # P-value = 0.323
summary(aov(invsimpson ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),]))
  # Post-treatment
t.test(invsimpson ~ Time, data = adiv.pair, paired=T)
  # p-value = 0.09364
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "High Fat"),], paired=T)
  # High Fat
  # p-value = 0.2415
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Low Fat"),], paired=T)
  # Low Fat
  # p-value = 0.0852
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Saccharin"),], paired=T)
  # Saccharin
  # p-value = 0.9167
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Stevia"),], paired=T)
  # Stevia
  # p-value = 0.7599
t.test(invsimpson ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 0.9731
t.test(invsimpson ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.001503
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Female"),], paired=T)
  # Female High Fat Time
  # p-value = 0.5901
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Male"),], paired=T)
  # Male High Fat Time
  # p-value = 0.1063
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Female"),], paired=T)
  # Female Low Fat Time
  # p-value = 0.1735
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Male"),], paired=T)
  # Male Low Fat Time
  # p-value = 0.3996
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Female"),], paired=T)
  # Female Saccharin Time
  # p-value = 0.1378
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Male"),], paired=T)
  # Male Saccharin Time
  # p-value = 0.4341
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Female"),], paired=T)
  # Female Stevia Time
  # p-value = 0.6195
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Male"),], paired=T)
  # Male Stevia Time
  # p-value = 0.0892
# Repeated Measure
summary(lmer(invsimpson ~ Time + Treatment + Sex + (1|Subj_ID), data=adiv.pair))
  # Variance explained by Subj_ID = 0
```


### Examine Phyla
```{r}
# Merge samples with the same taxonomic rank
goodphy <- tax_glom(physeq.pair, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99 <- transform_sample_counts(goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <0.1% rel abund
phy99 <- prune_taxa(taxa_sums(phy99) > 0.01, phy99)

# Create rank abundance of phyla
barplot(sort(taxa_sums(phy99),TRUE)[1:20]/nsamples(phy99),las=2,cex.axis=.7)


# Summarize data
phy.df <- psmelt(phy99)
phy.df$Phylum <- ordered(phy.df$Phylum, levels=c("Firmicutes", "Bacteroidetes", "Verrucomicrobia", "Tenericutes", "Proteobacteria", "Actinobacteria", "Unclassified", "Cyanobacteria"))
phy.df$Phylum[which(is.na(phy.df$Phylum))] <- rep("Unclassified",length(which(is.na(phy.df$Phylum))))
phy.sum <- phy.df %>%
  group_by(Treatment, Time, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))

# Calculate IQR limits
phy.sum$iqr.min <- phy.sum$Median - 0.5*phy.sum$iqr
phy.sum[which(phy.sum$iqr.min < 0),10] <- 0
  # Any IQR min < 0, change to 0 (otherwise error bar won't plot)
phy.sum$iqr.max <- phy.sum$Median + 0.5*phy.sum$iqr


### Barplot ###
tiff("phyla.facet.tiff", width = 13, height = 8, units = "in", res = 300)
ggplot(phy.sum, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  facet_grid(Time ~ Treatment) +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 0.01%") +
  scale_y_continuous(limits=c(0,80), expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        panel.spacing=unit(1, "lines"),
        axis.title = element_text(size=20),
        strip.text.x = element_text(size=14),
        strip.text.y = element_text(size=14),
        axis.text.y = element_text(size=12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size=12))
dev.off()


### Testing barplot for sex + treatment + time
test <- phy.df %>%
  group_by(Treatment, Time, Sex, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))
test$iqr.min <- test$Median - 0.5*test$iqr
test[which(test$iqr.min < 0),10] <- 0
  # Any IQR min < 0, change to 0 (otherwise error bar won't plot)
test$iqr.max <- test$Median + 0.5*test$iqr
ggplot(test, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  facet_grid(Time + Sex ~ Treatment) +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 0.01%") +
  scale_y_continuous(limits=c(0,80), expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        panel.spacing=unit(1, "lines"),
        axis.title = element_text(size=20),
        strip.text.x = element_text(size=14),
        strip.text.y = element_text(size=14),
        axis.text.y = element_text(size=12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size=12))
test <- phy.df %>%
  group_by(Time, Sex, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))
test$iqr.min <- test$Median - 0.5*test$iqr
test[which(test$iqr.min < 0),10] <- 0
  # Any IQR min < 0, change to 0 (otherwise error bar won't plot)
test$iqr.max <- test$Median + 0.5*test$iqr
ggplot(test, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  facet_grid(Time~ Sex) +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 0.01%") +
  scale_y_continuous(limits=c(0,80), expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        panel.spacing=unit(1, "lines"),
        axis.title = element_text(size=20),
        strip.text.x = element_text(size=14),
        strip.text.y = element_text(size=14),
        axis.text.y = element_text(size=12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size=12))
```

### Bray-Curtis NMDS
```{r}
### Paired
bray.nmds <- ordinate(physeq=physeq.pair, method="NMDS", distance="bray")
  # stress = 8.822573e-05

plot_ordination(physeq=physeq.pair, ordination=bray.nmds, color="Treatment", shape="Time") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))

### Pre-treatment
bray.nmds.pre <- ordinate(physeq=physeq.pre, method="NMDS", distance="bray")
  # stress = 0.1847002 
plot_ordination(physeq=physeq.pre, ordination=bray.nmds.pre, color="Treatment", shape="Sex") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))



# Treatment Ellipses
sample_data(physeq.pre)$Elip.treat <- paste(sample_data(physeq.pre)$Treatment)
elip.nmds.pre.treat <- data.frame(MDS1 = bray.nmds.pre$points[,1], MDS2 = bray.nmds.pre$points[,2],
                        Group = sample_data(physeq.pre)$Elip.treat)
plot.new()
elip.ord.pre.treat <- ordiellipse(bray.nmds.pre, sample_data(physeq.pre)$Elip.treat, display="sites", kind="se", conf=0.95, label=T)
elip.pre.treat.df <- data.frame()
for(i in levels(elip.nmds.pre.treat$Group)){
  elip.pre.treat.df <- rbind(elip.pre.treat.df, cbind(as.data.frame(with(elip.nmds.pre.treat[elip.nmds.pre.treat$Group==i,],
                                                     veganCovEllipse(elip.ord.pre.treat[[i]]$cov,
                                                                     elip.ord.pre.treat[[i]]$center,
                                                                     elip.ord.pre.treat[[i]]$scale))),
                                  group=i))
  
}

# Plot w/ treatment ellip
plot_ordination(physeq=physeq.pre, ordination=bray.nmds.pre, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.pre.treat.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)

# Sex Ellipses
sample_data(physeq.pre)$Elip.sex <- paste(sample_data(physeq.pre)$Sex)
elip.nmds.pre.sex <- data.frame(MDS1 = bray.nmds.pre$points[,1], MDS2 = bray.nmds.pre$points[,2],
                        Group = sample_data(physeq.pre)$Elip.sex)
plot.new()
elip.ord.pre.sex <- ordiellipse(bray.nmds.pre, sample_data(physeq.pre)$Elip.sex, display="sites", kind="se", conf=0.95, label=T)
elip.pre.sex.df <- data.frame()
for(i in levels(elip.nmds.pre.sex$Group)){
  elip.pre.sex.df <- rbind(elip.pre.sex.df, cbind(as.data.frame(with(elip.nmds.pre.sex[elip.nmds.pre.sex$Group==i,],
                                                     veganCovEllipse(elip.ord.pre.sex[[i]]$cov,
                                                                     elip.ord.pre.sex[[i]]$center,
                                                                     elip.ord.pre.sex[[i]]$scale))),
                                  group=i))
}

# Plot w/ sex ellip
plot_ordination(physeq=physeq.pre, ordination=bray.nmds.pre, color="Sex") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.pre.sex.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)



### Post-treatment
bray.nmds.post <- ordinate(physeq=physeq.post, method="NMDS", distance="bray")
  # stress = 8.927466e-05

plot_ordination(physeq=physeq.post, ordination=bray.nmds.post, color="Treatment", shape="Sex") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))



### Post-treatment w/o Low Fat
bray.nmds.post.rem <- ordinate(physeq=physeq.post.rem, method="NMDS", distance="bray")
  # stress = 0.2067552

plot_ordination(physeq=physeq.post.rem, ordination=bray.nmds.post.rem, color="Treatment", shape="Sex") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))

# Treatment Ellipses
sample_data(physeq.post.rem)$Elip.treat <- paste(sample_data(physeq.post.rem)$Treatment)
elip.nmds.post.rem.treat <- data.frame(MDS1 = bray.nmds.post.rem$points[,1], MDS2 = bray.nmds.post.rem$points[,2],
                        Group = sample_data(physeq.post.rem)$Elip.treat)
plot.new()
elip.ord.post.rem.treat <- ordiellipse(bray.nmds.post.rem, sample_data(physeq.post.rem)$Elip.treat, display="sites", kind="se", conf=0.95, label=T)
elip.post.rem.treat.df <- data.frame()
for(i in levels(elip.nmds.post.rem.treat$Group)){
  elip.post.rem.treat.df <- rbind(elip.post.rem.treat.df, cbind(as.data.frame(with(elip.nmds.post.rem.treat[elip.nmds.post.rem.treat$Group==i,],
                                                     veganCovEllipse(elip.ord.post.rem.treat[[i]]$cov,
                                                                     elip.ord.post.rem.treat[[i]]$center,
                                                                     elip.ord.post.rem.treat[[i]]$scale))),
                                  group=i))
  
}

# Plot w/ treatment ellip
plot_ordination(physeq=physeq.post.rem, ordination=bray.nmds.post.rem, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.post.rem.treat.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)

# Sex Ellipses
sample_data(physeq.post.rem)$Elip.sex <- paste(sample_data(physeq.post.rem)$Sex)
elip.nmds.post.rem.sex <- data.frame(MDS1 = bray.nmds.post.rem$points[,1], MDS2 = bray.nmds.post.rem$points[,2],
                        Group = sample_data(physeq.post.rem)$Elip.sex)
plot.new()
elip.ord.post.rem.sex <- ordiellipse(bray.nmds.post.rem, sample_data(physeq.post.rem)$Elip.sex, display="sites", kind="se", conf=0.95, label=T)
elip.post.rem.sex.df <- data.frame()
for(i in levels(elip.nmds.post.rem.sex$Group)){
  elip.post.rem.sex.df <- rbind(elip.post.rem.sex.df, cbind(as.data.frame(with(elip.nmds.post.rem.sex[elip.nmds.post.rem.sex$Group==i,],
                                                     veganCovEllipse(elip.ord.post.rem.sex[[i]]$cov,
                                                                     elip.ord.post.rem.sex[[i]]$center,
                                                                     elip.ord.post.rem.sex[[i]]$scale))),
                                  group=i))
}

# Plot w/ sex ellip
plot_ordination(physeq=physeq.post.rem, ordination=bray.nmds.post.rem, color="Sex") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.post.rem.sex.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)



### All Female
bray.nmds.fem <- ordinate(physeq=physeq.fem, method="NMDS", distance="bray")
  # stress = 8.77398e-05

plot_ordination(physeq=physeq.fem, ordination=bray.nmds.fem, color="Treatment", shape="Time") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))



### All Male
bray.nmds.mal <- ordinate(physeq=physeq.mal, method="NMDS", distance="bray")
  # stress = 8.193224e-05 

plot_ordination(physeq=physeq.mal, ordination=bray.nmds.mal, color="Treatment", shape="Time") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))



### Pre Female
bray.nmds.pre.fem <- ordinate(physeq=physeq.pre.fem, method="NMDS", distance="bray")
  # stress = 0.1965918 

plot_ordination(physeq=physeq.pre.fem, ordination=bray.nmds.pre.fem, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))

# Treatment Ellipses
sample_data(physeq.pre.fem)$Elip.treat <- paste(sample_data(physeq.pre.fem)$Treatment)
elip.nmds.pre.fem.treat <- data.frame(MDS1 = bray.nmds.pre.fem$points[,1], MDS2 = bray.nmds.pre.fem$points[,2],
                        Group = sample_data(physeq.pre.fem)$Elip.treat)
plot.new()
elip.ord.pre.fem.treat <- ordiellipse(bray.nmds.pre.fem, sample_data(physeq.pre.fem)$Elip.treat, display="sites", kind="se", conf=0.95, label=T)
elip.pre.fem.treat.df <- data.frame()
for(i in levels(elip.nmds.pre.fem.treat$Group)){
  elip.pre.fem.treat.df <- rbind(elip.pre.fem.treat.df, cbind(as.data.frame(with(elip.nmds.pre.fem.treat[elip.nmds.pre.fem.treat$Group==i,],
                                                     veganCovEllipse(elip.ord.pre.fem.treat[[i]]$cov,
                                                                     elip.ord.pre.fem.treat[[i]]$center,
                                                                     elip.ord.pre.fem.treat[[i]]$scale))),
                                  group=i))
}

# Plot w/ treatment ellip
plot_ordination(physeq=physeq.pre.fem, ordination=bray.nmds.pre.fem, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.pre.fem.treat.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)



### Pre Male
bray.nmds.pre.mal <- ordinate(physeq=physeq.pre.mal, method="NMDS", distance="bray")
  # stress = 0.1949269 
  # NO CONVERGENCE!!!

plot_ordination(physeq=physeq.pre.mal, ordination=bray.nmds.pre.mal, color="Treatment") #+
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))

# Treatment Ellipses
sample_data(physeq.pre.mal)$Elip.treat <- paste(sample_data(physeq.pre.mal)$Treatment)
elip.nmds.pre.mal.treat <- data.frame(MDS1 = bray.nmds.pre.mal$points[,1], MDS2 = bray.nmds.pre.mal$points[,2],
                        Group = sample_data(physeq.pre.mal)$Elip.treat)
plot.new()
elip.ord.pre.mal.treat <- ordiellipse(bray.nmds.pre.mal, sample_data(physeq.pre.mal)$Elip.treat, display="sites", kind="se", conf=0.95, label=T)
elip.pre.mal.treat.df <- data.frame()
for(i in levels(elip.nmds.pre.mal.treat$Group)){
  elip.pre.mal.treat.df <- rbind(elip.pre.mal.treat.df, cbind(as.data.frame(with(elip.nmds.pre.mal.treat[elip.nmds.pre.mal.treat$Group==i,],
                                                     veganCovEllipse(elip.ord.pre.mal.treat[[i]]$cov,
                                                                     elip.ord.pre.mal.treat[[i]]$center,
                                                                     elip.ord.pre.mal.treat[[i]]$scale))),
                                  group=i))
}

# Plot w/ treatment ellip
plot_ordination(physeq=physeq.pre.mal, ordination=bray.nmds.pre.mal, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.pre.mal.treat.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)


### Post Female
bray.nmds.post.fem <- ordinate(physeq=physeq.post.fem, method="NMDS", distance="bray")
  # stress = 8.335943e-05

plot_ordination(physeq=physeq.post.fem, ordination=bray.nmds.post.fem, color="Treatment") #+
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))

# Treatment Ellipses
sample_data(physeq.post.fem)$Elip.treat <- paste(sample_data(physeq.post.fem)$Treatment)
elip.nmds.post.fem.treat <- data.frame(MDS1 = bray.nmds.post.fem$points[,1], MDS2 = bray.nmds.post.fem$points[,2],
                        Group = sample_data(physeq.post.fem)$Elip.treat)
plot.new()
elip.ord.post.fem.treat <- ordiellipse(bray.nmds.post.fem, sample_data(physeq.post.fem)$Elip.treat, display="sites", kind="se", conf=0.95, label=T)
elip.post.fem.treat.df <- data.frame()
for(i in levels(elip.nmds.post.fem.treat$Group)){
  elip.post.fem.treat.df <- rbind(elip.post.fem.treat.df, cbind(as.data.frame(with(elip.nmds.post.fem.treat[elip.nmds.post.fem.treat$Group==i,],
                                                     veganCovEllipse(elip.ord.post.fem.treat[[i]]$cov,
                                                                     elip.ord.post.fem.treat[[i]]$center,
                                                                     elip.ord.post.fem.treat[[i]]$scale))),
                                  group=i))
}

# Plot w/ treatment ellip
plot_ordination(physeq=physeq.post.fem, ordination=bray.nmds.post.fem, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.post.fem.treat.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)


### Post Male
bray.nmds.post.mal <- ordinate(physeq=physeq.post.mal, method="NMDS", distance="bray")
  # stress = 8.658975e-05 

plot_ordination(physeq=physeq.post.mal, ordination=bray.nmds.post.mal, color="Treatment") #+
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))

# Treatment Ellipses
sample_data(physeq.post.mal)$Elip.treat <- paste(sample_data(physeq.post.mal)$Treatment)
elip.nmds.post.mal.treat <- data.frame(MDS1 = bray.nmds.post.mal$points[,1], MDS2 = bray.nmds.post.mal$points[,2],
                        Group = sample_data(physeq.post.mal)$Elip.treat)
plot.new()
elip.ord.post.mal.treat <- ordiellipse(bray.nmds.post.mal, sample_data(physeq.post.mal)$Elip.treat, display="sites", kind="se", conf=0.95, label=T)
elip.post.mal.treat.df <- data.frame()
for(i in levels(elip.nmds.post.mal.treat$Group)){
  elip.post.mal.treat.df <- rbind(elip.post.mal.treat.df, cbind(as.data.frame(with(elip.nmds.post.mal.treat[elip.nmds.post.mal.treat$Group==i,],
                                                     veganCovEllipse(elip.ord.post.mal.treat[[i]]$cov,
                                                                     elip.ord.post.mal.treat[[i]]$center,
                                                                     elip.ord.post.mal.treat[[i]]$scale))),
                                  group=i))
}

# Plot w/ treatment ellip
plot_ordination(physeq=physeq.post.mal, ordination=bray.nmds.post.mal, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.post.mal.treat.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)



### Post Female w/o Low Fat
bray.nmds.post.fem.rem <- ordinate(physeq=physeq.post.fem.rem, method="NMDS", distance="bray")
  # stress = 0.169206 

plot_ordination(physeq=physeq.post.fem.rem, ordination=bray.nmds.post.fem.rem, color="Treatment") #+
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))

# Treatment Ellipses
sample_data(physeq.post.fem.rem)$Elip.treat <- paste(sample_data(physeq.post.fem.rem)$Treatment)
elip.nmds.post.fem.rem.treat <- data.frame(MDS1 = bray.nmds.post.fem.rem$points[,1], MDS2 = bray.nmds.post.fem.rem$points[,2],
                        Group = sample_data(physeq.post.fem.rem)$Elip.treat)
plot.new()
elip.ord.post.fem.rem.treat <- ordiellipse(bray.nmds.post.fem.rem, sample_data(physeq.post.fem.rem)$Elip.treat, display="sites", kind="se", conf=0.95, label=T)
elip.post.fem.rem.treat.df <- data.frame()
for(i in levels(elip.nmds.post.fem.rem.treat$Group)){
  elip.post.fem.rem.treat.df <- rbind(elip.post.fem.rem.treat.df, cbind(as.data.frame(with(elip.nmds.post.fem.rem.treat[elip.nmds.post.fem.rem.treat$Group==i,],
                                                     veganCovEllipse(elip.ord.post.fem.rem.treat[[i]]$cov,
                                                                     elip.ord.post.fem.rem.treat[[i]]$center,
                                                                     elip.ord.post.fem.rem.treat[[i]]$scale))),
                                  group=i))
}

# Plot w/ treatment ellip
plot_ordination(physeq=physeq.post.fem.rem, ordination=bray.nmds.post.fem.rem, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.post.fem.rem.treat.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)



### Post Male w/o Low Fat
bray.nmds.post.mal.rem <- ordinate(physeq=physeq.post.mal.rem, method="NMDS", distance="bray")
  # stress = 0.160679

plot_ordination(physeq=physeq.post.mal.rem, ordination=bray.nmds.post.mal.rem, color="Treatment") #+
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))

# Treatment Ellipses
sample_data(physeq.post.mal.rem)$Elip.treat <- paste(sample_data(physeq.post.mal.rem)$Treatment)
elip.nmds.post.mal.rem.treat <- data.frame(MDS1 = bray.nmds.post.mal.rem$points[,1], MDS2 = bray.nmds.post.mal.rem$points[,2],
                        Group = sample_data(physeq.post.mal.rem)$Elip.treat)
plot.new()
elip.ord.post.mal.rem.treat <- ordiellipse(bray.nmds.post.mal.rem, sample_data(physeq.post.mal.rem)$Elip.treat, display="sites", kind="se", conf=0.95, label=T)
elip.post.mal.rem.treat.df <- data.frame()
for(i in levels(elip.nmds.post.mal.rem.treat$Group)){
  elip.post.mal.rem.treat.df <- rbind(elip.post.mal.rem.treat.df, cbind(as.data.frame(with(elip.nmds.post.mal.rem.treat[elip.nmds.post.mal.rem.treat$Group==i,],
                                                     veganCovEllipse(elip.ord.post.mal.rem.treat[[i]]$cov,
                                                                     elip.ord.post.mal.rem.treat[[i]]$center,
                                                                     elip.ord.post.mal.rem.treat[[i]]$scale))),
                                  group=i))
}

# Plot w/ treatment ellip
plot_ordination(physeq=physeq.post.mal.rem, ordination=bray.nmds.post.mal.rem, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.post.mal.rem.treat.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)
```


### PERMANOVA Bray-Curtis
```{r}
### Paired
pair.sampdf <- data.frame(sample_data(physeq.pair))
pair.bray <- phyloseq::distance(physeq=physeq.pair, method="bray")

# Time
adonis(pair.bray ~ Time, data=pair.sampdf)
  # p-value = 0.001
  # R2 = 0.25838
beta.tax = betadisper(d=pair.bray, group=pair.sampdf$Time)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.522

# Treatment
adonis(pair.bray ~ Treatment, data=pair.sampdf)
  # p-value = 0.001
  # R2 = 0.12309
beta.tax = betadisper(d=pair.bray, group=pair.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.663

# Sex
adonis(pair.bray ~ Sex, data=pair.sampdf)
  # p-value = 0.001
  # R2 = 0.07431
beta.tax = betadisper(d=pair.bray, group=pair.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.338

# Subj_ID
adonis(pair.bray ~ Subj_ID, data=pair.sampdf)
  # p-value = 0.976
  # R2 = 0.42718
beta.tax = betadisper(d=pair.bray, group=pair.sampdf$Subj_ID)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001

# Combined Variables
adonis(pair.bray ~ Time + Treatment + Sex + Subj_ID,
       data=pair.sampdf)
  ### Subj_ID must be last because it's not sig
    # If first, adonis doesn't evaluate the remainder of the model because the first variable (Subj_ID) us bit sig
  # Time: p-value = 0.001; R2 = 0.25838
  # Treatment: p-value = 0.001; R2 = 0.12309
  # Sex: p-value = 0.001; R2 = 0.07370
  # Subj_ID: p-value = 0.907, R2 = 0.23038
  


### Pre-treatment
pre.sampdf <- data.frame(sample_data(physeq.pre))
pre.bray <- phyloseq::distance(physeq=physeq.pre, method="bray")

# Sex
adonis(pre.bray ~ Sex, data=pre.sampdf)
  # p-value = 0.001
  # R2 = 0.34423
beta.tax = betadisper(d=pre.bray, group=pre.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.042

# Treatment
adonis(pre.bray ~ Treatment, data=pre.sampdf)
  # p-value = 0.775
  # R2 = 0.06522
beta.tax = betadisper(d=pre.bray, group=pre.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.931

# Combined Variables
adonis(pre.bray ~ Sex + Treatment, data=pre.sampdf)
  # Sex: p-value = 0.001; R2 = 0.34423
  # Treatment: p-value = 0.340; R2 = 0.06231



### Post-treatment
post.sampdf <- data.frame(sample_data(physeq.post))
post.bray <- phyloseq::distance(physeq=physeq.post, method="bray")

# Sex
adonis(post.bray ~ Sex, data=post.sampdf)
  # p-value = 0.166
  # R2 = 0.04113
beta.tax = betadisper(d=post.bray, group=post.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.859

# Treatment
adonis(post.bray ~ Treatment, data=post.sampdf)
  # p-value = 0.001
  # R2 = 0.47417
beta.tax = betadisper(d=post.bray, group=post.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001

# Combined Variables
adonis(post.bray ~ Treatment + Sex, data=post.sampdf)
  # Treatment: p-value = 0.001; R2 = 0.47417
  # R2: p-value = 0.036; R2 = 0.04196



### Post-treatment w/o Low Fat
post.rem.sampdf <- data.frame(sample_data(physeq.post.rem))
post.rem.bray <- phyloseq::distance(physeq=physeq.post.rem, method="bray")

# Sex
adonis(post.rem.bray ~ Sex, data=post.rem.sampdf)
  # p-value = 0.003
  # R2 = 0.1325
beta.tax = betadisper(d=post.rem.bray, group=post.rem.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.345

# Treatment
adonis(post.rem.bray ~ Treatment, data=post.rem.sampdf)
  # p-value = 0.033
  # R2 = 0.12945
beta.tax = betadisper(d=post.rem.bray, group=post.rem.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.486

# Combined Variables
adonis(post.rem.bray ~ Sex + Treatment, data=post.rem.sampdf)
  # Sex: p-value = 0.002; R2 = 0.13250
  # Treatment: p-value = 0.010; R2 = 0.13259



### All Female
fem.sampdf <- data.frame(sample_data(physeq.fem))
fem.bray <- phyloseq::distance(physeq=physeq.fem, method="bray")

# Time
adonis(fem.bray ~ Time, data=fem.sampdf)
  # p-value = 0.001
  # R2 = 0.35979
beta.tax = betadisper(d=fem.bray, group=fem.sampdf$Time)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.03

# Treatment
adonis(fem.bray ~ Treatment, data=fem.sampdf)
  # p-value = 0.036
  # R2 = 0.16207
beta.tax = betadisper(d=fem.bray, group=fem.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.102

# Subj_ID
adonis(fem.bray ~ Subj_ID, data=fem.sampdf)
  # p-value = 0.977
  # R2 = 0.37156
beta.tax = betadisper(d=fem.bray, group=fem.sampdf$Subj_ID)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001

# Combined Variables
adonis(fem.bray ~ Time + Treatment + Subj_ID, data=fem.sampdf)
  # Time: p-value = 0.001; R2 = 0.35979
  # Treatment: p-value = 0.001; R2 = 0.16207
  # Subj_ID: p-value = 0.560; R2 = 0.20949



### All Male
mal.sampdf <- data.frame(sample_data(physeq.mal))
mal.bray <- phyloseq::distance(physeq=physeq.mal, method="bray")

# Time
adonis(mal.bray ~ Time, data=mal.sampdf)
  # p-value = 0.001
  # R2 = 0.32399
beta.tax = betadisper(d=mal.bray, group=mal.sampdf$Time)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.149

# Treatment
adonis(mal.bray ~ Treatment, data=mal.sampdf)
  # p-value = 0.021
  # R2 = 0.1503
beta.tax = betadisper(d=mal.bray, group=mal.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.761

# Subj_ID
adonis(mal.bray ~ Subj_ID, data=mal.sampdf)
  # p-value = 0.976
  # R2 = 0.39022
beta.tax = betadisper(d=mal.bray, group=mal.sampdf$Subj_ID)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001

# Combined Variables
adonis(mal.bray ~ Time + Treatment + Subj_ID, data=mal.sampdf)
  # Time: p-value = 0.001; R2 = 0.32399
  # Treatment: p-value = 0.001; R2 = 0.15030
  # Subj_ID: p-value = 0.442; R2 = 0.23992



### Female Pre-treatment
pre.fem.sampdf <- data.frame(sample_data(physeq.pre.fem))
pre.fem.bray <- phyloseq::distance(physeq=physeq.pre.fem, method="bray")

# Treatment
adonis(pre.fem.bray ~ Treatment, data=pre.fem.sampdf)
  # p-value = 0.565
  # R2 = 0.15532
beta.tax = betadisper(d=pre.fem.bray, group=pre.fem.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.456



### Male Pre-treatment
pre.mal.sampdf <- data.frame(sample_data(physeq.pre.mal))
pre.mal.bray <- phyloseq::distance(physeq=physeq.pre.mal, method="bray")

# Treatment
adonis(pre.mal.bray ~ Treatment, data=pre.mal.sampdf)
  # p-value = 0.241
  # R2 = 0.20338
beta.tax = betadisper(d=pre.mal.bray, group=pre.mal.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.886



### Female Post-treatment
post.fem.sampdf <- data.frame(sample_data(physeq.post.fem))
post.fem.bray <- phyloseq::distance(physeq=physeq.post.fem, method="bray")

# Treatment
adonis(post.fem.bray ~ Treatment, data=post.fem.sampdf)
  # p-value = 0.001
  # R2 = 0.60409
beta.tax = betadisper(d=post.fem.bray, group=post.fem.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.112



### Male Post-treatment
post.mal.sampdf <- data.frame(sample_data(physeq.post.mal))
post.mal.bray <- phyloseq::distance(physeq=physeq.post.mal, method="bray")

# Treatment
adonis(post.mal.bray ~ Treatment, data=post.mal.sampdf)
  # p-value = 0.001
  # R2 = 0.51171
beta.tax = betadisper(d=post.mal.bray, group=post.mal.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.004



### Female Post-treatment w/o Low Fat
post.fem.rem.sampdf <- data.frame(sample_data(physeq.post.fem.rem))
post.fem.rem.bray <- phyloseq::distance(physeq=physeq.post.fem.rem, method="bray")

# Treatment
adonis(post.fem.rem.bray ~ Treatment, data=post.fem.rem.sampdf)
  # p-value = 0.038
  # R2 = 0.27097
beta.tax = betadisper(d=post.fem.rem.bray, group=post.fem.rem.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.992



### Male Post-treatment w/o Low Fat
post.mal.rem.sampdf <- data.frame(sample_data(physeq.post.mal.rem))
post.mal.rem.bray <- phyloseq::distance(physeq=physeq.post.mal.rem, method="bray")

# Treatment
adonis(post.mal.rem.bray ~ Treatment, data=post.mal.rem.sampdf)
  # p-value = 0.263
  # R2 = 0.19267
beta.tax = betadisper(d=post.mal.rem.bray, group=post.mal.rem.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.696

### High Fat
hf.sampdf <- data.frame(sample_data(physeq.hf))
hf.bray <- phyloseq::distance(physeq=physeq.hf, method="bray")

# Time
adonis(hf.bray ~ Time, data=hf.sampdf)
  # p-value = 0.001
  # R2 = 0.48394
beta.tax = betadisper(d=hf.bray, group=hf.sampdf$Time)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.005

# Sex
adonis(hf.bray ~ Sex, data=hf.sampdf)
  # p-value = 0.188
  # R2 = 0.08379
beta.tax = betadisper(d=hf.bray, group=hf.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.595

# Subj_ID
adonis(hf.bray ~ Subj_ID, data=hf.sampdf)
  # p-value = 0.986
  # R2 = 0.28542
beta.tax = betadisper(d=hf.bray, group=hf.sampdf$Subj_ID)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001

# Combined
adonis(hf.bray ~ Time + Sex + Subj_ID, data=hf.sampdf)
  # Time: p-value = 0.001; R2 = 0.48394
  # Sex: p-value = 0.038; R2 = 0.08379
  # Subj_ID: p-value = 0.471; R2 = 0.20163



### Low Fat
lf.sampdf <- data.frame(sample_data(physeq.lf))
lf.bray <- phyloseq::distance(physeq=physeq.lf, method="bray")

# Time
adonis(lf.bray ~ Time, data=lf.sampdf)
  # p-value = 0.001
  # R2 = 0.20248
beta.tax = betadisper(d=lf.bray, group=lf.sampdf$Time)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.528

# Sex
adonis(lf.bray ~ Sex, data=lf.sampdf)
  # p-value = 0.001
  # R2 = 0.14304
beta.tax = betadisper(d=lf.bray, group=lf.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.169

# Subj_ID
adonis(lf.bray ~ Subj_ID, data=lf.sampdf)
  # p-value = 0.45
  # R2 = 0.46743
beta.tax = betadisper(d=lf.bray, group=lf.sampdf$Subj_ID)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001

# Combined
adonis(lf.bray ~ Time + Sex + Subj_ID, data=lf.sampdf)
  # Time: p-value = 0.001; R2 = 0.20248
  # Sex: p-value = 0.001; R2 = 0.14304
  # Subj_ID: p-value = 0.303; R2 = 0.32439



### Saccharin
sc.sampdf <- data.frame(sample_data(physeq.sc))
sc.bray <- phyloseq::distance(physeq=physeq.sc, method="bray")

# Time
adonis(sc.bray ~ Time, data=sc.sampdf)
  # p-value = 0.002
  # R2 = 0.43652
beta.tax = betadisper(d=sc.bray, group=sc.sampdf$Time)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.007

# Sex
adonis(sc.bray ~ Sex, data=sc.sampdf)
  # p-value = 0.149
  # R2 = 0.09876
beta.tax = betadisper(d=sc.bray, group=sc.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.815

# Subj_ID
adonis(sc.bray ~ Subj_ID, data=sc.sampdf)
  # p-value = 0.966
  # R2 = 0.33888
beta.tax = betadisper(d=sc.bray, group=sc.sampdf$Subj_ID)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001

# Combined
adonis(sc.bray ~ Time + Sex + Subj_ID, data=sc.sampdf)
  # Time: p-value = 0.001; R2 = 0.43652
  # Sex: p-value = 0.016; R2 = 0.09876
  # Subj_ID: p-value = 0.303; R2 = 0.24012



### Saccharin
tv.sampdf <- data.frame(sample_data(physeq.tv))
tv.bray <- phyloseq::distance(physeq=physeq.tv, method="bray")

# Time
adonis(tv.bray ~ Time, data=tv.sampdf)
  # p-value = 0.001
  # R2 = 0.48081
beta.tax = betadisper(d=tv.bray, group=tv.sampdf$Time)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001

# Sex
adonis(tv.bray ~ Sex, data=tv.sampdf)
  # p-value = 0.165
  # R2 = 0.11129
beta.tax = betadisper(d=tv.bray, group=tv.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.512

# Subj_ID
adonis(tv.bray ~ Subj_ID, data=tv.sampdf)
  # p-value = 0.985
  # R2 = 0.29089
beta.tax = betadisper(d=tv.bray, group=tv.sampdf$Subj_ID)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001

# Combined
adonis(tv.bray ~ Time + Sex + Subj_ID, data=tv.sampdf)
  # Time: p-value = 0.001; R2 = 0.48081
  # Sex: p-value = 0.017; R2 = 0.11129
  # Subj_ID: p-value = 0.580; R2 = 0.17960

combos <- combn(x=levels(pair.sampdf$Treatment), m=2)
bray.pvals.pre <- data.frame(rep(999,6))
for( i in 1:ncol(combos)){
  temp.physeq <- subset_samples(physeq.pre, Treatment %in% combos[,i])
  temp.sampdf <- data.frame(sample_data(temp.physeq))
  temp.bray <- phyloseq::distance(physeq=temp.physeq, method="bray")
  test <- adonis(temp.bray ~ Group, data=temp.sampdf)
  rownames(bray.pvals.pre)[i] <- paste(combos[1,i], combos[2,i])
  bray.pvals.pre[i,1]<- test[[1]]$`Pr(>F)`[1]
}
colnames(bray.pvals.pre) <- "pval"
bray.pvals.pre$Adj.bonf <- p.adjust(bray.pvals.pre$pval, method="bonferroni")
bray.pvals.pre$Adj.BH <- p.adjust(bray.pvals.pre$pval, method="BH")

bray.pvals.post <- data.frame(rep(999,6))
for( i in 1:ncol(combos)){
  temp.physeq <- subset_samples(physeq.post, Treatment %in% combos[,i])
  temp.sampdf <- data.frame(sample_data(temp.physeq))
  temp.bray <- phyloseq::distance(physeq=temp.physeq, method="bray")
  test <- adonis(temp.bray ~ Group, data=temp.sampdf)
  rownames(bray.pvals.post)[i] <- paste(combos[1,i], combos[2,i])
  bray.pvals.post[i,1]<- test[[1]]$`Pr(>F)`[1]
}
colnames(bray.pvals.post) <- "pval"
bray.pvals.post$Adj.bonf <- p.adjust(bray.pvals.post$pval, method="bonferroni")
bray.pvals.post$Adj.BH <- p.adjust(bray.pvals.post$pval, method="BH")

bray.pvals.pre.fem <- data.frame(rep(999,6))
for( i in 1:ncol(combos)){
  temp.physeq <- subset_samples(physeq.pre.fem, Treatment %in% combos[,i])
  temp.sampdf <- data.frame(sample_data(temp.physeq))
  temp.bray <- phyloseq::distance(physeq=temp.physeq, method="bray")
  test <- adonis(temp.bray ~ Group, data=temp.sampdf)
  rownames(bray.pvals.pre.fem)[i] <- paste(combos[1,i], combos[2,i])
  bray.pvals.pre.fem[i,1]<- test[[1]]$`Pr(>F)`[1]
}
colnames(bray.pvals.pre.fem) <- "pval"
bray.pvals.pre.fem$Adj.bonf <- p.adjust(bray.pvals.pre.fem$pval, method="bonferroni")
bray.pvals.pre.fem$Adj.BH <- p.adjust(bray.pvals.pre.fem$pval, method="BH")

bray.pvals.pre.mal <- data.frame(rep(999,6))
for( i in 1:ncol(combos)){
  temp.physeq <- subset_samples(physeq.pre.mal, Treatment %in% combos[,i])
  temp.sampdf <- data.frame(sample_data(temp.physeq))
  temp.bray <- phyloseq::distance(physeq=temp.physeq, method="bray")
  test <- adonis(temp.bray ~ Group, data=temp.sampdf)
  rownames(bray.pvals.pre.mal)[i] <- paste(combos[1,i], combos[2,i])
  bray.pvals.pre.mal[i,1]<- test[[1]]$`Pr(>F)`[1]
}
colnames(bray.pvals.pre.mal) <- "pval"
bray.pvals.pre.mal$Adj.bonf <- p.adjust(bray.pvals.pre.mal$pval, method="bonferroni")
bray.pvals.pre.mal$Adj.BH <- p.adjust(bray.pvals.pre.mal$pval, method="BH")

bray.pvals.post.fem <- data.frame(rep(999,6))
for( i in 1:ncol(combos)){
  temp.physeq <- subset_samples(physeq.post.fem, Treatment %in% combos[,i])
  temp.sampdf <- data.frame(sample_data(temp.physeq))
  temp.bray <- phyloseq::distance(physeq=temp.physeq, method="bray")
  test <- adonis(temp.bray ~ Group, data=temp.sampdf)
  rownames(bray.pvals.post.fem)[i] <- paste(combos[1,i], combos[2,i])
  bray.pvals.post.fem[i,1]<- test[[1]]$`Pr(>F)`[1]
}
colnames(bray.pvals.post.fem) <- "pval"
bray.pvals.post.fem$Adj.bonf <- p.adjust(bray.pvals.post.fem$pval, method="bonferroni")
bray.pvals.post.fem$Adj.BH <- p.adjust(bray.pvals.post.fem$pval, method="BH")

bray.pvals.post.mal <- data.frame(rep(999,6))
for( i in 1:ncol(combos)){
  temp.physeq <- subset_samples(physeq.post.mal, Treatment %in% combos[,i])
  temp.sampdf <- data.frame(sample_data(temp.physeq))
  temp.bray <- phyloseq::distance(physeq=temp.physeq, method="bray")
  test <- adonis(temp.bray ~ Group, data=temp.sampdf)
  rownames(bray.pvals.post.mal)[i] <- paste(combos[1,i], combos[2,i])
  bray.pvals.post.mal[i,1]<- test[[1]]$`Pr(>F)`[1]
}
colnames(bray.pvals.post.mal) <- "pval"
bray.pvals.post.mal$Adj.bonf <- p.adjust(bray.pvals.post.mal$pval, method="bonferroni")
bray.pvals.post.mal$Adj.BH <- p.adjust(bray.pvals.post.mal$pval, method="BH")




### Adjust P-vals
bray.pvals.all <- data.frame(bray.pvals.pre[,1])
bray.pvals.all[(nrow(bray.pvals.all)+1):(nrow(bray.pvals.all)+nrow(bray.pvals.post)),1] <- bray.pvals.post[,1]
bray.pvals.all[(nrow(bray.pvals.all)+1):(nrow(bray.pvals.all)+nrow(bray.pvals.pre.fem)),1] <- bray.pvals.pre.fem[,1]
bray.pvals.all[(nrow(bray.pvals.all)+1):(nrow(bray.pvals.all)+nrow(bray.pvals.pre.mal)),1] <- bray.pvals.pre.mal[,1]
bray.pvals.all[(nrow(bray.pvals.all)+1):(nrow(bray.pvals.all)+nrow(bray.pvals.post.fem)),1] <- bray.pvals.post.fem[,1]
bray.pvals.all[(nrow(bray.pvals.all)+1):(nrow(bray.pvals.all)+nrow(bray.pvals.post.mal)),1] <- bray.pvals.post.mal[,1]
bray.pvals.all[(nrow(bray.pvals.all)+1),1] <- adonis(hf.bray ~ Time, data=hf.sampdf)$aov.tab[1,6]
bray.pvals.all[(nrow(bray.pvals.all)+1),1] <- adonis(lf.bray ~ Time, data=lf.sampdf)$aov.tab[1,6]
bray.pvals.all[(nrow(bray.pvals.all)+1),1] <- adonis(sc.bray ~ Time, data=sc.sampdf)$aov.tab[1,6]
bray.pvals.all[(nrow(bray.pvals.all)+1),1] <- adonis(tv.bray ~ Time, data=tv.sampdf)$aov.tab[1,6]
colnames(bray.pvals.all) <- "pvals"
bray.pvals.all$BH <- p.adjust(bray.pvals.all$pval, method="BH")
bray.pvals.all$Group <- c(rep("Pre", 6), rep("Post", 6), rep("Pre Fem", 6), rep("Pre Mal", 6), rep("Post Fem", 6), rep("Post Mal", 6), "High Fat", "Low Fat", "Saccharin", "Stevia")
bray.pvals.all$Comp <- c(rownames(bray.pvals.pre), rownames(bray.pvals.post), rownames(bray.pvals.pre.fem), rownames(bray.pvals.pre.mal), rownames(bray.pvals.post.fem), rownames(bray.pvals.post.mal), rep("Time", 4))

write.table(bray.pvals.all, "PERMANOVA.pvals.csv", sep=",")
```










### Jaccard NMDS
```{r}
jac.nmds <- ordinate(physeq=physeq.pair, method="NMDS", distance="jaccard")
  # stress =  0.7.312101e-05

plot_ordination(physeq=physeq.pair, ordination=jac.nmds, color="Treatment", shape="Time") +
  scale_shape_manual(values=c(19,2))

### Pre-treatment
jac.nmds.pre <- ordinate(physeq=physeq.pre, method="NMDS", distance="jaccard")
  # stress = 0.2112659  
plot_ordination(physeq=physeq.pre, ordination=jac.nmds.pre, color="Treatment", shape="Sex") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))



### Post-treatment
jac.nmds.post <- ordinate(physeq=physeq.post, method="NMDS", distance="jaccard")
  # stress = 9.557318e-05

plot_ordination(physeq=physeq.post, ordination=jac.nmds.post, color="Treatment", shape="Sex") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))



### Post-treatment w/o Low Fat
jac.nmds.post.rem <- ordinate(physeq=physeq.post.rem, method="NMDS", distance="jaccard")
  # stress = 0.2031122

plot_ordination(physeq=physeq.post.rem, ordination=jac.nmds.post.rem, color="Treatment", shape="Sex") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))



### All Female
jac.nmds.fem <- ordinate(physeq=physeq.fem, method="NMDS", distance="jaccard")
  # stress = 9.966751e-05

plot_ordination(physeq=physeq.fem, ordination=jac.nmds.fem, color="Treatment", shape="Time") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))



### All Male
jac.nmds.mal <- ordinate(physeq=physeq.mal, method="NMDS", distance="jaccard")
  # stress = 9.978072e-05  

plot_ordination(physeq=physeq.mal, ordination=jac.nmds.mal, color="Treatment", shape="Time") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))



### Pre Female
jac.nmds.pre.fem <- ordinate(physeq=physeq.pre.fem, method="NMDS", distance="jaccard")
  # stress = 0.1698204  

plot_ordination(physeq=physeq.pre.fem, ordination=jac.nmds.pre.fem, color="Treatment") #+
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))



### Pre Male
jac.nmds.pre.mal <- ordinate(physeq=physeq.pre.mal, method="NMDS", distance="jaccard")
  # stress = 0.2057542 
  # NO CONVERGENCE!!!

plot_ordination(physeq=physeq.pre.mal, ordination=jac.nmds.pre.mal, color="Treatment") #+
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))



### Post Female
jac.nmds.post.fem <- ordinate(physeq=physeq.post.fem, method="NMDS", distance="jaccard")
  # stress = 9.245148e-05

plot_ordination(physeq=physeq.post.fem, ordination=jac.nmds.post.fem, color="Treatment") #+
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))



### Post Male
jac.nmds.post.mal <- ordinate(physeq=physeq.post.mal, method="NMDS", distance="jaccard")
  # stress = 8.7399e-05 

plot_ordination(physeq=physeq.post.mal, ordination=jac.nmds.post.mal, color="Treatment") #+
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))



### Post Female w/o Low Fat
jac.nmds.post.fem.rem <- ordinate(physeq=physeq.post.fem.rem, method="NMDS", distance="jaccard")
  # stress = 0.1711962 

plot_ordination(physeq=physeq.post.fem.rem, ordination=jac.nmds.post.fem.rem, color="Treatment") #+
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))



### Post Male w/o Low Fat
jac.nmds.post.mal.rem <- ordinate(physeq=physeq.post.mal.rem, method="NMDS", distance="jaccard")
  # stress = 0.1730168

plot_ordination(physeq=physeq.post.mal.rem, ordination=jac.nmds.post.mal.rem, color="Treatment") #+
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))


```
### PERMANOVA Jaccard
```{r}
### Paired
pair.sampdf <- data.frame(sample_data(physeq.pair))
pair.jac <- phyloseq::distance(physeq=physeq.pair, method="jaccard")

# Time
adonis(pair.jac ~ Time, data=pair.sampdf)
  # p-value = 0.001
  # R2 = 0.18735
beta.tax = betadisper(d=pair.jac, group=pair.sampdf$Time)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.656

# Treatment
adonis(pair.jac ~ Treatment, data=pair.sampdf)
  # p-value = 0.001
  # R2 = 0.09585
beta.tax = betadisper(d=pair.jac, group=pair.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.937

# Sex
adonis(pair.jac ~ Sex, data=pair.sampdf)
  # p-value = 0.001
  # R2 = 0.06316
beta.tax = betadisper(d=pair.jac, group=pair.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.213

# Combined Variables
adonis(pair.jac ~ Time + Treatment + Sex, data=pair.sampdf)
  # Time: p-value = 0.001; R2 = 0.18735
  # Treatment: p-value = 0.001; R2 = 0.09585
  # Sex: p-value = 0.001; R2 = 0.06274
  ### BRAY-CURTIS HAS LOWER RESIDUALS SO I'M GONNA GO WITH THAT SINCE THAT SUGGESTS BRAY-CURTIS EXPLAINS THE DATA VARIATION BETTER COMPARED TO JACCARD

### Pre-treatment
pre.sampdf <- data.frame(sample_data(physeq.pre))
pre.jac <- phyloseq::distance(physeq=physeq.pre, method="jaccard")

# Sex
adonis(pre.jac ~ Sex, data=pre.sampdf)
  # p-value = 0.001
  # R2 = 0.24963
beta.tax = betadisper(d=pre.jac, group=pre.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.031

# Treatment
adonis(pre.jac ~ Treatment, data=pre.sampdf)
  # p-value = 0.775
  # R2 = 0.07027
beta.tax = betadisper(d=pre.jac, group=pre.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.902

# Combined Variables
adonis(pre.jac ~ Sex + Treatment, data=pre.sampdf)
  # Sex: p-value = 0.001; R2 = 0.24963
  # Treatment: p-value = 0.404; R2 = 06814



### Post-treatment
post.sampdf <- data.frame(sample_data(physeq.post))
post.jac <- phyloseq::distance(physeq=physeq.post, method="jaccard")

# Sex
adonis(post.jac ~ Sex, data=post.sampdf)
  # p-value = 0.089
  # R2 = 0.04395
beta.tax = betadisper(d=post.jac, group=post.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.795

# Treatment
adonis(post.jac ~ Treatment, data=post.sampdf)
  # p-value = 0.001
  # R2 = 0.34337
beta.tax = betadisper(d=post.jac, group=post.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.002

# Combined Variables
adonis(post.jac ~ Treatment + Sex, data=post.sampdf)
  # Treatment: p-value = 0.001; R2 = 0.34337
  # Sex: p-value = 0.026; R2 = 0.034337



### Post-treatment w/o Low Fat
post.rem.sampdf <- data.frame(sample_data(physeq.post.rem))
post.rem.jac <- phyloseq::distance(physeq=physeq.post.rem, method="jaccard")

# Sex
adonis(post.rem.jac ~ Sex, data=post.rem.sampdf)
  # p-value = 0.001
  # R2 = 0.10644
beta.tax = betadisper(d=post.rem.jac, group=post.rem.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.328

# Treatment
adonis(post.rem.jac ~ Treatment, data=post.rem.sampdf)
  # p-value = 0.041
  # R2 = 0.11781
beta.tax = betadisper(d=post.rem.jac, group=post.rem.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.504

# Combined Variables
adonis(post.rem.jac ~ Sex + Treatment, data=post.rem.sampdf)
  # Sex: p-value = 0.002; R2 = 0.10644
  # Treatment: p-value = 0.019; R2 = 0.11990



### All Female
fem.sampdf <- data.frame(sample_data(physeq.fem))
fem.jac <- phyloseq::distance(physeq=physeq.fem, method="jaccard")

# Time
adonis(fem.jac ~ Time, data=fem.sampdf)
  # p-value = 0.001
  # R2 = 0.27459
beta.tax = betadisper(d=fem.jac, group=fem.sampdf$Time)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.041

# Treatment
adonis(fem.jac ~ Treatment, data=fem.sampdf)
  # p-value = 0.056
  # R2 = 0.13543
beta.tax = betadisper(d=fem.jac, group=fem.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.45

# Combined Variables
adonis(fem.jac ~ Time + Treatment, data=fem.sampdf)
  # Time: p-value = 0.001; R2 = 0.27459
  # Treatment: p-value = 0.003; R2 = 0.13543



### All Male
mal.sampdf <- data.frame(sample_data(physeq.mal))
mal.jac <- phyloseq::distance(physeq=physeq.mal, method="jaccard")

# Time
adonis(mal.jac ~ Time, data=mal.sampdf)
  # p-value = 0.001
  # R2 = 0.23823
beta.tax = betadisper(d=mal.jac, group=mal.sampdf$Time)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.192

# Treatment
adonis(mal.jac ~ Treatment, data=mal.sampdf)
  # p-value = 0.044
  # R2 = 0.12879
beta.tax = betadisper(d=mal.jac, group=mal.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.975

# Combined Variables
adonis(mal.jac ~ Time + Treatment, data=mal.sampdf)
  # Time: p-value = 0.001; R2 = 0.23823
  # Treatment: p-value = 0.003; R2 = 0.12879



### Female Pre-treatment
pre.fem.sampdf <- data.frame(sample_data(physeq.pre.fem))
pre.fem.jac <- phyloseq::distance(physeq=physeq.pre.fem, method="jaccard")

# Treatment
adonis(pre.fem.jac ~ Treatment, data=pre.fem.sampdf)
  # p-value = 0.644
  # R2 = 0.15839
beta.tax = betadisper(d=pre.fem.jac, group=pre.fem.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.437



### Male Pre-treatment
pre.mal.sampdf <- data.frame(sample_data(physeq.pre.mal))
pre.mal.jac <- phyloseq::distance(physeq=physeq.pre.mal, method="jaccard")

# Treatment
adonis(pre.mal.jac ~ Treatment, data=pre.mal.sampdf)
  # p-value = 0.195
  # R2 = 0.19802
beta.tax = betadisper(d=pre.mal.jac, group=pre.mal.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.892



### Female Post-treatment
post.fem.sampdf <- data.frame(sample_data(physeq.post.fem))
post.fem.jac <- phyloseq::distance(physeq=physeq.post.fem, method="jaccard")

# Treatment
adonis(post.fem.jac ~ Treatment, data=post.fem.sampdf)
  # p-value = 0.001
  # R2 = 0.47067
beta.tax = betadisper(d=post.fem.jac, group=post.fem.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.139



### Male Post-treatment
post.mal.sampdf <- data.frame(sample_data(physeq.post.mal))
post.mal.jac <- phyloseq::distance(physeq=physeq.post.mal, method="jaccard")

# Treatment
adonis(post.mal.jac ~ Treatment, data=post.mal.sampdf)
  # p-value = 0.001
  # R2 = 0.39657
beta.tax = betadisper(d=post.mal.jac, group=post.mal.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.007



### Female Post-treatment w/o Low Fat
post.fem.rem.sampdf <- data.frame(sample_data(physeq.post.fem.rem))
post.fem.rem.jac <- phyloseq::distance(physeq=physeq.post.fem.rem, method="jaccard")

# Treatment
adonis(post.fem.rem.jac ~ Treatment, data=post.fem.rem.sampdf)
  # p-value = 0.048
  # R2 = 0.24327
beta.tax = betadisper(d=post.fem.rem.jac, group=post.fem.rem.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.975



### Male Post-treatment w/o Low Fat
post.mal.rem.sampdf <- data.frame(sample_data(physeq.post.mal.rem))
post.mal.rem.jac <- phyloseq::distance(physeq=physeq.post.mal.rem, method="jaccard")

# Treatment
adonis(post.mal.rem.jac ~ Treatment, data=post.mal.rem.sampdf)
  # p-value = 0.229
  # R2 = 0.18663
beta.tax = betadisper(d=post.mal.rem.jac, group=post.mal.rem.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.751