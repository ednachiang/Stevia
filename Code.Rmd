---
title: "Code"
author: "Edna Chiang"
date: "July 17, 2018"
output: html_document
---
### Load Libraries
```{r}
library(ape)
library(dplyr)
library(ggplot2)
library(gplots)
library(phangorn)
library(tidyr)
library(vegan)
library(phyloseq)
library(grid)
library(pgirmess)
theme_set(theme_bw())
set.seed(1)
```



### Import Data
```{r}
# Link files
shared = "mothur_outputs/final.shared"
taxonomy = "mothur_outputs/final.taxonomy"


# Import mothur data
mothurdata = import_mothur(
  mothur_shared_file = shared,
  mothur_constaxonomy_file = taxonomy)

# Add OTU column in taxonomy table
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
                               row.names(tax_table(mothurdata)))

# Rename taxonomy table columns
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")

```

### Explore mothurdata object
```{r}
samp.sum <- data.frame(colSums(otu_table(mothurdata)))
colnames(samp.sum) <- "Sample_TotalSeqs"
samp.sum$sample <- row.names(samp.sum)
samp.sum <- arrange(samp.sum, Sample_TotalSeqs)

ggplot(samp.sum, aes(x=reorder(sample, Sample_TotalSeqs), y=Sample_TotalSeqs)) +
  ylab("Number of Sequences per Sample") +
  geom_bar(stat="identity", colour="black", fill="cornflowerblue") +
  xlab("Sample Name") +
  ggtitle("Total Number of Sequences per Sample") + 
  theme(axis.text.x = element_text(colour = "black", size=6, angle=45,hjust = 1,
                                   vjust = 1))

ggplot(data.frame(sum = sample_sums(mothurdata)), aes(sum)) + 
  geom_histogram(colour = "white", fill = "blue", bins=60) + 
  ggtitle("Sample read counts") + 
  xlab("total sequences")


# Min, Mean, Max of sample read counts
min(sample_sums(mothurdata))
mean(sample_sums(mothurdata))
median(sample_sums(mothurdata))
max(sample_sums(mothurdata))
```


### Create Phyloseq Object
```{r}
meta <- read.csv("metadata.csv")
colnames(meta)[1] <- "Sample_ID"
rownames(meta) <- meta$Sample
meta$Time <- ordered(meta$Time, levels=c("Pre-treatment", "Post-treatment"))
divsum <- read.table("mothur_outputs/final.summary", header=T)


# Add in diversity summaries
meta[,7:17] <- divsum[,3:12]

# Create intermin phyloseq object
physeq <- merge_phyloseq(mothurdata, sample_data(meta))

#save(physeq, file="Physeq.RData")

# Subset out paired samples
physeq.pair <- subset_samples(physeq, Sample_ID != "HF8C")
physeq.pair <- subset_samples(physeq.pair, Sample_ID != "SC4A")
physeq.pair <- subset_samples(physeq.pair, Sample_ID != "TV2A")
physeq.pair <- subset_samples(physeq.pair, Sample_ID != "TV8A")
#save(physeq.pair, file="Physeq.pair.RData")
```

### Load Phyloseq Object
```{r}
load("Physeq.RData")
load("Physeq.pair.RData")
```

### Alpha Div
```{r}
adiv <- data.frame(sample_data(physeq))
adiv.pair <- data.frame(sample_data(physeq.pair))

### Coverage
# Plot
ggplot(adiv.pair, aes(x=Treatment, y= coverage, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  xlab("Treatment") +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  ylab("Coverage")
# Test normality
hist(adiv.pair$coverage, breaks=10)
qqnorm(adiv.pair$coverage)
qqline(adiv.pair$coverage)
shapiro.test(adiv.pair$coverage)
  # p-value = 0.003709
  # Not normal


### Total OTUs
otu.tot <- data.frame(sample_names(physeq.pair))
# Pull out # of OTUs from all samples
otu.tot$Total_OTUs <- rep("NA", 72)
for(i in 1:72){
  otu.tot[i,2] <- length(which(otu_table(mothurdata)[,i] != 0))
}
adiv.pair$Total_OTUs <- otu.tot$Total_OTUs
adiv.pair$Total_OTUs <- as.numeric(adiv.pair$Total_OTUs)
adiv.pair.pre <- adiv.pair[which(adiv.pair$Time == "Pre-treatment"),]
adiv.pair.post <- adiv.pair[which(adiv.pair$Time == "Post-treatment"),]
# Plot
ggplot(adiv.pair, aes(x=Treatment, y=Total_OTUs, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  xlab("Treatment") +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  ylab("Total OTUs")
# Test normality
hist(adiv.pair$Total_OTUs, breaks=10)
qqnorm(adiv.pair$Total_OTUs)
qqline(adiv.pair$Total_OTUs)
shapiro.test(adiv.pair$Total_OTUs)
  # p-value = 0.002107
  # Not normal
# Stats
kruskal.test(formula = Total_OTUs ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # All Pre-treatment
  # p-value = 0.003924
kruskalmc(resp = Total_OTUs ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Significant:  
      # Low fat - saccharin
kruskal.test(formula = Total_OTUs ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # All Post-treatment
  # p-value = 0.009035
kruskalmc(resp = Total_OTUs ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Significant:
    # High Fat - Low Fat
#friedman.test(formula = Total_OTUs ~ Treatment | Time, data = adiv.pair)
wilcox.test(Total_OTUs ~ Time, data=adiv.pair, paired=T)
  # p-value = 0.5245
wilcox.test(Total_OTUs ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 0.6015
wilcox.test(Total_OTUs ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.1589


### Chao
# Plot
tiff("Chao.tiff", width=6.5, height=3, units="in", res=600)
ggplot(adiv.pair, aes(x=Treatment, y=chao, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  xlab("Treatment") +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  ylab("Chao Richness")
dev.off()
# Test normality
hist(adiv.pair$chao, breaks=10)
qqnorm(adiv.pair$chao)
qqline(adiv.pair$chao)
shapiro.test(adiv.pair$chao)
  # p-value = 5.717e-05
  # Not normal
# Stats
kruskal.test(formula = chao ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # All Pre-treatment
  # p-value = 0.4731
kruskal.test(formula = chao ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # All Post-treatment
  # p-value = 0.0003939
kruskalmc(resp = chao ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Significant:
    # High Fat - Low Fat
    # Low Fat - Saccharin
#friedman.test(formula = chao ~ Treatment | Time, data = adiv.pair)
wilcox.test(chao ~ Time, data=adiv.pair, paired=T)
  # p-value = 0.02096
wilcox.test(chao ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "High Fat"),], paired=T)
  # High Fat
  # p-value = 0.003906
wilcox.test(chao ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Low Fat"),], paired=T)
  # Low Fat
  # p-value = 0.4316
wilcox.test(chao ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Saccharin"),], paired=T)
  # Saccharin
  # p-value = 0.07422
wilcox.test(chao ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Stevia"),], paired=T)
  # p-value = 0.3125
wilcox.test(chao ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 1
wilcox.test(chao ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.8147


### Berger-Parker
# Plot
ggplot(adiv.pair, aes(x=Treatment, y=bergerparker, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  xlab("Treatment") +
  ylab("Berger-Parker")
# Test normality
hist(adiv.pair$bergerparker, breaks=10)
qqnorm(adiv.pair$bergerparker)
qqline(adiv.pair$bergerparker)
shapiro.test(adiv.pair$bergerparker)
  # p-value = 0.00269
  # Not normal
# Stats
kruskal.test(formula = bergerparker ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # All Pre-treatment
  # p-value = 0.1931
kruskal.test(formula = bergerparker ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # All Post-treatment
  # p-value = 0.2489
#friedman.test(formula = bergerparker ~ Treatment | Time, data = adiv.pair)
wilcox.test(bergerparker ~ Time, data=adiv.pair, paired=T)
  # p-value = 0.01098
wilcox.test(bergerparker ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "High Fat"),], paired=T)
  # High Fat
  # p-value = 0.07422
wilcox.test(bergerparker ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Low Fat"),], paired=T)
  # Low Fat
  # p-value = 0.1934
wilcox.test(bergerparker ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Saccharin"),], paired=T)
  # Saccharin
  # p-value = 0.8203
wilcox.test(bergerparker ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Stevia"),], paired=T)
  # p-value = 0.1484
wilcox.test(bergerparker ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 0.6279
wilcox.test(bergerparker ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.006402
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Female"),], paired=T)
  # Female High Fat Time
  # p-value = 0.375
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Male"),], paired=T)
  # Male High Fat Time
  # p-value = 0.3125
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Female"),], paired=T)
  # Female Low Fat Time
  # p-value = 0.1875
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Male"),], paired=T)
  # Male Low Fat Time
  # p-value = 0.8125
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Female"),], paired=T)
  # Female Saccharin Time
  # p-value = 0.125
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Male"),], paired=T)
  # Male Saccharin Time
  # p-value = 1
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Female"),], paired=T)
  # Female Stevia Time
  # p-value = 0.625
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Male"),], paired=T)
  # Male Stevia Time
  # p-value = 0.375


### Shannon
# Plot
ggplot(adiv.pair, aes(x=Treatment, y=shannon, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  xlab("Treatment") +
  ylab("Shannon Diversity")
# Test normality
hist(adiv.pair$shannon, breaks=10)
qqnorm(adiv.pair$shannon)
qqline(adiv.pair$shannon)
shapiro.test(adiv.pair$shannon)
  # p-value = 0.5704
  # Normal
# Stats
summary(aov(shannon ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),]))
  # Pre-treatment
  # P-value = 0.589
summary(aov(shannon ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),]))
  # Post-treatment
  # P-value = 0.043
TukeyHSD(aov(shannon ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),]))
  # Post-treamtent Significance:
    # Saccharin - Low Fat
t.test(shannon ~ Time, data = adiv.pair, paired=T)
  # p-value = 0.9899
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "High Fat"),], paired=T)
  # High Fat
  # p-value = 0.9751
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Low Fat"),], paired=T)
  # Low Fat
  # p-value = 0.03614
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Saccharin"),], paired=T)
  # Saccharin
  # p-value = 0.192
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Stevia"),], paired=T)
  # Stevia
  # p-value = 0.1537
t.test(shannon ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 0.6813
t.test(shannon ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.01769
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Female"),], paired=T)
  # Female High Fat Time
  # p-value = 0.4814
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Male"),], paired=T)
  # Male High Fat Time
  # p-value = 0.05131
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Female"),], paired=T)
  # Female Low Fat Time
  # p-value = 0.11
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Male"),], paired=T)
  # Male Low Fat Time
  # p-value = 0.2679
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Female"),], paired=T)
  # Female Saccharin Time
  # p-value = 0.1392
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Male"),], paired=T)
  # Male Saccharin Time
  # p-value = 0.2168
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Female"),], paired=T)
  # Female Stevia Time
  # p-value = 0.5392
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Male"),], paired=T)
  # Male Stevia Time
  # p-value = 0.05621

### Inverse Simpson
# Plot
tiff("InvSimp.tiff", width=6.5, height=3, units="in", res=600)
ggplot(adiv.pair, aes(x=Treatment, y= invsimpson, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  xlab("Treatment") +
  ylab("Inverse Simpson Weighted Diversity")
dev.off()
# Test normality
hist(adiv.pair$invsimpson, breaks=10)
qqnorm(adiv.pair$invsimpson)
qqline(adiv.pair$invsimpson)
shapiro.test(adiv.pair$invsimpson)
  # p-value = 0.2751
  # Normal
# Stats
summary(aov(invsimpson ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),]))
  # Pre-treatment
  # P-value = 0.323
summary(aov(invsimpson ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),]))
  # Post-treatment
t.test(invsimpson ~ Time, data = adiv.pair, paired=T)
  # p-value = 0.09364
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "High Fat"),], paired=T)
  # High Fat
  # p-value = 0.2415
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Low Fat"),], paired=T)
  # Low Fat
  # p-value = 0.0852
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Saccharin"),], paired=T)
  # Saccharin
  # p-value = 0.9167
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Stevia"),], paired=T)
  # Stevia
  # p-value = 0.7599
t.test(invsimpson ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 0.9731
t.test(invsimpson ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.001503
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Female"),], paired=T)
  # Female High Fat Time
  # p-value = 0.5901
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Male"),], paired=T)
  # Male High Fat Time
  # p-value = 0.1063
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Female"),], paired=T)
  # Female Low Fat Time
  # p-value = 0.1735
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Male"),], paired=T)
  # Male Low Fat Time
  # p-value = 0.3996
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Female"),], paired=T)
  # Female Saccharin Time
  # p-value = 0.1378
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Male"),], paired=T)
  # Male Saccharin Time
  # p-value = 0.4341
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Female"),], paired=T)
  # Female Stevia Time
  # p-value = 0.6195
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Male"),], paired=T)
  # Male Stevia Time
  # p-value = 0.0892

```


### Examine Phyla
```{r}
# Merge samples with the same taxonomic rank
goodphy <- tax_glom(physeq.pair, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99 <- transform_sample_counts(goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <0.1% rel abund
phy99 <- prune_taxa(taxa_sums(phy99) > 0.01, phy99)

# Create rank abundance of phyla
barplot(sort(taxa_sums(phy99),TRUE)[1:20]/nsamples(phy99),las=2,cex.axis=.7)


# Summarize data
phy.df <- psmelt(phy99)
phy.df$Phylum <- ordered(phy.df$Phylum, levels=c("Firmicutes", "Bacteroidetes", "Verrucomicrobia", "Tenericutes", "Proteobacteria", "Actinobacteria", "Unclassified", "Cyanobacteria"))
phy.df$Phylum[which(is.na(phy.df$Phylum))] <- rep("Unclassified",length(which(is.na(phy.df$Phylum))))
phy.sum <- phy.df %>%
  group_by(Treatment, Time, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))

# Calculate IQR limits
phy.sum$iqr.min <- phy.sum$Median - 0.5*phy.sum$iqr
phy.sum[which(phy.sum$iqr.min < 0),10] <- 0
  # Any IQR min < 0, change to 0 (otherwise error bar won't plot)
phy.sum$iqr.max <- phy.sum$Median + 0.5*phy.sum$iqr


### Barplot ###
tiff("phyla.facet.tiff", width = 13, height = 8, units = "in", res = 300)
ggplot(phy.sum, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  facet_grid(Time ~ Treatment) +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 0.01%") +
  scale_y_continuous(limits=c(0,80), expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        panel.spacing=unit(1, "lines"),
        axis.title = element_text(size=20),
        strip.text.x = element_text(size=14),
        strip.text.y = element_text(size=14),
        axis.text.y = element_text(size=12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size=12))
dev.off()


### Testing barplot for sex + treatment + time
test <- phy.df %>%
  group_by(Treatment, Time, Sex, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))
test$iqr.min <- test$Median - 0.5*test$iqr
test[which(test$iqr.min < 0),10] <- 0
  # Any IQR min < 0, change to 0 (otherwise error bar won't plot)
test$iqr.max <- test$Median + 0.5*test$iqr
ggplot(test, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  facet_grid(Time + Sex ~ Treatment) +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 0.01%") +
  scale_y_continuous(limits=c(0,80), expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        panel.spacing=unit(1, "lines"),
        axis.title = element_text(size=20),
        strip.text.x = element_text(size=14),
        strip.text.y = element_text(size=14),
        axis.text.y = element_text(size=12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size=12))
test <- phy.df %>%
  group_by(Time, Sex, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))
test$iqr.min <- test$Median - 0.5*test$iqr
test[which(test$iqr.min < 0),10] <- 0
  # Any IQR min < 0, change to 0 (otherwise error bar won't plot)
test$iqr.max <- test$Median + 0.5*test$iqr
ggplot(test, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  facet_grid(Time~ Sex) +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 0.01%") +
  scale_y_continuous(limits=c(0,80), expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        panel.spacing=unit(1, "lines"),
        axis.title = element_text(size=20),
        strip.text.x = element_text(size=14),
        strip.text.y = element_text(size=14),
        axis.text.y = element_text(size=12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size=12))
```
