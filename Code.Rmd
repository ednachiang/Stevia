---
title: "Code"
author: "Edna Chiang"
date: "July 17, 2018"
output: html_document
---
### Load Libraries
```{r}
library(dplyr)
library(ggplot2)
library(vegan)
library(phyloseq)
library(grid)
library(extrafont)
loadfonts(device="win")
windowsFonts(Times="Arial")
theme_set(theme_bw())
set.seed(1)
```

### Load Functions
```{r}
g_legend <- function(a.gplot){
   tmp <- ggplot_gtable(ggplot_build(a.gplot))
   leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
   legend <- tmp$grobs[[leg]]
   return(legend)}



veganCovEllipse <- function(cov, center = c(0, 0), scale = 1, npoints = 100) {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
}


# https://github.com/asteinberger9/seq_scripts
simper.pretty = function(x, metrics, interesting, perc_cutoff, low_cutoff, low_val, output_name){
  library(vegan)
  #handling otu tables for taxa levels
  save=list(0)
  if(grepl("Otu", colnames(x)[1])!=TRUE){
    #converts output from A.Neumann Taxonomy script
    save=list(58)
    x=as.data.frame(t(x))
    orig_names=colnames(x)
    new_names=list()
    l=1
    for(n in colnames(x)){
      ifelse((l<10), (colnames(x)[l]=c(paste0('Otu000',c(l)))), (colnames(x)[l]=c(paste0('Otu00',c(l))))) 
      new_names=append(new_names, colnames(x)[l])
      l=l+1
    }
    orig_names=as.data.frame(orig_names, row.names = as.character(new_names))
  }
  #running simper
  for(variables in interesting){
    test_1=with(metrics, simper(x, metrics[[variables]]))
    #parsing through simper output, saving desired info to table
    for(name in names(test_1)){
      testmx=matrix(ncol=length(interesting))
      testmx=cbind(test_1[[name]]$ord,test_1[[name]]$cusum)
      sorted=testmx[order(testmx[,1]),]
      sorted=cbind(sorted,test_1[[name]]$species)
      sorted=sorted[order(sorted[,2]),]
      t=matrix(sorted[sorted[,2]<=perc_cutoff,],ncol=3)
      i=nrow(t)
      #converting percents to percent of whole
      while(i>1){
        t[i,2]=as.character(as.numeric(t[i,2])-as.numeric(t[i-1,2]))
        i=i-1
      }
      t[,1]=name
      write.table(t,file=paste(output_name,'_simper.csv',sep=""), append=TRUE, sep=",", col.names = FALSE)
    }}
  y=read.table(paste(output_name,'_simper.csv',sep=""), header=FALSE,sep=",",fill = TRUE,row.names = NULL)
  file.remove(paste(output_name,'_simper.csv',sep = ""))
  y=y[-c(1)]
  colnames(y) = c("Comparison", "SIMPER", "OTU")
  #removing results lower than low cutoff
  if(low_cutoff=='y'){
    y=y[!(as.numeric(as.character(y$SIMPER))<low_val),]
  }
  #prevents changing of colnames if OTU table
  if(58 %in% save){
    y$OTU=orig_names[match(y$OTU, rownames(orig_names)),1]
  }
  write.csv(y,file=paste(output_name,'_clean_simper.csv', sep=''))
}


# https://github.com/asteinberger9/seq_scripts
kruskal.pretty = function(otu, metrics, csv, interesting, output_name, taxonomy){
  library(vegan)
  library(dplyr)
  if(grepl("Otu", colnames(otu)[1])!=TRUE){
    #converts output from A.Neuman Taxonomy script
    otu=as.data.frame(t(otu))
  }
  #changing csv$X to rownames to allow proper splitting of comparisons
  csv$X=as.integer(rownames(csv))
  L=list()
  R=list()
  mean_L=c()
  sd_L=c()
  mean_R=c()
  sd_R=c()
  L_mean=c()
  R_mean=c()
  L_sd=c()
  R_sd=c()
  krusk=c()
  tax=c()
  L_abund=c()
  R_abund=c()
  L_abund_sd=c()
  R_abund_sd=c()
  abund=as.matrix(otu)
  abund=abund/rowSums(abund)
  for(b in levels(csv$Comparison)){
    otu_list=dplyr::filter(csv, Comparison==b) #saves otu list for current comparison
    for(i in csv$X){
      if(as.character(csv$Comparison[i])==b){  ##splitting comparisons so can call individually for table generation
        splt=as.data.frame(matrix(unlist(strsplit(as.character(csv$Comparison[i]),'_')), nrow=1, byrow=T))
        cola=as.character(splt[1,1])
        colb=as.character(splt[1,2])
        break
      }
    }
    #saving topic containing var of interest (cola/colb) (less memory intensive)
    for(topic in interesting){
      #preventing crash if there is only one topic in interesting
      if(is.null(levels(metrics[[topic]]))==TRUE){
        topic1=topic
        break
      }
      for(sbtpic in levels(metrics[[topic]])){
        if(sbtpic==cola){
          topic1=topic
          break
        }
      } 
    }
    #iterate thru rows in tpics of intrst til matches cola and colb, generates otu and metrics tbl  ##!Processing can be reduced!##
    for(rowe1 in metrics[[topic1]]){
      for(rowe2 in metrics[[topic1]]){ 
        if(rowe1==cola & rowe2==colb){ 
          listbact=otu[c(metrics[[topic1]]==cola|metrics[[topic1]]==colb),]
          listmet=metrics[c(metrics[[topic1]]==cola|metrics[[topic1]]==colb),]
          break
        }
      }
    }
    #collecting differential abundances
    sample_L=row.names(subset(metrics, metrics[[topic1]] == c(cola)))
    sample_R=row.names(subset(metrics, metrics[[topic1]] == c(colb)))
    #collecting abund values, perform/save mean and stdev calculations
    for(otus in otu_list$OTU){
      for(sample in sample_L){
        L=append(L,abund[sample,otus])
        mean_L[[otus]]=mean(as.numeric(L))
        sd_L[[otus]]=sd(as.numeric(L))
      }
      for(sample in sample_R){
        R=append(R,abund[sample,otus])
        mean_R[[otus]]=mean(as.numeric(R))
        sd_R[[otus]]=sd(as.numeric(R))
      }
      L=list()
      R=list()
    }
    #runs kruskal.test for each otu in simper csv, stores as list, also stores abundances
    for(otus in otu_list$OTU){
      result=kruskal.test(listbact[[otus]]~listmet[[topic1]])
      krusk=append(krusk, result$p.value)
      #stores taxonomic classification for each otu as list
      if(missing(taxonomy)){
        tax=append(tax, c("NA"))
      } else {
        tax=append(tax, as.character(taxonomy[otus, "Taxonomy"]))
      }
      L_mean=append(L_mean, as.character(mean_L[[otus]]))
      R_mean=append(R_mean, as.character(mean_R[[otus]]))
      L_sd=append(L_sd, as.character(sd_L[[otus]]))
      R_sd=append(R_sd, as.character(sd_R[[otus]]))
      
    }
  }
  #adjusted p-values for multiple comparisons
  fdr=p.adjust(krusk, method='fdr')
  #order csv to match 'krusk'/'fdr' list, add p.val, add taxonomy, re-ord to match orig csv, write to csv
  o_csv=dplyr::arrange(csv, Comparison)
  o_csv[,5]=krusk
  o_csv[,6]=fdr
  o_csv[,7]=tax
  o_csv[,8]=L_mean
  o_csv[,9]=L_sd
  o_csv[,10]=R_mean
  o_csv[,11]=R_sd
  o_csv=dplyr::arrange(o_csv, X)
  colnames(o_csv)[which(names(o_csv) == "V5")] <- "krusk_p.val" #changes column header
  colnames(o_csv)[which(names(o_csv) == "V6")] <- "fdr_krusk_p.val"
  colnames(o_csv)[which(names(o_csv) == "V7")] <- "Taxonomy"
  colnames(o_csv)[which(names(o_csv) == "V8")] <- "Left mean abund"
  colnames(o_csv)[which(names(o_csv) == "V9")] <- "Left stdev"
  colnames(o_csv)[which(names(o_csv) == "V10")] <- "Right mean abund"
  colnames(o_csv)[which(names(o_csv) == "V11")] <- "Right stdev"
  o_csv[,1]=NULL
  write.csv(o_csv, file=paste(output_name,"_krusk_simper.csv", sep=""))
}


```

### Import Data
```{r}
# Link files
shared = "mothur_outputs/final.shared"
taxonomy = "mothur_outputs/final.taxonomy"


# Import mothur data
mothurdata = import_mothur(
  mothur_shared_file = shared,
  mothur_constaxonomy_file = taxonomy)

# Add OTU column in taxonomy table
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
                               row.names(tax_table(mothurdata)))

# Rename taxonomy table columns
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")

```

### Explore mothurdata object
```{r}
samp.sum <- data.frame(colSums(otu_table(mothurdata)))
colnames(samp.sum) <- "Sample_TotalSeqs"
samp.sum$sample <- row.names(samp.sum)
samp.sum <- arrange(samp.sum, Sample_TotalSeqs)

ggplot(samp.sum, aes(x=reorder(sample, Sample_TotalSeqs), y=Sample_TotalSeqs)) +
  ylab("Number of Sequences per Sample") +
  geom_bar(stat="identity", colour="black", fill="cornflowerblue") +
  xlab("Sample Name") +
  ggtitle("Total Number of Sequences per Sample") + 
  theme(axis.text.x = element_text(colour = "black", size=6, angle=45,hjust = 1,
                                   vjust = 1))

ggplot(data.frame(sum = sample_sums(mothurdata)), aes(sum)) + 
  geom_histogram(colour = "white", fill = "blue", bins=60) + 
  ggtitle("Sample read counts") + 
  xlab("total sequences")


# Min, Mean, Max of sample read counts
min(sample_sums(mothurdata))
mean(sample_sums(mothurdata))
median(sample_sums(mothurdata))
max(sample_sums(mothurdata))
```


### Create Phyloseq Object
```{r}
meta <- read.csv("metadata.csv")
colnames(meta)[1] <- "Sample_ID"
rownames(meta) <- meta$Sample
meta$Time <- ordered(meta$Time, levels=c("Pre-treatment", "Post-treatment"))
meta$Treatment <- ordered(meta$Treatment, levels=c("Low Fat", "High Fat", "Saccharin", "Stevia"))
meta$Diet <- ordered(meta$Diet, levels=c("Low Fat", "High Fat"))
divsum <- read.table("mothur_outputs/final.summary", header=T)


# Add in diversity summaries
meta[,10:20] <- divsum[,3:12]

# Create intermin phyloseq object
physeq <- merge_phyloseq(mothurdata, sample_data(meta))
#save(physeq, file="Physeq.RData")

# Subset out paired samples
physeq.pair <- subset_samples(physeq, Sample_ID != "HF8C")
physeq.pair <- subset_samples(physeq.pair, Sample_ID != "SC4A")
physeq.pair <- subset_samples(physeq.pair, Sample_ID != "TV2A")
physeq.pair <- subset_samples(physeq.pair, Sample_ID != "TV8A")
#save(physeq.pair, file="Physeq.pair.RData")

# Subset out Pre vs. Post
physeq.pre <- subset_samples(physeq.pair, Time == "Pre-treatment")
#save(physeq.pre, file="Physeq.pre.RData")
physeq.post <- subset_samples(physeq.pair, Time == "Post-treatment")
#save(physeq.post, file="Physeq.post.RData")

# Subset Post w/o Low Fat (due to skewing)
physeq.post.rem <- subset_samples(physeq.post, Treatment != "Low Fat")
#save(physeq.post.rem, file="Physeq.post.rem.RData")

# Subset out Female vs. Male
physeq.fem <- subset_samples(physeq.pair, Sex == "Female")
#save(physeq.fem, file="Physeq.fem.RData")
physeq.mal <- subset_samples(physeq.pair, Sex == "Male")
#save(physeq.mal, file="Physeq.mal.RData")

# Subset out Sex + Time
physeq.pre.fem <- subset_samples(physeq.pre, Sex == "Female")
#save(physeq.pre.fem, file="Physeq.pre.fem.RData")
physeq.pre.mal <- subset_samples(physeq.pre, Sex == "Male")
#save(physeq.pre.mal, file="Physeq.pre.mal.RData")
physeq.post.fem <- subset_samples(physeq.post, Sex == "Female")
#save(physeq.post.fem, file="Physeq.post.fem.RData")
physeq.post.mal <- subset_samples(physeq.post, Sex == "Male")
#save(physeq.post.mal, file="Physeq.post.mal.RData")

# Remove Low Fat from Sex + Post subsets
physeq.post.fem.rem <- subset_samples(physeq.post.fem, Treatment != "Low Fat")
#save(physeq.post.fem.rem, file="Physeq.post.fem.rem.RData")
physeq.post.mal.rem <- subset_samples(physeq.post.mal, Treatment != "Low Fat")
#save(physeq.post.mal.rem, file="Physeq.post.mal.rem.RData")

# Subset out treatments
physeq.lf <- subset_samples(physeq.pair, Treatment == "Low Fat")
#save(physeq.lf, file = "Physeq.lf.RData")
physeq.hf <- subset_samples(physeq.pair, Treatment == "High Fat")
#save(physeq.hf, file = "Physeq.hf.RData")
physeq.sc <- subset_samples(physeq.pair, Treatment == "Saccharin")
#save(physeq.sc, file = "Physeq.sc.RData")
physeq.tv <- subset_samples(physeq.pair, Treatment == "Stevia")
#save(physeq.tv, file = "Physeq.tv.RData")

# Subset out Post-treatment treatments
physeq.lf.post <- subset_samples(physeq.lf, Time == "Post-treatment")
#save(physeq.lf.post, file = "Physeq.lf.post.RData")
physeq.hf.post <- subset_samples(physeq.hf, Time == "Post-treatment")
#save(physeq.hf.post, file = "Physeq.hf.post.RData")
physeq.sc.post <- subset_samples(physeq.sc, Time == "Post-treatment")
#save(physeq.sc.post, file = "Physeq.sc.post.RData")
physeq.tv.post <- subset_samples(physeq.tv, Time == "Post-treatment")
#save(physeq.tv.post, file = "Physeq.tv.post.RData")

# Subset out treatment by sex
physeq.lf.fem <- subset_samples(physeq.lf, Sex == "Female")
#save(physeq.lf.fem, file = "Physeq.lf.fem.RData")
physeq.lf.mal <- subset_samples(physeq.lf, Sex == "Male")
#save(physeq.lf.mal, file = "Physeq.lf.mal.RData")
physeq.hf.fem <- subset_samples(physeq.hf, Sex == "Female")
#save(physeq.hf.fem, file = "Physeq.hf.fem.RData")
physeq.hf.mal <- subset_samples(physeq.hf, Sex == "Male")
#save(physeq.hf.mal, file = "Physeq.hf.mal.RData")
physeq.sc.fem <- subset_samples(physeq.sc, Sex == "Female")
#save(physeq.sc.fem, file = "Physeq.sc.fem.RData")
physeq.sc.mal <- subset_samples(physeq.sc, Sex == "Male")
#save(physeq.sc.mal, file = "Physeq.sc.mal.RData")
physeq.tv.fem <- subset_samples(physeq.tv, Sex == "Female")
#save(physeq.tv.fem, file = "Physeq.tv.fem.RData")
physeq.tv.mal <- subset_samples(physeq.tv, Sex == "Male")
#save(physeq.tv.mal, file = "Physeq.tv.mal.RData")
```

### Load Phyloseq Objects
```{r}
load("physeq/Physeq.RData")
load("physeq/Physeq.pair.RData")
load("physeq/Physeq.pre.RData")
load("physeq/Physeq.post.RData")
load("physeq/Physeq.post.rem.RData")
load("physeq/Physeq.fem.RData")
load("physeq/Physeq.mal.RData")
load("physeq/Physeq.pre.fem.RData")
load("physeq/Physeq.pre.mal.RData")
load("physeq/Physeq.post.fem.RData")
load("physeq/Physeq.post.mal.RData")
#load("physeq/Physeq.post.fem.rem.RData")
#load("physeq/Physeq.post.mal.rem.RData")
load("physeq/Physeq.lf.RData")
load("physeq/Physeq.hf.RData")
load("physeq/Physeq.sc.RData")
load("physeq/Physeq.tv.RData")
load("physeq/Physeq.lf.post.RData")
load("physeq/Physeq.hf.post.RData")
load("physeq/Physeq.sc.post.RData")
load("physeq/Physeq.tv.post.RData")
load("physeq/Physeq.lf.fem.RData")
load("physeq/Physeq.lf.mal.RData")
load("physeq/Physeq.hf.fem.RData")
load("physeq/Physeq.hf.mal.RData")
load("physeq/Physeq.sc.fem.RData")
load("physeq/Physeq.sc.mal.RData")
load("physeq/Physeq.tv.fem.RData")
load("physeq/Physeq.tv.mal.RData")
```

### Alpha Div
```{r}
adiv.pair <- data.frame(sample_data(physeq.pair))

### Chao
# Plot
chao.ann <- data.frame(lab=c("ns","a", "b", "b", "b"), Time = factor(c("Pre-treatment", "Post-treatment", "Post-treatment", "Post-treatment", "Post-treatment")), Treatment = factor(c("Low Fat", "Low Fat", "High Fat", "Saccharin", "Stevia")))
  # Annotations
tiff("Chao.tiff", width=180, height=55, units="mm", res=600)
#chao.plot <-
ggplot(adiv.pair, aes(x=Treatment, y=chao, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point(position = position_dodge(width = 0.2)) + 
  facet_grid(.~Time) +
  xlab("Treatment") + 
  scale_fill_manual(values=c("#F0AC5F", "#FF0000", "#92D050", "#3565FF")) +
  ylab("Chao Richness") +
  scale_y_continuous(breaks = c(50, 100, 150, 200, 250, 300, 350), limits = c(50,350)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(family="Arial", size=10),
        axis.text.y = element_text(family="Arial", size=10),
        axis.title.x = element_text(family="Arial", size=10, face="bold"),
        axis.title.y = element_text(family="Arial", size=10, face="bold"),
        legend.title = element_text(family="Arial", size=10, face="bold"),
        legend.text = element_text(family="Arial", size=10),
        plot.title = element_text(family = "Arial", size=10, face="bold"),
        strip.text.x = element_text(family="Arial", size=10)
        ) +
  geom_text(data = chao.ann, aes(label=lab), x=c(2.5,1,2,3,4), y=c(348,348,348,348,348), 
            size=4, color="black", family="Arial")
dev.off()


# Test normality
hist(adiv.pair$chao, breaks=10)
qqnorm(adiv.pair$chao)
qqline(adiv.pair$chao)
shapiro.test(adiv.pair$chao)
  # p-value = 5.717e-05
  # Not normal
# Stats
kruskal.test(formula = chao ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # All Pre-treatment
  # p-value = 0.4731
kruskal.test(formula = chao ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # All Post-treatment
  # p-value = 0.0003939
pairwise.wilcox.test(adiv.pair$chao, adiv.pair$Treatment, p.adjust.method = "fdr")
  # LowFat - HighFat = 0.014
    # Low Fat > High Fat = 0.007
  # Saccharin - HighFat = 0.865
  # Saccharin - LowFat = 0.007
    # Low Fat > Saccharin = 0.0035
  # Stevia - HighFat = 0.986
  # Stevia - LowFat = 0.018
    # Low Fat > Stevia = 0.009
  # Stevia - Saccharin = 0.865
  ## Low fat vs. high fat = sig diff
wilcox.test(chao ~ Diet, data=adiv.pair, alternative = "greater")
  # p-value = 0.003649
  # Low Fat > High Fat
wilcox.test(chao ~ Time, data=adiv.pair, paired=T)
  # p-value = 0.02096
wilcox.test(chao ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "High Fat"),], paired=T)
  # High Fat
  # p-value = 0.003906
wilcox.test(chao ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Low Fat"),], paired=T)
  # Low Fat
  # p-value = 0.4316
wilcox.test(chao ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Saccharin"),], paired=T)
  # Saccharin
  # p-value = 0.07422
wilcox.test(chao ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Stevia"),], paired=T)
  # Stevia
  # p-value = 0.3125
p.adjust(c(0.003906, 0.4316, 0.07422,0.3125), method="BH")
  # 0.0156240 0.4316000 0.1484400 0.4166667
#wilcox.test(chao ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 1
#wilcox.test(chao ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.8147
# Repeated Measures
#summary(lmer(chao ~ Time + Treatment + Sex + (1|Subj_ID), data=adiv.pair))
  # Variance explained by Subj_ID = 1.376e-13


### Shannon
# Plot
shannon.plot <- ggplot(adiv.pair, aes(x=Treatment, y=shannon, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point(position = position_dodge(width = 0.2)) + 
  facet_grid(.~Time) +
  scale_fill_manual(values=c("#F0AC5F", "#FF0000", "#92D050", "#3565FF")) +
  xlab("Treatment") +
  ylab("Shannon Diversity") +
  scale_y_continuous(breaks=c(2.75, 3.00, 3.25, 3.50, 3.75), limits= c(2.75, 3.75)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(family="Arial", size=10),
        axis.text.y = element_text(family="Arial", size=10),
        axis.title.x = element_text(family="Arial", size=10, face="bold"),
        axis.title.y = element_text(family="Arial", size=10, face="bold"),
        legend.title = element_text(family="Arial", size=10, face="bold"),
        legend.text = element_text(family="Arial", size=10),
        plot.title = element_text(family = "Arial", size=10, face="bold"),
        strip.text.x = element_text(family="Arial", size=10)
        )
# Test normality
hist(adiv.pair$shannon, breaks=10)
qqnorm(adiv.pair$shannon)
qqline(adiv.pair$shannon)
shapiro.test(adiv.pair$shannon)
  # p-value = 0.5704
  # Normal
# Stats
summary(aov(shannon ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),]))
  # Pre-treatment
  # P-value = 0.589
summary(aov(shannon ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),]))
  # Post-treatment
  # P-value = 0.043
TukeyHSD(aov(shannon ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),]))
  # Post-treatment Significance:
    # Saccharin - Low Fat
t.test(shannon ~ Time, data = adiv.pair, paired=T)
  # p-value = 0.9899
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "High Fat"),], paired=T)
  # High Fat
  # p-value = 0.9751
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Low Fat"),], paired=T)
  # Low Fat
  # p-value = 0.03614
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Saccharin"),], paired=T)
  # Saccharin
  # p-value = 0.192
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Stevia"),], paired=T)
  # Stevia
  # p-value = 0.1537
t.test(shannon ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 0.6813
t.test(shannon ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.01769
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Female"),], paired=T)
  # Female High Fat Time
  # p-value = 0.4814
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Male"),], paired=T)
  # Male High Fat Time
  # p-value = 0.05131
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Female"),], paired=T)
  # Female Low Fat Time
  # p-value = 0.11
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Male"),], paired=T)
  # Male Low Fat Time
  # p-value = 0.2679
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Female"),], paired=T)
  # Female Saccharin Time
  # p-value = 0.1392
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Male"),], paired=T)
  # Male Saccharin Time
  # p-value = 0.2168
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Female"),], paired=T)
  # Female Stevia Time
  # p-value = 0.5392
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Male"),], paired=T)
  # Male Stevia Time
  # p-value = 0.05621
# Repeated Measure
summary(lmer(shannon ~ Time + Treatment + Sex + (1|Subj_ID), data=adiv.pair))
  # Variance explained by Subj_ID = 0

```


### Examine Phyla
```{r}
# Merge samples with the same taxonomic rank
goodphy <- tax_glom(physeq.pair, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99 <- transform_sample_counts(goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <0.1% average rel abund
phy99 <- prune_taxa(((taxa_sums(phy99)) / nsamples(phy99)) > 0.1, phy99)

# Create rank abundance of phyla
barplot(sort(taxa_sums(phy99),TRUE)[1:20]/nsamples(phy99),las=2,cex.axis=.7)


# Summarize data
phy.df <- psmelt(phy99)
phy.df$Phylum <- ordered(phy.df$Phylum, levels=c("Firmicutes", "Bacteroidetes", "Verrucomicrobia", "Tenericutes", "Proteobacteria", "Actinobacteria"))
phy.df$Phylum[which(is.na(phy.df$Phylum))] <- rep("Unclassified",length(which(is.na(phy.df$Phylum))))
phy.all.sum <- phy.df %>%
  group_by(Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))

### Boxplot
phy.ann <- data.frame(lab=c("ns", "ns", "*", "*",
                            "*", "*", "*", "*",
                            "*", "*", "*", "ns",
                            "+", "*", "*", "*",
                            "*", "*", "*", "*",
                            "ns", "*", "*", "*"),
                      Phylum = factor(c("Firmicutes", "Firmicutes", "Firmicutes", "Firmicutes",
                                        "Bacteroidetes", "Bacteroidetes", "Bacteroidetes",
                                        "Bacteroidetes", "Verrucomicrobia", "Verrucomicrobia",
                                        "Verrucomicrobia", "Verrucomicrobia", "Tenericutes",
                                        "Tenericutes", "Tenericutes", "Tenericutes", "Proteobacteria",
                                        "Proteobacteria", "Proteobacteria", "Proteobacteria",
                                        "Actinobacteria",
                                        "Actinobacteria","Actinobacteria","Actinobacteria")),
                      Treatment = factor(c("Low Fat", "High Fat", "Saccharin", "Stevia", "Low Fat",
                                         "High Fat", "Saccharin", "Stevia", "Low Fat", "High Fat",
                                         "Saccharin", "Stevia", "Low Fat", "High Fat", "Saccharin",
                                         "Stevia", "Low Fat", "High Fat", "Saccharin", "Stevia",
                                         "Low Fat", "High Fat", "Saccharin", "Stevia")),
                      Time = factor(c("Pre-treatment", "Pre-treatment", "Pre-treatment", "Pre-treatment",
                                      "Pre-treatment", "Pre-treatment", "Pre-treatment", "Pre-treatment",
                                      "Pre-treatment", "Pre-treatment", "Pre-treatment", "Pre-treatment",
                                      "Pre-treatment", "Pre-treatment", "Pre-treatment", "Pre-treatment",
                                      "Pre-treatment", "Pre-treatment", "Pre-treatment", "Pre-treatment",
                                      "Pre-treatment", "Pre-treatment", "Pre-treatment", "Pre-treatment")))
                      
tiff("phyla.box.tiff", width = 228, height = 280, units = "mm", res = 600)
ggplot(phy.df, aes(x=Treatment, y=Abundance, fill=Time)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point(position=position_dodge(width = 1), size=2) +
  facet_grid(Phylum~., scales = "free") +
  xlab("Treatment") +
  scale_fill_manual(values=c("#FFFFFF", "#BEBEBE")) +
  ylab("Relative Abundance") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(family="Arial", size=20),
        axis.text.y = element_text(family="Arial", size=16),
        axis.title.x = element_text(family="Arial", size=20, face="bold"),
        axis.title.y = element_text(family="Arial", size=20, face="bold"),
        legend.title = element_text(family="Arial", size=20, face="bold"),
        legend.text = element_text(family="Arial", size=20),
        plot.title = element_text(family = "Arial", size=20, face="bold"),
        strip.text.y = element_text(family="Arial", size=16),
        strip.background=element_rect(fill="#FFFFFF"),
        axis.ticks.x = element_blank()
        ) +
  geom_text(data=phy.ann, aes(label=lab), x=c(1,2,3,4,
                                              1,2,3,4,
                                              1,2,3,4,
                                              1,2,3,4,
                                              1,2,3,4,
                                              1,2,3,4),
            y=c(72,72,72,72,
                66,66,66,66,
                28,28,28,28,
                19,19,19,19,
                2.4,2.4,2.4,2.4,
                2.4,2.4,2.4,2.4),
            size=6, color="brown", family="Arial")
dev.off()

```


### Test Phyla
```{r}
### Firmicutes
fir.phy <- subset_taxa(phy99, Phylum == "Firmicutes")
fir.df <- data.frame(sample_data(fir.phy))
fir.df$RelAbund <- t(data.frame(otu_table(fir.phy)))
# Test normality
hist(fir.df$RelAbund, breaks=10)
qqnorm(fir.df$RelAbund)
qqline(fir.df$RelAbund)
shapiro.test(fir.df$RelAbund)
  # p-value = 0.02563
# Separate treatments
fir.lf.df <- fir.df[which(fir.df$Treatment == "Low Fat"),]
fir.hf.df <- fir.df[which(fir.df$Treatment == "High Fat"),]
fir.sc.df <- fir.df[which(fir.df$Treatment == "Saccharin"),]
fir.tv.df <- fir.df[which(fir.df$Treatment == "Stevia"),]
# Wilcoxon (Paired)
wilcox.test(RelAbund ~ Time, data=fir.lf.df, paired=T)
  # Low Fat
  # p-value = 0.1055
wilcox.test(RelAbund ~ Time, data=fir.hf.df, paired=T)
  # High Fat
  # p-value = 0.1641
wilcox.test(RelAbund ~ Time, data=fir.sc.df, paired=T, alternative="less")
  # Saccharin
  # p-value = 0.02734
  # Pre < Post
wilcox.test(RelAbund ~ Time, data=fir.tv.df, paired=T, alternative="less")
  # Stevia
  # p-value = 0.01172
  # Pre < Post
# Post-treatment Low Fat vs. High Fat Diets
fir.post.df <- fir.df[which(fir.df$Time == "Post-treatment"),]
wilcox.test(RelAbund ~ Diet, data=fir.post.df, alternative = "less")
  # p-value = 3.05e-05
  # Low Fat < High Fat



### Bacteroidetes
bac.phy <- subset_taxa(phy99, Phylum == "Bacteroidetes")
bac.df <- data.frame(sample_data(bac.phy))
bac.df$RelAbund <- t(data.frame(otu_table(bac.phy)))
# Test normality
hist(bac.df$RelAbund, breaks=10)
qqnorm(bac.df$RelAbund)
qqline(bac.df$RelAbund)
shapiro.test(bac.df$RelAbund)
  # p-value = 0.02563
# Separate treatments
bac.lf.df <- bac.df[which(bac.df$Treatment == "Low Fat"),]
bac.hf.df <- bac.df[which(bac.df$Treatment == "High Fat"),]
bac.sc.df <- bac.df[which(bac.df$Treatment == "Saccharin"),]
bac.tv.df <- bac.df[which(bac.df$Treatment == "Stevia"),]
# Wilcoxon (Paired)
wilcox.test(RelAbund ~ Time, data=bac.lf.df, paired=T, alternative="less")
  # Low Fat
  # p-value = 0.004883
  # Pre < Post
wilcox.test(RelAbund ~ Time, data=bac.hf.df, paired=T, alternative="greater")
  # High Fat
  # p-value = 0.01367
  # Pre > Post
wilcox.test(RelAbund ~ Time, data=bac.sc.df, paired=T, alternative = "greater")
  # Saccharin
  # p-value = 0.001953
  # Pre > Post
wilcox.test(RelAbund ~ Time, data=bac.tv.df, paired=T, alternative= "greater")
  # Stevia
  # p-value = 0.01172
  # Pre > Post
# Post-treatment Low Fat vs. High Fat Diets
bac.post.df <- bac.df[which(bac.df$Time == "Post-treatment"),]
wilcox.test(RelAbund ~ Diet, data=bac.post.df, alternative = "greater")
  # p-value = 3.934e-09
  # Low Fat > High Fat



### Verrucomicrobia
ver.phy <- subset_taxa(phy99, Phylum == "Verrucomicrobia")
ver.df <- data.frame(sample_data(ver.phy))
ver.df$RelAbund <- t(data.frame(otu_table(ver.phy)))
# Test normality
hist(ver.df$RelAbund, breaks=10)
qqnorm(ver.df$RelAbund)
qqline(ver.df$RelAbund)
shapiro.test(ver.df$RelAbund)
  # p-value = 0.02563
# Separate treatments
ver.lf.df <- ver.df[which(ver.df$Treatment == "Low Fat"),]
ver.hf.df <- ver.df[which(ver.df$Treatment == "High Fat"),]
ver.sc.df <- ver.df[which(ver.df$Treatment == "Saccharin"),]
ver.tv.df <- ver.df[which(ver.df$Treatment == "Stevia"),]
# Wilcoxon (Paired)
wilcox.test(RelAbund ~ Time, data=ver.lf.df, paired=T, alternative="greater")
  # Low Fat
  # p-value = 0.004883
  # Pre > Post
wilcox.test(RelAbund ~ Time, data=ver.hf.df, paired=T, alternative = "less")
  # High Fat
  # p-value = 0.009766
  # Pre < Post
wilcox.test(RelAbund ~ Time, data=ver.sc.df, paired=T, alternative = "less")
  # Saccharin
  # p-value = 0.01953
  # Pre < Post
wilcox.test(RelAbund ~ Time, data=ver.tv.df, paired=T)
  # Stevia
  # p-value = 0.6406
# Post-treatment Low Fat vs. High Fat Diets
ver.post.df <- ver.df[which(ver.df$Time == "Post-treatment"),]
wilcox.test(RelAbund ~ Diet, data=ver.post.df, alternative = "less")
  # p-value = 2.957e-05
  # Low Fat < High Fat



### Tenericutes
ten.phy <- subset_taxa(phy99, Phylum == "Tenericutes")
ten.df <- data.frame(sample_data(ten.phy))
ten.df$RelAbund <- t(data.frame(otu_table(ten.phy)))
# Test normality
hist(ten.df$RelAbund, breaks=10)
qqnorm(ten.df$RelAbund)
qqline(ten.df$RelAbund)
shapiro.test(ten.df$RelAbund)
  # p-value = 0.02563
# Separate treatments
ten.lf.df <- ten.df[which(ten.df$Treatment == "Low Fat"),]
ten.hf.df <- ten.df[which(ten.df$Treatment == "High Fat"),]
ten.sc.df <- ten.df[which(ten.df$Treatment == "Saccharin"),]
ten.tv.df <- ten.df[which(ten.df$Treatment == "Stevia"),]
# Wilcoxon (Paired)
wilcox.test(RelAbund ~ Time, data=ten.lf.df, paired=T, alternative="greater")
  # Low Fat
  # p-value = 0.04199
  # Pre > Post
wilcox.test(RelAbund ~ Time, data=ten.hf.df, paired=T, alternative = "greater")
  # High Fat
  # p-value = 0.009766
  # Pre > Post
wilcox.test(RelAbund ~ Time, data=ten.sc.df, paired=T, alternative = "greater")
  # Saccharin
  # p-value = 0.003906
  # Pre > Post
wilcox.test(RelAbund ~ Time, data=ten.tv.df, paired=T, alternative = "greater")
  # Stevia
  # p-value = 0.003906
  # Pre > Post
# Post-treatment Low Fat vs. High Fat Diets
ten.post.df <- ten.df[which(ten.df$Time == "Post-treatment"),]
wilcox.test(RelAbund ~ Diet, data=ten.post.df, alternative = "greater")
  # p-value = 5.445e-05
  # Low Fat > High Fat



### Proteobacteria
pro.phy <- subset_taxa(phy99, Phylum == "Proteobacteria")
pro.df <- data.frame(sample_data(pro.phy))
pro.df$RelAbund <- t(data.frame(otu_table(pro.phy)))
# Test normality
hist(pro.df$RelAbund, breaks=10)
qqnorm(pro.df$RelAbund)
qqline(pro.df$RelAbund)
shapiro.test(pro.df$RelAbund)
  # p-value = 0.02563
# Separate treatments
pro.lf.df <- pro.df[which(pro.df$Treatment == "Low Fat"),]
pro.hf.df <- pro.df[which(pro.df$Treatment == "High Fat"),]
pro.sc.df <- pro.df[which(pro.df$Treatment == "Saccharin"),]
pro.tv.df <- pro.df[which(pro.df$Treatment == "Stevia"),]
# Wilcoxon (Paired)
wilcox.test(RelAbund ~ Time, data=pro.lf.df, paired=T, alternative = "less")
  # Low Fat
  # p-value = 0.00293
  # Pre < Post
wilcox.test(RelAbund ~ Time, data=pro.hf.df, paired=T, alternative = "less")
  # High Fat
  # p-value = 0.001953
  # Pre < Post
wilcox.test(RelAbund ~ Time, data=pro.sc.df, paired=T, alternative = "less")
  # Saccharin
  # p-value = 0.003906
  # Pre < Post
wilcox.test(RelAbund ~ Time, data=pro.tv.df, paired=T, alternative = "less")
  # Stevia
  # p-value = 0.01172
  # Pre < Post
# Post-treatment Low Fat vs. High Fat Diets
pro.post.df <- pro.df[which(pro.df$Time == "Post-treatment"),]
wilcox.test(RelAbund ~ Diet, data=pro.post.df, alternative = "less")
  # p-value = 0.0007064
  # Low Fat < High Fat


### Actinobacteria
act.phy <- subset_taxa(phy99, Phylum == "Actinobacteria")
act.df <- data.frame(sample_data(act.phy))
act.df$RelAbund <- t(data.frame(otu_table(act.phy)))
# Test normality
hist(act.df$RelAbund, breaks=10)
qqnorm(act.df$RelAbund)
qqline(act.df$RelAbund)
shapiro.test(act.df$RelAbund)
  # p-value = 0.02563
# Separate treatments
act.lf.df <- act.df[which(act.df$Treatment == "Low Fat"),]
act.hf.df <- act.df[which(act.df$Treatment == "High Fat"),]
act.sc.df <- act.df[which(act.df$Treatment == "Saccharin"),]
act.tv.df <- act.df[which(act.df$Treatment == "Stevia"),]
# Wilcoxon (Paired)
wilcox.test(RelAbund ~ Time, data=act.lf.df, paired=T)
  # Low Fat
  # p-value = 0.6241
wilcox.test(RelAbund ~ Time, data=act.hf.df, paired=T, alternative = "less")
  # High Fat
  # p-value = 0.001953
  # Pre < Post
wilcox.test(RelAbund ~ Time, data=act.sc.df, paired=T, alternative = "less")
  # Saccharin
  # p-value = 0.001953
  # Pre < Post
wilcox.test(RelAbund ~ Time, data=act.tv.df, paired=T, alternative = "less")
  # Stevia
  # p-value = 0.003906
  # Pre < Post
# Post-treatment Low Fat vs. High Fat Diets
act.post.df <- act.df[which(act.df$Time == "Post-treatment"),]
wilcox.test(RelAbund ~ Diet, data=act.post.df, alternative = "less")
  # p-value = 4.732e-05
  # Low Fat < High Fat




### Adjust p-values
# Pre vs. Post Within-Treatment
p.adjust(c(0.1055, 0.1641, 0.02734, 0.01172, 0.004883, 0.01367, 0.001953, 0.01172, 0.004883, 0.009766, 0.01953, 0.6406, 0.04199, 0.009766, 0.003906, 0.003906, 0.00293, 0.001953, 0.003906, 0.01172, 0.6241, 0.001953, 0.001953, 0.003906), method="BH")
  # Firmicutes: 0.12057143 0.17901818 0.03453474 0.01758000
    # SC, TV
  # Bacteroidetes: 0.01065382 0.01929882 0.01041600 0.01758000
    # All
  # Verrucomicrobia: 0.01065382 0.01758000 0.02604000 0.64060000
    # LF, HF, SC
  # Tenericutes: 0.05038800 0.01758000 0.01041600 0.01041600
    # LF (Trend)
    # HF, SC, TV
  # Proteobacteria: 0.01041600 0.01041600 0.01041600 0.01758000
    # All
  # Actinobacteria: 0.64060000 0.01041600 0.01041600 0.01041600
    # HF, SC, TV
# Post-treatment Diet
p.adjust(c(3.05e-05, 3.934e-09, 2.957e-05, 5.445e-05, 0.0007064, 4.732e-05), method="BH")
  # 6.1000e-05 2.3604e-08 6.1000e-05 6.5340e-05 7.0640e-04 6.5340e-05

```


### Calculate Firmicutes / Bacteroidetes
```{r}
### Calculate Firmicutes/Bacteroidetes Ratio
fir.phy <- subset_taxa(phy99, Phylum == "Firmicutes")
bac.phy <- subset_taxa(phy99, Phylum == "Bacteroidetes")
fb.df <- data.frame(sample_data(fir.phy))
fb.df$Fir_RelAbund <- t(data.frame(otu_table(fir.phy)))
fb.df$Bac_RelAbund <- t(data.frame(otu_table(bac.phy)))
fb.df$FB_Ratio <- fb.df$Fir_RelAbund/fb.df$Bac_RelAbund
# Test normality of ratios
hist(fb.df$FB_Ratio, breaks=10)
qqnorm(fb.df$FB_Ratio)
qqline(fb.df$FB_Ratio)
shapiro.test(fb.df$FB_Ratio)
  # p-value = 0.0001835
  # Not Normal

# Test Low Fat Pre vs. Post
fb.lf <- fb.df[which(fb.df$Treatment == "Low Fat"),]
# Test normality of ratios
hist(fb.lf$FB_Ratio, breaks=10)
qqnorm(fb.lf$FB_Ratio)
qqline(fb.lf$FB_Ratio)
shapiro.test(fb.lf$FB_Ratio)
  # p-value = 0.001
  # Not Normal
# Wilcoxon (Paired)
wilcox.test(FB_Ratio ~ Time, data=fb.lf, paired=T, alternative="greater")
  # p-value = 0.01367
  # Pre > Post

# Test High Fat Pre vs. Post
fb.hf <- fb.df[which(fb.df$Treatment == "High Fat"),]
# Test normality of ratios
hist(fb.hf$FB_Ratio, breaks=10)
qqnorm(fb.hf$FB_Ratio)
qqline(fb.hf$FB_Ratio)
shapiro.test(fb.hf$FB_Ratio)
  # p-value = 0.21
  # Normal
  # However, since Low Fat Pre vs. Post is Not Normal, I'll use a non-parametric test. This is conservative.
# Wilcoxon (Paired)
wilcox.test(FB_Ratio ~ Time, data=fb.hf, paired=T)
  # p-value = 0.25
# T-test (Paired)
t.test(FB_Ratio ~ Time, data=fb.hf, paired=T)
  # p-value = 0.2167

# Test Saccharin Pre vs. Post
fb.sc <- fb.df[which(fb.df$Treatment == "Saccharin"),]
# Test normality of ratios
hist(fb.sc$FB_Ratio, breaks=10)
qqnorm(fb.sc$FB_Ratio)
qqline(fb.sc$FB_Ratio)
shapiro.test(fb.sc$FB_Ratio)
  # p-value = 0.6282
  # However, since Low Fat Pre vs. Post is Not Normal, I'll use a non-parametric test. This is conservative.
# Wilcoxon (Paired)
wilcox.test(FB_Ratio ~ Time, data=fb.sc, paired=T, alternative="less")
  # p-value = 0.003906
  # Pre < Post
# T-test (Paired)
t.test(FB_Ratio ~ Time, data=fb.sc, paired=T, alternative="less")
  # p-value = 0.001252


# Test Stevia Pre vs. Post
fb.tv <- fb.df[which(fb.df$Treatment == "Stevia"),]
# Test normality of ratios
hist(fb.tv$FB_Ratio, breaks=10)
qqnorm(fb.tv$FB_Ratio)
qqline(fb.tv$FB_Ratio)
shapiro.test(fb.tv$FB_Ratio)
  # p-value = 0.1139
  # However, since Low Fat Pre vs. Post is Not Normal, I'll use a non-parametric test. This is conservative.
# Wilcoxon (Paired)
wilcox.test(FB_Ratio ~ Time, data=fb.tv, paired=T, alternative="less")
  # p-value = 0.007813
  # Pre < Post
# T-test (Paired)
t.test(FB_Ratio ~ Time, data=fb.tv, paired=T, alternative="less")
  # p-value = 0.0009076

# Test Pre HF diets vs. Low Fat
fb.pre <- fb.df[which(fb.df$Time == "Pre-treatment"),]
fb.pre$Diet <- NA
fb.pre$Diet[which(fb.pre$Treatment == "Low Fat")] <- "Low Fat"
fb.pre$Diet[which(fb.pre$Treatment != "Low Fat")] <- "High Fat"
fb.pre$Diet <- ordered(fb.pre$Diet, levels=c("High Fat", "Low Fat"))
wilcox.test(FB_Ratio ~ Diet, data=fb.pre, alternative="greater")
  # p-value = 0.9585
kruskal.test(formula = FB_Ratio ~ Treatment, data=fb.pre)
  # p-value = 0.7042

# P-value adjustment for pre vs. post within-treatment comparisons
p.adjust(c(0.01367, 0.25, 0.003906, 0.007813), method="BH")
  # 0.01822667 0.25000000 0.01562400 0.01562600
  # Low Fat, High Fat, Saccharin, Stevia

# Test Post HF diets vs. Low Fat
fb.post <- fb.df[which(fb.df$Time == "Post-treatment"),]
fb.post$Diet <- NA
fb.post$Diet[which(fb.post$Treatment == "Low Fat")] <- "Low Fat"
fb.post$Diet[which(fb.post$Treatment != "Low Fat")] <- "High Fat"
fb.post$Diet <- ordered(fb.post$Diet, levels=c("High Fat", "Low Fat"))
wilcox.test(FB_Ratio ~ Diet, data=fb.post, alternative="greater")
  # p-value = 4.721e-08
  # High Fat > Low Fat





# Summarize Firmicutes:Bacteroidetes Ratio
fb.sum <- fb.df %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(FB_Ratio),
            Median = median(FB_Ratio),
            SD = sd(FB_Ratio),
            SE = sd(FB_Ratio)
            iqr = IQR(FB_Ratio))
fb.diet.sum <- fb.post %>%
  group_by(Diet) %>%
  summarize(Mean = mean(FB_Ratio),
            Median = median(FB_Ratio),
            SD = sd(FB_Ratio),
            iqr = IQR(FB_Ratio))



```





### Bray-Curtis PCoA
```{r}
### All Samples
bray.pcoa <- ordinate(physeq=physeq.pair, method="PCoA", distance="bray")


all.pcoa <- plot_ordination(physeq = physeq.pair, ordination = pair.pcoa, axes = c(1, 2),
                color="Treatment", shape="Time") + 
  scale_shape_manual(values=c(19,2), labels=c("Pre-treat", "Post-treat")) +
  scale_color_manual(values=c("#F0AC5F", "#FF0000", "#92D050", "#3565FF")) +
  ggtitle("All Samples") +
  geom_point(size=2, stroke=1.5) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(family="Arial", size=16),
        axis.text.y = element_text(family="Arial", size=16),
        axis.title.x = element_text(family="Arial", size=16, face="bold"),
        axis.title.y = element_text(family="Arial", size=16, face="bold"),
        legend.title = element_text(family="Arial", size=16, face="bold"),
        legend.text = element_text(family="Arial", size=16),
        plot.title = element_text(family = "Arial", size=16, face="bold", hjust=0.5),
        plot.margin = unit(c(1,1,1,1), "mm"),      # top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,0,-10,-8)
        ) +
  guides(color = guide_legend(order=1), shape = guide_legend(order=2))

### Pre-treatment
bray.pcoa.pre <- ordinate(physeq=physeq.pre, method="PCoA", distance="bray")

pre.pcoa <- plot_ordination(physeq = physeq.pre, ordination = bray.pcoa.pre, axes = c(1, 2),
                shape="Sex") + 
  scale_shape_manual(values=c(19,2)) +
  ggtitle("Pre-treatment") +
  geom_point(size=2, stroke=1.5) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(family="Arial", size=16),
        axis.text.y = element_text(family="Arial", size=16),
        axis.title.x = element_text(family="Arial", size=16, face="bold"),
        axis.title.y = element_text(family="Arial", size=16, face="bold"),
        legend.title = element_text(family="Arial", size=16, face="bold"),
        legend.text = element_text(family="Arial", size=16),
        legend.key.width = unit(0.9, "cm"),
        plot.margin = unit(c(1,1,1,1), "mm"),      # top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,0,-10,-7),
        plot.title = element_text(family = "Arial", size=16, face="bold", hjust=0.5)
        ) 

### Post-treatment w/o Low Far
bray.pcoa.post.rem <- ordinate(physeq=physeq.post.rem, method="PCoA", distance="bray")

post.rem.pcoa <- plot_ordination(physeq = physeq.post.rem, ordination = bray.pcoa.post.rem, axes = c(1, 2),
                color="Treatment", shape="Sex") + 
  scale_color_manual(values=c("#FF0000", "#92D050", "#3565FF")) +
  scale_shape_manual(values=c(19,2)) +
  ggtitle("Post-treatment (no Low Fat)") +
  geom_point(size=2, stroke=1.5) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(family="Arial", size=16),
        axis.text.y = element_text(family="Arial", size=16),
        axis.title.x = element_text(family="Arial", size=16, face="bold"),
        axis.title.y = element_text(family="Arial", size=16, face="bold"),
        legend.title = element_text(family="Arial", size=16, face="bold"),
        legend.text = element_text(family="Arial", size=16),
        plot.title = element_text(family = "Arial", size=16, face="bold", hjust=0.5),
        plot.margin = unit(c(1,1,1,1), "mm"),      # top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,0,-10,-8)
        ) +
  guides(color = guide_legend(order=1), shape = guide_legend(order=2))

```
### PCoA Plot
```{r}
tiff("pcoa.tiff", width=160, height = 300, units="mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(6,1, widths=c(1), heights=c(0.07, 1, 0.07, 1, 0.07, 1)))))
grid.text("A", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=1),
          gp=gpar(fontsize=22,fontface="bold",fontfamily="Arial"))
print(all.pcoa, vp=viewport(layout.pos.row=2, layout.pos.col=1))
grid.text("B", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=3, layout.pos.col=1),
          gp=gpar(fontsize=22,fontface="bold",fontfamily="Arial"))
print(pre.pcoa, vp=viewport(layout.pos.row=4, layout.pos.col=1))
grid.text("C", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=5, layout.pos.col=1),
          gp=gpar(fontsize=22,fontface="bold",fontfamily="Arial"))
print(post.rem.pcoa, vp=viewport(layout.pos.row=6, layout.pos.col=1))
dev.off()


```

### PERMANOVA Bray-Curtis
```{r}
##### Compare Pre- vs. Post- Within Treatments #####

### Calculate Bray-Curtis Dissimilarity
bray.pcoa <- phyloseq::distance(physeq = physeq.pair, method="bray")

### Low Fat
lf.sampdf <- data.frame(sample_data(physeq.lf))
lf.bray <- phyloseq::distance(physeq=physeq.lf, method="bray")

# Time
adonis(lf.bray ~ Time, data=lf.sampdf)
  # p-value = 0.001
  # R2 = 0.20248
beta.tax = betadisper(d=lf.bray, group=lf.sampdf$Time)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.528

# Combined
adonis(lf.bray ~ Time + Sex + Subj_ID, data=lf.sampdf)
  # Time: p-value = 0.001; R2 = 0.20248
  # Sex: p-value = 0.001; R2 = 0.14304
  # Subj_ID: p-value = 0.303; R2 = 0.32439
  # Residuals = 0.3309


### High Fat
hf.sampdf <- data.frame(sample_data(physeq.hf))
hf.bray <- phyloseq::distance(physeq=physeq.hf, method="bray")

# Time
adonis(hf.bray ~ Time, data=hf.sampdf)
  # p-value = 0.001
  # R2 = 0.48394
beta.tax = betadisper(d=hf.bray, group=hf.sampdf$Time)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.005

# Combined
adonis(hf.bray ~ Time + Sex + Subj_ID, data=hf.sampdf)
  # Time: p-value = 0.001; R2 = 0.48394
  # Sex: p-value = 0.038; R2 = 0.08379
  # Subj_ID: p-value = 0.471; R2 = 0.20163
  # Residual: 0.23065


### Saccharin
sc.sampdf <- data.frame(sample_data(physeq.sc))
sc.bray <- phyloseq::distance(physeq=physeq.sc, method="bray")

# Time
adonis(sc.bray ~ Time, data=sc.sampdf)
  # p-value = 0.002
  # R2 = 0.43652
beta.tax = betadisper(d=sc.bray, group=sc.sampdf$Time)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.007

# Combined
adonis(sc.bray ~ Time + Sex + Subj_ID, data=sc.sampdf)
  # Time: p-value = 0.001; R2 = 0.43652
  # Sex: p-value = 0.016; R2 = 0.09876
  # Subj_ID: p-value = 0.303; R2 = 0.24012
  # Residuals = 0.22460



### Stevia
tv.sampdf <- data.frame(sample_data(physeq.tv))
tv.bray <- phyloseq::distance(physeq=physeq.tv, method="bray")

# Time
adonis(tv.bray ~ Time, data=tv.sampdf)
  # p-value = 0.001
  # R2 = 0.48081
beta.tax = betadisper(d=tv.bray, group=tv.sampdf$Time)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001

# Combined
adonis(tv.bray ~ Time + Sex + Subj_ID, data=tv.sampdf)
  # Time: p-value = 0.001; R2 = 0.48081
  # Sex: p-value = 0.017; R2 = 0.11129
  # Subj_ID: p-value = 0.580; R2 = 0.17960
  # Residuals = 0.22830



### Adj Pvals
# Compare within each treatment, Pre vs. Post
p.adjust(c(0.001, 0.001, 0.002, 0.001), method="BH")
  # LF, HF, SC, TV
  # 0.001333333 0.001333333 0.002000000 0.001333333

# Compare within each treatment, Time/Sex/Subj_ID
p.adjust(c(0.001, 0.001, 0.303, 0.001, 0.038, 0.471, 0.001, 0.016, 0.303, 0.001, 0.017, 0.580), method="BH")
  # LF (Time, Sex, Subj_ID)
    # 0.00240000 0.00240000 0.36360000
  # HF (Time, Sex, Subj_ID)
    # 0.00240000 0.05700000 0.51381818
  # SC (Time, Sex, Subj_ID)
    # 0.00240000 0.02914286 0.36360000
  # TV (Time, Sex, Subj_ID)
    # 0.00240000 0.02914286 0.58000000


   


### Pre-treatment
pre.sampdf <- data.frame(sample_data(physeq.pre))
pre.bray <- phyloseq::distance(physeq=physeq.pre, method="bray")

# Sex
adonis(pre.bray ~ Sex, data=pre.sampdf)
  # p-value = 0.001
  # R2 = 0.34423
beta.tax = betadisper(d=pre.bray, group=pre.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.042
  # Right on edge of 0.05 due to variation in test

# Combined Variables
adonis(pre.bray ~ Sex + Treatment, data=pre.sampdf)
  # Sex: p-value = 0.001; R2 = 0.34423
  # Treatment: p-value = 0.340; R2 = 0.06231
adonis(pre.bray ~ Sex*Treatment, data=pre.sampdf)
  # Sex: p-value = 0.001, R2 = 0.34423
  # Treatment: p-value = 0.367, R2 = 0.06231
  # Sex:Treatment: p-value = 0.414, R2 = 0.05765
  # Residuals = 0.53580






### Post-treatment
post.sampdf <- data.frame(sample_data(physeq.post))
post.bray <- phyloseq::distance(physeq=physeq.post, method="bray")

# Sex
adonis(post.bray ~ Sex, data=post.sampdf)
  # p-value = 0.166
  # R2 = 0.04113
beta.tax = betadisper(d=post.bray, group=post.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.859

# Treatment
adonis(post.bray ~ Treatment, data=post.sampdf)
  # p-value = 0.001
  # R2 = 0.47417
beta.tax = betadisper(d=post.bray, group=post.sampdf$Treatment)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
anosim(post.bray, post.sampdf$Treatment)
  # p-value = 0.001
  # R = 0.4626

# Combined Variables
adonis(post.bray ~ Treatment + Sex, data=post.sampdf)
  # Treatment: p-value = 0.001; R2 = 0.47417
  # Sex: p-value = 0.036; R2 = 0.04196
  # Residuals = 0.48387
adonis(post.bray ~ Treatment*Sex, data=post.sampdf)
  # Treatment: p-value = 0.001, R2 = 0.47417
  # Sex: p-value = 0.025, R2 = 0.04196
  # Treatment:Sex: p-value = 0.186, R2 = 0.05951
  # Residuals = 0.42435






### Post-treatment Low Fat
lf.post.sampdf <- data.frame(sample_data(physeq.lf.post))
lf.post.bray <- phyloseq::distance(physeq=physeq.lf.post, method="bray")

# Sex
adonis(lf.post.bray ~ Sex, data=lf.post.sampdf)
  # p-value = 0.168
  # R2 = 0.1441
beta.tax = betadisper(d=lf.post.bray, group=lf.post.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.312


### Post-treatment High Fat
hf.post.sampdf <- data.frame(sample_data(physeq.hf.post))
hf.post.bray <- phyloseq::distance(physeq=physeq.hf.post, method="bray")

# Sex
adonis(hf.post.bray ~ Sex, data=hf.post.sampdf)
  # p-value = 0.172
  # R2 = 0.18592
beta.tax = betadisper(d=hf.post.bray, group=hf.post.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.65


### Post-treatment Saccharin
sc.post.sampdf <- data.frame(sample_data(physeq.sc.post))
sc.post.bray <- phyloseq::distance(physeq=physeq.sc.post, method="bray")

# Sex
adonis(sc.post.bray ~ Sex, data=sc.post.sampdf)
  # p-value = 0.01
  # R2 = 0.31108
beta.tax = betadisper(d=sc.post.bray, group=sc.post.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.551


### Post-treatment Stevia
tv.post.sampdf <- data.frame(sample_data(physeq.tv.post))
tv.post.bray <- phyloseq::distance(physeq=physeq.tv.post, method="bray")

# Sex
adonis(tv.post.bray ~ Sex, data=tv.post.sampdf)
  # p-value = 0.193
  # R2 = 0.17863
beta.tax = betadisper(d=tv.post.bray, group=tv.post.sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.386

### Adj Pvals
# Compare Post-treatment Treatment Groups
p.adjust(c(0.168, 0.172, 0.01, 0.093), method="BH")
  # LF, HF, SC, TV
  # 0.172 0.172 0.040 0.172









### Pairwise comparisons 
combos <- combn(x=levels(pair.sampdf$Treatment), m=2)

bray.pvals.post <- data.frame(rep(999,6))
for( i in 1:ncol(combos)){
  temp.physeq <- subset_samples(physeq.post, Treatment %in% combos[,i])
  temp.sampdf <- data.frame(sample_data(temp.physeq))
  temp.bray <- phyloseq::distance(physeq=temp.physeq, method="bray")
  test <- adonis(temp.bray ~ Group, data=temp.sampdf)
  rownames(bray.pvals.post)[i] <- paste(combos[1,i], combos[2,i])
  bray.pvals.post[i,1]<- test[[1]]$`Pr(>F)`[1]
  bray.pvals.post[i,2] <- test[[1]]$R2[1]
}
colnames(bray.pvals.post) <- c("pval", "R2")
bray.pvals.post$Adj.BH <- p.adjust(bray.pvals.post$pval, method="BH")


bray.pvals.post.fem <- data.frame(rep(999,6))
bray.pvals.post.fem$R2 <- rep(999,6)
for( i in 1:ncol(combos)){
  temp.physeq <- subset_samples(physeq.post.fem, Treatment %in% combos[,i])
  temp.sampdf <- data.frame(sample_data(temp.physeq))
  temp.bray <- phyloseq::distance(physeq=temp.physeq, method="bray")
  test <- adonis(temp.bray ~ Treatment, data=temp.sampdf)
  rownames(bray.pvals.post.fem)[i] <- paste(combos[1,i], combos[2,i])
  bray.pvals.post.fem[i,1] <- test[[1]]$`Pr(>F)`[1]
  bray.pvals.post.fem[i,2] <- test[[1]]$R2[1]
}
colnames(bray.pvals.post.fem) <- c("pval", "R2")


bray.pvals.post.mal <- data.frame(rep(999,6))
bray.pvals.post.mal$R2 <- rep(999,6)
for( i in 1:ncol(combos)){
  temp.physeq <- subset_samples(physeq.post.mal, Treatment %in% combos[,i])
  temp.sampdf <- data.frame(sample_data(temp.physeq))
  temp.bray <- phyloseq::distance(physeq=temp.physeq, method="bray")
  test <- adonis(temp.bray ~ Group, data=temp.sampdf)
  rownames(bray.pvals.post.mal)[i] <- paste(combos[1,i], combos[2,i])
  bray.pvals.post.mal[i,1]<- test[[1]]$`Pr(>F)`[1]
  bray.pvals.post.mal[i,2] <- test[[1]]$R2[1]
}
colnames(bray.pvals.post.mal) <- c("pval", "R2")


bray.pairwise.pvals.post <- bray.pvals.post.fem
bray.pairwise.pvals.post[(nrow(bray.pairwise.pvals.post)+1):(nrow(bray.pairwise.pvals.post) + nrow(bray.pvals.post.mal)),] <- bray.pvals.post.mal
rownames(bray.pairwise.pvals.post) <-  c("Female Low Fat High Fat", "Female Low Fat Saccharin", "Female Low Fat Stevia", "Female High Fat Saccharin", "Female High Fat Stevia", "Female Saccharin Stevia", "Male Low Fat High Fat", "Male Low Fat Saccharin", "Male Low Fat Stevia", "Male High Fat Saccharin", "Male High Fat Stevia", "Male Saccharin Stevia")
bray.pairwise.pvals.post$Adj.BH <- p.adjust(bray.pairwise.pvals.post$pval, method="BH")




```











### Simper
```{r}
# ### Pre-treatment - Sex
# simper.pretty(data.frame(otu_table(physeq.pre)),
#               data.frame(sample_data(physeq.pre)),
#               c("Sex"),
#               perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
#               output_name='stevia.pre')
# stevia.pre.simper <- read.csv("stevia.pre_clean_simper.csv")
# kruskal.pretty(data.frame(otu_table(physeq.pre)),
#                data.frame(sample_data(physeq.pre)),
#                csv = stevia.pre.simper,
#                c("Sex"),
#                output_name = 'stevia.pre',
#                taxonomy = data.frame(tax_table(physeq.pre)))
# stevia.pre.simper.kw <- read.csv("stevia.pre_krusk_simper.csv")
# for(i in 1:nrow(stevia.pre.simper.kw)){
#   save <- which(rownames(data.frame(tax_table(physeq.pre))) == stevia.pre.simper.kw$OTU[i])
#   stevia.pre.simper.kw$Taxonomy[i] <-
#     paste(tax_table(physeq.pre)[save,2][[1]], "-",
#           tax_table(physeq.pre)[save,3][[1]], "-",
#           tax_table(physeq.pre)[save,4][[1]], "-",
#           tax_table(physeq.pre)[save,5][[1]], "-",
#           tax_table(physeq.pre)[save,6][[1]])
# }
# write.table(stevia.pre.simper.kw, "stevia.pre_krusk_simper.csv", sep=",")




# ### Post-treatment Females - Treatment
# simper.pretty(data.frame(otu_table(physeq.post.fem)),
#               data.frame(sample_data(physeq.post.fem)),
#               c("Treatment"),
#               perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
#               output_name='stevia.post.fem')
# stevia.post.fem.simper <- read.csv("stevia.post.fem_clean_simper.csv")
# kruskal.pretty(data.frame(otu_table(physeq.post.fem)),
#                data.frame(sample_data(physeq.post.fem)),
#                csv = stevia.post.fem.simper,
#                c("Treatment"),
#                output_name = 'stevia.post.fem',
#                taxonomy = data.frame(tax_table(physeq.post.fem)))
# stevia.post.fem.simper.kw <- read.csv("stevia.post.fem_krusk_simper.csv")
# for(i in 1:nrow(stevia.post.fem.simper.kw)){
#   save <- which(rownames(data.frame(tax_table(physeq.post.fem))) == stevia.post.fem.simper.kw$OTU[i])
#   stevia.post.fem.simper.kw$Taxonomy[i] <-
#     paste(tax_table(physeq.post.fem)[save,2][[1]], "-",
#           tax_table(physeq.post.fem)[save,3][[1]], "-",
#           tax_table(physeq.post.fem)[save,4][[1]], "-",
#           tax_table(physeq.post.fem)[save,5][[1]], "-",
#           tax_table(physeq.post.fem)[save,6][[1]])
# }
# write.table(stevia.post.fem.simper.kw, "stevia.post.fem_krusk_simper.csv", sep=",")
# 
# 
# 
# 
# ### Post-treatment Males - Treatment
# simper.pretty(data.frame(otu_table(physeq.post.mal)),
#               data.frame(sample_data(physeq.post.mal)),
#               c("Treatment"),
#               perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
#               output_name='stevia.post.mal')
# stevia.post.mal.simper <- read.csv("stevia.post.mal_clean_simper.csv")
# kruskal.pretty(data.frame(otu_table(physeq.post.mal)),
#                data.frame(sample_data(physeq.post.mal)),
#                csv = stevia.post.mal.simper,
#                c("Treatment"),
#                output_name = 'stevia.post.mal',
#                taxonomy = data.frame(tax_table(physeq.post.mal)))
# stevia.post.mal.simper.kw <- read.csv("stevia.post.mal_krusk_simper.csv")
# for(i in 1:nrow(stevia.post.mal.simper.kw)){
#   save <- which(rownames(data.frame(tax_table(physeq.post.mal))) == stevia.post.mal.simper.kw$OTU[i])
#   stevia.post.mal.simper.kw$Taxonomy[i] <-
#     paste(tax_table(physeq.post.mal)[save,2][[1]], "-",
#           tax_table(physeq.post.mal)[save,3][[1]], "-",
#           tax_table(physeq.post.mal)[save,4][[1]], "-",
#           tax_table(physeq.post.mal)[save,5][[1]], "-",
#           tax_table(physeq.post.mal)[save,6][[1]])
# }
# write.table(stevia.post.mal.simper.kw, "stevia.post.mal_krusk_simper.csv", sep=",")
# 
# 
# 
#
# ### Low Fat Females
# simper.pretty(data.frame(otu_table(physeq.lf.fem)),
#               data.frame(sample_data(physeq.lf.fem)),
#               c("Time"),
#               perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
#               output_name='stevia.lf.fem')
# stevia.lf.fem.simper <- read.csv("stevia.lf.fem_clean_simper.csv")
# kruskal.pretty(data.frame(otu_table(physeq.lf.fem)),
#                data.frame(sample_data(physeq.lf.fem)),
#                csv = stevia.lf.fem.simper,
#                c("Time"),
#                output_name = 'stevia.lf.fem',
#                taxonomy = data.frame(tax_table(physeq.lf.fem)))
# stevia.lf.fem.simper.kw <- read.csv("stevia.lf.fem_krusk_simper.csv")
# for(i in 1:nrow(stevia.lf.fem.simper.kw)){
#   save <- which(rownames(data.frame(tax_table(physeq.lf.fem))) == stevia.lf.fem.simper.kw$OTU[i])
#   stevia.lf.fem.simper.kw$Taxonomy[i] <-
#     paste(tax_table(physeq.lf.fem)[save,2][[1]], "-",
#           tax_table(physeq.lf.fem)[save,3][[1]], "-",
#           tax_table(physeq.lf.fem)[save,4][[1]], "-",
#           tax_table(physeq.lf.fem)[save,5][[1]], "-",
#           tax_table(physeq.lf.fem)[save,6][[1]])
# }
# write.table(stevia.lf.fem.simper.kw, "stevia.lf.fem_krusk_simper.csv", sep=",")
# 
# 
# 
# ### Low Fat Males
# simper.pretty(data.frame(otu_table(physeq.lf.mal)),
#               data.frame(sample_data(physeq.lf.mal)),
#               c("Time"),
#               perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
#               output_name='stevia.lf.mal')
# stevia.lf.mal.simper <- read.csv("stevia.lf.mal_clean_simper.csv")
# kruskal.pretty(data.frame(otu_table(physeq.lf.mal)),
#                data.frame(sample_data(physeq.lf.mal)),
#                csv = stevia.lf.mal.simper,
#                c("Time"),
#                output_name = 'stevia.lf.mal',
#                taxonomy = data.frame(tax_table(physeq.lf.mal)))
# stevia.lf.mal.simper.kw <- read.csv("stevia.lf.mal_krusk_simper.csv")
# for(i in 1:nrow(stevia.lf.mal.simper.kw)){
#   save <- which(rownames(data.frame(tax_table(physeq.lf.mal))) == stevia.lf.mal.simper.kw$OTU[i])
#   stevia.lf.mal.simper.kw$Taxonomy[i] <-
#     paste(tax_table(physeq.lf.mal)[save,2][[1]], "-",
#           tax_table(physeq.lf.mal)[save,3][[1]], "-",
#           tax_table(physeq.lf.mal)[save,4][[1]], "-",
#           tax_table(physeq.lf.mal)[save,5][[1]], "-",
#           tax_table(physeq.lf.mal)[save,6][[1]])
# }
# write.table(stevia.lf.mal.simper.kw, "stevia.lf.mal_krusk_simper.csv", sep=",")
# 
# 
# 
# 
# 
# ### High Fat Females
# simper.pretty(data.frame(otu_table(physeq.hf.fem)),
#               data.frame(sample_data(physeq.hf.fem)),
#               c("Time"),
#               perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
#               output_name='stevia.hf.fem')
# stevia.hf.fem.simper <- read.csv("stevia.hf.fem_clean_simper.csv")
# kruskal.pretty(data.frame(otu_table(physeq.hf.fem)),
#                data.frame(sample_data(physeq.hf.fem)),
#                csv = stevia.hf.fem.simper,
#                c("Time"),
#                output_name = 'stevia.hf.fem',
#                taxonomy = data.frame(tax_table(physeq.hf.fem)))
# stevia.hf.fem.simper.kw <- read.csv("stevia.hf.fem_krusk_simper.csv")
# for(i in 1:nrow(stevia.hf.fem.simper.kw)){
#   save <- which(rownames(data.frame(tax_table(physeq.hf.fem))) == stevia.hf.fem.simper.kw$OTU[i])
#   stevia.hf.fem.simper.kw$Taxonomy[i] <-
#     paste(tax_table(physeq.hf.fem)[save,2][[1]], "-",
#           tax_table(physeq.hf.fem)[save,3][[1]], "-",
#           tax_table(physeq.hf.fem)[save,4][[1]], "-",
#           tax_table(physeq.hf.fem)[save,5][[1]], "-",
#           tax_table(physeq.hf.fem)[save,6][[1]])
# }
# write.table(stevia.hf.fem.simper.kw, "stevia.hf.fem_krusk_simper.csv", sep=",")
# 
# 
# 
# ### High Fat Males
# simper.pretty(data.frame(otu_table(physeq.hf.mal)),
#               data.frame(sample_data(physeq.hf.mal)),
#               c("Time"),
#               perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
#               output_name='stevia.hf.mal')
# stevia.hf.mal.simper <- read.csv("stevia.hf.mal_clean_simper.csv")
# kruskal.pretty(data.frame(otu_table(physeq.hf.mal)),
#                data.frame(sample_data(physeq.hf.mal)),
#                csv = stevia.hf.mal.simper,
#                c("Time"),
#                output_name = 'stevia.hf.mal',
#                taxonomy = data.frame(tax_table(physeq.hf.mal)))
# stevia.hf.mal.simper.kw <- read.csv("stevia.hf.mal_krusk_simper.csv")
# for(i in 1:nrow(stevia.hf.mal.simper.kw)){
#   save <- which(rownames(data.frame(tax_table(physeq.hf.mal))) == stevia.hf.mal.simper.kw$OTU[i])
#   stevia.hf.mal.simper.kw$Taxonomy[i] <-
#     paste(tax_table(physeq.hf.mal)[save,2][[1]], "-",
#           tax_table(physeq.hf.mal)[save,3][[1]], "-",
#           tax_table(physeq.hf.mal)[save,4][[1]], "-",
#           tax_table(physeq.hf.mal)[save,5][[1]], "-",
#           tax_table(physeq.hf.mal)[save,6][[1]])
# }
# write.table(stevia.hf.mal.simper.kw, "stevia.hf.mal_krusk_simper.csv", sep=",")
# 
# 
# 
# 
# 
# ### Saccharin Females
# simper.pretty(data.frame(otu_table(physeq.sc.fem)),
#               data.frame(sample_data(physeq.sc.fem)),
#               c("Time"),
#               perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
#               output_name='stevia.sc.fem')
# stevia.sc.fem.simper <- read.csv("stevia.sc.fem_clean_simper.csv")
# kruskal.pretty(data.frame(otu_table(physeq.sc.fem)),
#                data.frame(sample_data(physeq.sc.fem)),
#                csv = stevia.sc.fem.simper,
#                c("Time"),
#                output_name = 'stevia.sc.fem',
#                taxonomy = data.frame(tax_table(physeq.sc.fem)))
# stevia.sc.fem.simper.kw <- read.csv("stevia.sc.fem_krusk_simper.csv")
# for(i in 1:nrow(stevia.sc.fem.simper.kw)){
#   save <- which(rownames(data.frame(tax_table(physeq.sc.fem))) == stevia.sc.fem.simper.kw$OTU[i])
#   stevia.sc.fem.simper.kw$Taxonomy[i] <-
#     paste(tax_table(physeq.sc.fem)[save,2][[1]], "-",
#           tax_table(physeq.sc.fem)[save,3][[1]], "-",
#           tax_table(physeq.sc.fem)[save,4][[1]], "-",
#           tax_table(physeq.sc.fem)[save,5][[1]], "-",
#           tax_table(physeq.sc.fem)[save,6][[1]])
# }
# write.table(stevia.sc.fem.simper.kw, "stevia.sc.fem_krusk_simper.csv", sep=",")
# 
# 
# 
# ### Saccharin Males
# simper.pretty(data.frame(otu_table(physeq.sc.mal)),
#               data.frame(sample_data(physeq.sc.mal)),
#               c("Time"),
#               perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
#               output_name='stevia.sc.mal')
# stevia.sc.mal.simper <- read.csv("stevia.sc.mal_clean_simper.csv")
# kruskal.pretty(data.frame(otu_table(physeq.sc.mal)),
#                data.frame(sample_data(physeq.sc.mal)),
#                csv = stevia.sc.mal.simper,
#                c("Time"),
#                output_name = 'stevia.sc.mal',
#                taxonomy = data.frame(tax_table(physeq.sc.mal)))
# stevia.sc.mal.simper.kw <- read.csv("stevia.sc.mal_krusk_simper.csv")
# for(i in 1:nrow(stevia.sc.mal.simper.kw)){
#   save <- which(rownames(data.frame(tax_table(physeq.sc.mal))) == stevia.sc.mal.simper.kw$OTU[i])
#   stevia.sc.mal.simper.kw$Taxonomy[i] <-
#     paste(tax_table(physeq.sc.mal)[save,2][[1]], "-",
#           tax_table(physeq.sc.mal)[save,3][[1]], "-",
#           tax_table(physeq.sc.mal)[save,4][[1]], "-",
#           tax_table(physeq.sc.mal)[save,5][[1]], "-",
#           tax_table(physeq.sc.mal)[save,6][[1]])
# }
# write.table(stevia.sc.mal.simper.kw, "stevia.sc.mal_krusk_simper.csv", sep=",")
# 
# 
# 
# 
# ### Stevia Females
# simper.pretty(data.frame(otu_table(physeq.tv.fem)),
#               data.frame(sample_data(physeq.tv.fem)),
#               c("Time"),
#               perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
#               output_name='stevia.tv.fem')
# stevia.tv.fem.simper <- read.csv("stevia.tv.fem_clean_simper.csv")
# kruskal.pretty(data.frame(otu_table(physeq.tv.fem)),
#                data.frame(sample_data(physeq.tv.fem)),
#                csv = stevia.tv.fem.simper,
#                c("Time"),
#                output_name = 'stevia.tv.fem',
#                taxonomy = data.frame(tax_table(physeq.tv.fem)))
# stevia.tv.fem.simper.kw <- read.csv("stevia.tv.fem_krusk_simper.csv")
# for(i in 1:nrow(stevia.tv.fem.simper.kw)){
#   save <- which(rownames(data.frame(tax_table(physeq.tv.fem))) == stevia.tv.fem.simper.kw$OTU[i])
#   stevia.tv.fem.simper.kw$Taxonomy[i] <-
#     paste(tax_table(physeq.tv.fem)[save,2][[1]], "-",
#           tax_table(physeq.tv.fem)[save,3][[1]], "-",
#           tax_table(physeq.tv.fem)[save,4][[1]], "-",
#           tax_table(physeq.tv.fem)[save,5][[1]], "-",
#           tax_table(physeq.tv.fem)[save,6][[1]])
# }
# write.table(stevia.tv.fem.simper.kw, "stevia.tv.fem_krusk_simper.csv", sep=",")
# 
# 
# 
# ### Stevia Males
# simper.pretty(data.frame(otu_table(physeq.tv.mal)),
#               data.frame(sample_data(physeq.tv.mal)),
#               c("Time"),
#               perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
#               output_name='stevia.tv.mal')
# stevia.tv.mal.simper <- read.csv("stevia.tv.mal_clean_simper.csv")
# kruskal.pretty(data.frame(otu_table(physeq.tv.mal)),
#                data.frame(sample_data(physeq.tv.mal)),
#                csv = stevia.tv.mal.simper,
#                c("Time"),
#                output_name = 'stevia.tv.mal',
#                taxonomy = data.frame(tax_table(physeq.tv.mal)))
# stevia.tv.mal.simper.kw <- read.csv("stevia.tv.mal_krusk_simper.csv")
# for(i in 1:nrow(stevia.tv.mal.simper.kw)){
#   save <- which(rownames(data.frame(tax_table(physeq.tv.mal))) == stevia.tv.mal.simper.kw$OTU[i])
#   stevia.tv.mal.simper.kw$Taxonomy[i] <-
#     paste(tax_table(physeq.tv.mal)[save,2][[1]], "-",
#           tax_table(physeq.tv.mal)[save,3][[1]], "-",
#           tax_table(physeq.tv.mal)[save,4][[1]], "-",
#           tax_table(physeq.tv.mal)[save,5][[1]], "-",
#           tax_table(physeq.tv.mal)[save,6][[1]])
# }
# write.table(stevia.tv.mal.simper.kw, "stevia.tv.mal_krusk_simper.csv", sep=",")







### BH P-value COrrection for Time Comparisons
# Females
stevia.hf.fem.simper.kw$Group <- rep("High Fat", nrow(stevia.hf.fem.simper.kw))
stevia.hf.fem.simper.kw$OTU <- as.character(stevia.hf.fem.simper.kw$OTU)
stevia.hf.fem.simper.kw$Comparison <- as.character(stevia.hf.fem.simper.kw$Comparison)
stevia.lf.fem.simper.kw$Group <- rep("Low Fat", nrow(stevia.lf.fem.simper.kw))
stevia.lf.fem.simper.kw$OTU <- as.character(stevia.lf.fem.simper.kw$OTU)
stevia.lf.fem.simper.kw$Comparison <- as.character(stevia.lf.fem.simper.kw$Comparison)
stevia.sc.fem.simper.kw$Group <- rep("Saccharin", nrow(stevia.sc.fem.simper.kw))
stevia.sc.fem.simper.kw$OTU <- as.character(stevia.sc.fem.simper.kw$OTU)
stevia.sc.fem.simper.kw$Comparison <- as.character(stevia.sc.fem.simper.kw$Comparison)
stevia.tv.fem.simper.kw$Group <- rep("Stevia", nrow(stevia.tv.fem.simper.kw))
stevia.tv.fem.simper.kw$OTU <- as.character(stevia.tv.fem.simper.kw$OTU)
stevia.tv.fem.simper.kw$Comparison <- as.character(stevia.tv.fem.simper.kw$Comparison)
simper.fem.time <- stevia.hf.fem.simper.kw
simper.fem.time[(nrow(simper.fem.time)+1):(nrow(simper.fem.time)+nrow(stevia.lf.fem.simper.kw)),] <- stevia.lf.fem.simper.kw
simper.fem.time[(nrow(simper.fem.time)+1):(nrow(simper.fem.time)+nrow(stevia.sc.fem.simper.kw)),] <- stevia.sc.fem.simper.kw
simper.fem.time[(nrow(simper.fem.time)+1):(nrow(simper.fem.time)+nrow(stevia.tv.fem.simper.kw)),] <- stevia.tv.fem.simper.kw
simper.fem.time$fdr_krusk_p.val <- p.adjust(simper.fem.time$krusk_p.val, "BH")
#write.table(simper.fem.time, "simper.fem.time.csv", sep=",")

# Males
stevia.hf.mal.simper.kw$Group <- rep("High Fat", nrow(stevia.hf.mal.simper.kw))
stevia.hf.mal.simper.kw$OTU <- as.character(stevia.hf.mal.simper.kw$OTU)
stevia.hf.mal.simper.kw$Comparison <- as.character(stevia.hf.mal.simper.kw$Comparison)
stevia.lf.mal.simper.kw$Group <- rep("Low Fat", nrow(stevia.lf.mal.simper.kw))
stevia.lf.mal.simper.kw$OTU <- as.character(stevia.lf.mal.simper.kw$OTU)
stevia.lf.mal.simper.kw$Comparison <- as.character(stevia.lf.mal.simper.kw$Comparison)
stevia.sc.mal.simper.kw$Group <- rep("Saccharin", nrow(stevia.sc.mal.simper.kw))
stevia.sc.mal.simper.kw$OTU <- as.character(stevia.sc.mal.simper.kw$OTU)
stevia.sc.mal.simper.kw$Comparison <- as.character(stevia.sc.mal.simper.kw$Comparison)
stevia.tv.mal.simper.kw$Group <- rep("Stevia", nrow(stevia.tv.mal.simper.kw))
stevia.tv.mal.simper.kw$OTU <- as.character(stevia.tv.mal.simper.kw$OTU)
stevia.tv.mal.simper.kw$Comparison <- as.character(stevia.tv.mal.simper.kw$Comparison)
simper.mal.time <- stevia.hf.mal.simper.kw
simper.mal.time[(nrow(simper.mal.time)+1):(nrow(simper.mal.time)+nrow(stevia.lf.mal.simper.kw)),] <- stevia.lf.mal.simper.kw
simper.mal.time[(nrow(simper.mal.time)+1):(nrow(simper.mal.time)+nrow(stevia.sc.mal.simper.kw)),] <- stevia.sc.mal.simper.kw
simper.mal.time[(nrow(simper.mal.time)+1):(nrow(simper.mal.time)+nrow(stevia.tv.mal.simper.kw)),] <- stevia.tv.mal.simper.kw
simper.mal.time$fdr_krusk_p.val <- p.adjust(simper.mal.time$krusk_p.val, "BH")
#write.table(simper.mal.time, "simper.mal.time.csv", sep=",")






### Calculate mean rel abund for post-treatment (to double-check manually input #'s)
# Female
physeq.post.fem.relabund <- transform_sample_counts(physeq.post.fem, function(x){(x/sum(x))*100})
otu00002 <- subset_taxa(physeq.post.fem.relabund, Species == "Otu00002")
otu2 <- psmelt(otu00002)
otu2.sum <- otu2 %>%
  group_by(Treatment) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00003 <- subset_taxa(physeq.post.fem.relabund, Species == "Otu00003")
otu3 <- psmelt(otu00003)
otu3.sum <- otu3 %>%
  group_by(Treatment) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00004 <- subset_taxa(physeq.post.fem.relabund, Species == "Otu00004")
otu4 <- psmelt(otu00004)
otu4.sum <- otu4 %>%
  group_by(Treatment) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00006 <- subset_taxa(physeq.post.fem.relabund, Species == "Otu00006")
otu6 <- psmelt(otu00006)
otu6.sum <- otu6 %>%
  group_by(Treatment) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00008 <- subset_taxa(physeq.post.fem.relabund, Species == "Otu00008")
otu8 <- psmelt(otu00008)
otu8.sum <- otu8 %>%
  group_by(Treatment) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00010 <- subset_taxa(physeq.post.fem.relabund, Species == "Otu00010")
otu10 <- psmelt(otu00010)
otu10.sum <- otu10 %>%
  group_by(Treatment) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00012 <- subset_taxa(physeq.post.fem.relabund, Species == "Otu00012")
otu12 <- psmelt(otu00012)
otu12.sum <- otu12 %>%
  group_by(Treatment) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00014 <- subset_taxa(physeq.post.fem.relabund, Species == "Otu00014")
otu14 <- psmelt(otu00014)
otu14.sum <- otu14 %>%
  group_by(Treatment) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))

# Male
physeq.post.mal.relabund <- transform_sample_counts(physeq.post.mal, function(x){(x/sum(x))*100})
otu00002 <- subset_taxa(physeq.post.mal.relabund, Species == "Otu00002")
otu2 <- psmelt(otu00002)
otu2.sum <- otu2 %>%
  group_by(Treatment) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00004 <- subset_taxa(physeq.post.mal.relabund, Species == "Otu00004")
otu4 <- psmelt(otu00004)
otu4.sum <- otu4 %>%
  group_by(Treatment) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00010 <- subset_taxa(physeq.post.mal.relabund, Species == "Otu00010")
otu10 <- psmelt(otu00010)
otu10.sum <- otu10 %>%
  group_by(Treatment) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00012 <- subset_taxa(physeq.post.mal.relabund, Species == "Otu00012")
otu12 <- psmelt(otu00012)
otu12.sum <- otu12 %>%
  group_by(Treatment) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00014 <- subset_taxa(physeq.post.mal.relabund, Species == "Otu00014")
otu14 <- psmelt(otu00014)
otu14.sum <- otu14 %>%
  group_by(Treatment) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00018 <- subset_taxa(physeq.post.mal.relabund, Species == "Otu00018")
otu18 <- psmelt(otu00018)
otu18.sum <- otu18 %>%
  group_by(Treatment) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00033 <- subset_taxa(physeq.post.mal.relabund, Species == "Otu00033")
otu33 <- psmelt(otu00033)
otu33.sum <- otu33 %>%
  group_by(Treatment) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))





### Calculate mean rel abund for time comparison (to double-check manually input #'s)
# Female
physeq.fem.relabund <- transform_sample_counts(physeq.fem, function(x){(x/sum(x))*100})
otu00002 <- subset_taxa(physeq.fem.relabund, Species == "Otu00002")
otu2 <- psmelt(otu00002)
otu2.sum <- otu2 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00006 <- subset_taxa(physeq.fem.relabund, Species == "Otu00006")
otu6 <- psmelt(otu00006)
otu6.sum <- otu6 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00007 <- subset_taxa(physeq.fem.relabund, Species == "Otu00007")
otu7 <- psmelt(otu00007)
otu7.sum <- otu7 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00008 <- subset_taxa(physeq.fem.relabund, Species == "Otu00008")
otu8 <- psmelt(otu00008)
otu8.sum <- otu8 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00010 <- subset_taxa(physeq.fem.relabund, Species == "Otu00010")
otu10 <- psmelt(otu00010)
otu10.sum <- otu10 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00011 <- subset_taxa(physeq.fem.relabund, Species == "Otu00011")
otu11 <- psmelt(otu00011)
otu11.sum <- otu11 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00012 <- subset_taxa(physeq.fem.relabund, Species == "Otu00012")
otu12 <- psmelt(otu00012)
otu12.sum <- otu12 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00014 <- subset_taxa(physeq.fem.relabund, Species == "Otu00014")
otu14 <- psmelt(otu00014)
otu14.sum <- otu14 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00015 <- subset_taxa(physeq.fem.relabund, Species == "Otu00015")
otu15 <- psmelt(otu00015)
otu15.sum <- otu15 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00023 <- subset_taxa(physeq.fem.relabund, Species == "Otu00023")
otu23 <- psmelt(otu00023)
otu23.sum <- otu23 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))

# Male
physeq.mal.relabund <- transform_sample_counts(physeq.mal, function(x){(x/sum(x))*100})
otu00001 <- subset_taxa(physeq.mal.relabund, Species == "Otu00001")
otu1 <- psmelt(otu00001)
otu1.sum <- otu1 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00003 <- subset_taxa(physeq.mal.relabund, Species == "Otu00003")
otu3 <- psmelt(otu00003)
otu3.sum <- otu3 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00004 <- subset_taxa(physeq.mal.relabund, Species == "Otu00004")
otu4 <- psmelt(otu00004)
otu4.sum <- otu4 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00005 <- subset_taxa(physeq.mal.relabund, Species == "Otu00005")
otu5 <- psmelt(otu00005)
otu5.sum <- otu5 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00010 <- subset_taxa(physeq.mal.relabund, Species == "Otu00010")
otu10 <- psmelt(otu00010)
otu10.sum <- otu10 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00012 <- subset_taxa(physeq.mal.relabund, Species == "Otu00012")
otu12 <- psmelt(otu00012)
otu12.sum <- otu12 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00013 <- subset_taxa(physeq.mal.relabund, Species == "Otu00013")
otu13 <- psmelt(otu00013)
otu13.sum <- otu13 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00014 <- subset_taxa(physeq.mal.relabund, Species == "Otu00014")
otu14 <- psmelt(otu00014)
otu14.sum <- otu14 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00018 <- subset_taxa(physeq.mal.relabund, Species == "Otu00018")
otu18 <- psmelt(otu00018)
otu18.sum <- otu18 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
otu00033 <- subset_taxa(physeq.mal.relabund, Species == "Otu00033")
otu33 <- psmelt(otu00033)
otu33.sum <- otu33 %>%
  group_by(Treatment, Time) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance))
```



### SIMPER Heatmap
```{r}
### Prep Post-Treatment Female
physeq.simper.post.fem <- subset_taxa(physeq.post.fem, Species == "Otu00002" | Species == "Otu00003" | 
                                        Species == "Otu00004" | Species == "Otu00006" | Species == "Otu00008" |
                                        Species == "Otu00010" | Species == "Otu00012" | Species == "Otu00014")
physeq.simper.post.fem.tax <- data.frame(tax_table(physeq.simper.post.fem))
physeq.simper.post.fem.tax$Name <- c("Akkermansia", "Bacteroides", "S24-7", "S24-7", "Anaeroplasma",
                                     "Ruminiclostridium", "Lachnospiraceae", "Lactococcus")
physeq.simper.post.fem.tax <- tax_table(physeq.simper.post.fem.tax)
taxa_names(physeq.simper.post.fem.tax) <- taxa_names(physeq.simper.post.fem)
simper.post.fem.treat <- read.csv("Simper/Simper_OTU_post_fem.csv")
simper.post.fem.treat.hm <- simper.post.fem.treat
rownames(simper.post.fem.treat.hm) <- simper.post.fem.treat.hm$OTU
simper.post.fem.treat.hm <- simper.post.fem.treat.hm[,-1]
simper.post.fem.treat.hm <- simper.post.fem.treat.hm[,-5:-8]
simper.post.fem.sampdat <- data.frame(c("LowFat", "HighFat", "Saccharin", "Stevia"))
colnames(simper.post.fem.sampdat) <- "Treatment"
rownames(simper.post.fem.sampdat) <- simper.post.fem.sampdat$Treatment
physeq.simper.post.fem <- merge_phyloseq(otu_table(simper.post.fem.treat.hm, taxa_are_rows=T), physeq.simper.post.fem.tax, sample_data(simper.post.fem.sampdat))
colnames(tax_table(physeq.simper.post.fem)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species", "OTU_Classification")
#physeq.simper.post.fem <- transform_sample_counts(physeq.simper.post.fem, function(x){x*100})
sample_data(physeq.simper.post.fem)$Treatment <- ordered(sample_data(physeq.simper.post.fem)$Treatment,
                                                         levels=c("LowFat", "HighFat", "Saccharin", "Stevia"))




### Prep Post-Treatment Male
physeq.simper.post.mal <- subset_taxa(physeq.post.mal, Species == "Otu00002" | Species == "Otu00004" | 
                                        Species == "Otu00010" | Species == "Otu00012" | Species == "Otu00014" |
                                        Species == "Otu00018" | Species == "Otu00033")
physeq.simper.post.mal.tax <- data.frame(tax_table(physeq.simper.post.mal))
physeq.simper.post.mal.tax$Name <- c("Akkermansia", "S24-7", "Ruminiclostridium", "Lachnospiraceae", "Lactococcus",
                                     "Lactobacillus", "NK4A136")
physeq.simper.post.mal.tax <- tax_table(physeq.simper.post.mal.tax)
taxa_names(physeq.simper.post.mal.tax) <- taxa_names(physeq.simper.post.mal)
simper.post.mal.treat <- read.csv("Simper/Simper_OTU_post_mal.csv")
simper.post.mal.treat.hm <- simper.post.mal.treat
rownames(simper.post.mal.treat.hm) <- simper.post.mal.treat.hm$OTU
simper.post.mal.treat.hm <- simper.post.mal.treat.hm[,-1]
simper.post.mal.treat.hm <- simper.post.mal.treat.hm[,-5:-8]
simper.post.mal.sampdat <- data.frame(c("LowFat", "HighFat", "Saccharin", "Stevia"))
colnames(simper.post.mal.sampdat) <- "Treatment"
rownames(simper.post.mal.sampdat) <- simper.post.mal.sampdat$Treatment
physeq.simper.post.mal <- merge_phyloseq(otu_table(simper.post.mal.treat.hm, taxa_are_rows=T), physeq.simper.post.mal.tax, sample_data(simper.post.mal.sampdat))
colnames(tax_table(physeq.simper.post.mal)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species", "OTU_Classification")
#physeq.simper.post.mal <- transform_sample_counts(physeq.simper.post.mal, function(x){x*100})
sample_data(physeq.simper.post.mal)$Treatment <- ordered(sample_data(physeq.simper.post.mal)$Treatment,
                                                         levels=c("LowFat", "HighFat", "Saccharin", "Stevia"))








### HeatMap Post-Treatment
# http://www.roymfrancis.com/a-guide-to-elegant-tiled-heatmaps-in-r/
# https://github.com/tidyverse/ggplot2/pull/2541
post.fem.hm <- plot_heatmap(physeq.simper.post.fem, sample.label = "Treatment", sample.order = c("LowFat", "HighFat", "Saccharin", "Stevia"), taxa.label = "OTU_Classification", taxa.order = "Phylum") +
  geom_tile(colour="gray40") +
  geom_text(size=5, family="Arial", aes(label=sprintf("%0.2f", round(Abundance, digits=2)))) +
  scale_fill_gradientn(name=expression("Mean Relative\nAbundance\n(%)"), limits=c(0,24),
                         breaks=c(0,6,12,18,24), labels=c("0", "6", "12", "18", "24"),
                         colours = c("#ffffee", "#f4fdc3", "#e0fc9b", "#c2fd74", "#97fe4e", "#6dfa76",
                                     "#40f395", "#00ebaf", "#00d6dd", "#00bbff", "#0097ff", "#3f62ff")) +
  scale_x_discrete(labels = c("Low Fat", "High Fat", "Saccharin", "Stevia")) +
  scale_y_discrete(labels = c(expression(" "^A~italic("Bacteroides")), expression(" "^AC~"S24-7"), expression(" "^ABC~"S24-7"), expression(" "^AC~italic("Ruminiclostridium")), expression(" "^ABC~"Lachnospiraceae"), expression(" "^ACD~italic("Lactococcus")), expression(" "^ABC~italic("Anaeroplasma")), expression(" "^Bcd~italic("Akkermansia")))) +
  ylab("OTU Classification") + xlab("Female Post-treatment Group") +
  theme(panel.border=element_blank(),
        axis.text.x = element_text(angle=50, hjust=1, vjust=1.2, family="Arial", size=16),
        axis.text.y = element_text(family="Arial", size=16),
        axis.ticks.x=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_text(size=16, face="bold", family="Arial"),
        axis.title.y = element_text(margin = margin(t=0, r=0, b=0, l=0), size=16, face="bold", family="Arial"),
        axis.line=element_blank(),
        legend.title = element_text(family = "Arial", size=16, face="bold"),
        legend.text = element_text(family = "Arial", size=16),
        legend.margin = margin(t=0, r=-5, b=0, l=-8),
        plot.title = element_text(family = "Arial", size=16, face="bold")
  ) +
  guides(fill = guide_colorbar(barheight = unit(2, "in" ),
                               frame.colour="black",
                               frame.linewidth = 1))
         
         
post.mal.hm <- plot_heatmap(physeq.simper.post.mal, sample.label = "Treatment", sample.order = c("LowFat", "HighFat", "Saccharin", "Stevia"), taxa.label = "OTU_Classification", taxa.order = "Phylum") +
  geom_tile(colour="gray40") +
  geom_text(size=5, family="Arial", aes(label=sprintf("%0.2f", round(Abundance, digits=2)))) +
  scale_fill_gradientn(name=expression("Mean Relative\nAbundance\n(%)"), limits=c(0,13),
                         breaks=c(0, 3.25, 6.50, 9.75, 13), labels=c("0", "6", "12", "18", "24"),
                         colours = c("#ffffee", "#f4fdc3", "#e0fc9b", "#c2fd74", "#97fe4e", "#6dfa76",
                                     "#40f395", "#00ebaf", "#00d6dd", "#00bbff", "#0097ff", "#3f62ff")) +
  scale_x_discrete(labels = c("Low Fat", "High Fat", "Saccharin", "Stevia")) +
  scale_y_discrete(labels=c(expression(" "^abc~"S24-7"), expression(" "^abc~italic("Ruminiclostridium")), expression(" "^ac~"Lachnospiraceae"), expression(" "^abcd~italic("Lactococcus")), expression(" "^c~italic("Lactobacillus")), expression(" "^abc~italic("NK4A136")), expression(" "^bc~italic("Akkermansia")))) +
  ylab("OTU Classification") + xlab("Male Post-treatment Group") +
  theme(panel.border=element_blank(),
        axis.text.x = element_text(angle=50, hjust=1, vjust=1.2, family="Arial", size=16),
        axis.text.y = element_text(family="Arial", size=16),
        axis.ticks.x=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_text(size=16, face="bold", family="Arial"),
        axis.title.y = element_text(margin = margin(t=0, r=0, b=0, l=0), size=16, face="bold", family="Arial"),
        axis.line=element_blank(),
        legend.title = element_text(family = "Arial", size=16, face="bold"),
        legend.text = element_text(family = "Arial", size=16),
        legend.margin = margin(t=0, r=-5, b=0, l=-8),
        plot.title = element_text(family = "Arial", size=16, face="bold")
  ) +
  guides(fill = guide_colorbar(barheight = unit(2, "in" ),
                                frame.colour = "black",
                                frame.linewidth = 1))





### Prep Time - Females
physeq.simper.time.fem <- subset_taxa(physeq.pair, Species == "Otu00002" | Species == "Otu00006" | 
                                      Species == "Otu00007" | Species == "Otu00008" | Species == "Otu00010" | 
                                      Species == "Otu00011" | Species == "Otu00012" | Species == "Otu00014" |
                                      Species == "Otu00015" | Species == "Otu00023")
physeq.simper.time.fem.tax <- data.frame(tax_table(physeq.simper.time.fem))
physeq.simper.time.fem.tax$Name <- c("Akkermansia", "S24-7", "S24-7", "Anaeroplasma", "Ruminiclostridium", "S24-7",
                                     "Lachnospiraceae", "Lactococcus", "NK4A136", "Alistipes")
physeq.simper.time.fem.tax <- tax_table(physeq.simper.time.fem.tax)
taxa_names(physeq.simper.time.fem.tax) <- taxa_names(physeq.simper.time.fem)
simper.time.fem.treat <- read.csv("Simper/Simper_OTU_time_fem.csv")
simper.time.fem.treat.hm <- simper.time.fem.treat
rownames(simper.time.fem.treat.hm) <- simper.time.fem.treat.hm$OTU
simper.time.fem.treat.hm <- simper.time.fem.treat.hm[,-1]
simper.time.fem.treat.hm <- simper.time.fem.treat.hm[,-9:-12]
simper.time.fem.sampdat <- data.frame(c("LowFat_Pre", "LowFat_Post", "HighFat_Pre", "HighFat_Post", "Saccharin_Pre",
                                        "Saccharin_Post", "Stevia_Pre", "Stevia_Post"))
colnames(simper.time.fem.sampdat) <- "Treatment_Time"
rownames(simper.time.fem.sampdat) <- simper.time.fem.sampdat$Treatment_Time
physeq.simper.time.fem <- merge_phyloseq(otu_table(simper.time.fem.treat.hm, taxa_are_rows=T), physeq.simper.time.fem.tax, sample_data(simper.time.fem.sampdat))
colnames(tax_table(physeq.simper.time.fem)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species", "OTU_Classification")
#physeq.simper.time.fem <- transform_sample_counts(physeq.simper.time.fem, function(x){x*100})
sample_data(physeq.simper.time.fem)$Treatment_Time <- ordered(sample_data(physeq.simper.time.fem)$Treatment_Time,
                                                              levels=c("LowFat_Pre", "LowFat_Post", "HighFat_Pre",
                                                                       "HighFat_Post", "Saccharin_Pre",
                                                                       "Saccharin_Post", "Stevia_Pre",
                                                                       "Stevia_Post"))




### Prep Time - Males
physeq.simper.time.mal <- subset_taxa(physeq.pair, Species == "Otu00001" | Species == "Otu00003" | 
                                      Species == "Otu00004" | Species == "Otu00005" | Species == "Otu00010" |
                                      Species == "Otu00012" | Species == "Otu00013" | Species == "Otu00014" |
                                      Species == "Otu00018" | Species == "Otu00033" )
physeq.simper.time.mal.tax <- data.frame(tax_table(physeq.simper.time.mal))
physeq.simper.time.mal.tax$Name <- c("S24-7", "Bacteroides", "S24-7", "S24-7", "Ruminiclostridium",
                                     "Lachnospiraceae", "Lachnospiraceae", "Lactococcus", "Lactobacillus",
                                     "NK4A136")
physeq.simper.time.mal.tax <- tax_table(physeq.simper.time.mal.tax)
taxa_names(physeq.simper.time.mal.tax) <- taxa_names(physeq.simper.time.mal)
simper.time.mal.treat <- read.csv("Simper/Simper_OTU_time_mal.csv")
simper.time.mal.treat.hm <- simper.time.mal.treat
rownames(simper.time.mal.treat.hm) <- simper.time.mal.treat.hm$OTU
simper.time.mal.treat.hm <- simper.time.mal.treat.hm[,-1]
simper.time.mal.treat.hm <- simper.time.mal.treat.hm[,-9:-12]
simper.time.mal.sampdat <- data.frame(c("LowFat_Pre", "LowFat_Post", "HighFat_Pre", "HighFat_Post", "Saccharin_Pre",
                                        "Saccharin_Post", "Stevia_Pre", "Stevia_Post"))
colnames(simper.time.mal.sampdat) <- "Treatment_Time"
rownames(simper.time.mal.sampdat) <- simper.time.mal.sampdat$Treatment_Time
physeq.simper.time.mal <- merge_phyloseq(otu_table(simper.time.mal.treat.hm, taxa_are_rows=T), physeq.simper.time.mal.tax, sample_data(simper.time.mal.sampdat))
colnames(tax_table(physeq.simper.time.mal)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species", "OTU_Classification")
#physeq.simper.time.mal <- transform_sample_counts(physeq.simper.time.mal, function(x){x*100})
sample_data(physeq.simper.time.mal)$Treatment_Time <- ordered(sample_data(physeq.simper.time.mal)$Treatment_Time,
                                                              levels=c("LowFat_Pre", "LowFat_Post", "HighFat_Pre",
                                                                       "HighFat_Post", "Saccharin_Pre",
                                                                       "Saccharin_Post", "Stevia_Pre",
                                                                       "Stevia_Post"))









### HeatMap Time
# http://www.roymfrancis.com/a-guide-to-elegant-tiled-heatmaps-in-r/
# https://github.com/tidyverse/ggplot2/pull/2541
time.fem.hm <- plot_heatmap(physeq.simper.time.fem, sample.label = "Treatment_Time", 
                            sample.order = c("LowFat_Pre", "LowFat_Post", "HighFat_Pre", "HighFat_Post",
                                             "Saccharin_Pre","Saccharin_Post", "Stevia_Pre", "Stevia_Post"),
                            taxa.label = "OTU_Classification", taxa.order = "Phylum") +
  geom_tile(colour="gray40") +
  geom_text(size=5, family="Arial", aes(label=sprintf("%0.2f", round(Abundance, digits=2)))) +
  scale_fill_gradientn(name=expression("Mean Relative\nAbundance\n(%)"), limits=c(0,24),
                          breaks=c(0, 6, 12, 18, 24), labels=c("0", "6", "12", "18", "24"),
                         colours = c("#ffffee", "#f4fdc3", "#e0fc9b", "#c2fd74", "#97fe4e", "#6dfa76",
                                     "#40f395", "#00ebaf", "#00d6dd", "#00bbff", "#0097ff", "#3f62ff")) +
  scale_x_discrete(labels = c("Low Fat Pre", "Low Fat Post", "High Fat Pre", "High Fat Post",
                              "Saccharin Pre", "Saccharin Post", "Stevia Pre", "Stevia Post")) +
  scale_y_discrete(labels=c(expression(" "^BCD~"S24-7"), expression(" "^a~"S24-7"), expression(" "^aBCD~"S24-7"), expression(" "^A~italic("Alistipes")), expression(" "^BD~italic("Ruminiclostridium")), expression(" "^BCD~"Lachnospiraceae"), expression(" "^D~italic("Lactococcus")), expression(" "^ACD~italic("NK4A136")), expression(" "^BCD~italic("Anaeroplasma")), expression(" "^C~italic("Akkermansia")))) + 
  ylab("OTU Classification") + xlab("Female Group") +
  theme(panel.border=element_blank(),
        axis.text.x = element_text(angle=50, hjust=1.1, vjust=1.18, family="Arial", size=16, 
                                   margin = margin(t=0, r=0, b=0, l=0)),
        axis.text.y = element_text(family="Arial", size=16),
        axis.ticks.x=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_text(size=16, face="bold", family="Arial"),
        axis.title.y = element_text(margin = margin(t=0, r=0, b=0, l=0), size=16, face="bold", family="Arial"),
        axis.line=element_blank(),
        legend.title = element_text(family = "Arial", size=16, face="bold"),
        legend.text = element_text(family = "Arial", size=16),
        legend.margin = margin(t=0, r=-5, b=0, l=-8),
        plot.title = element_text(family = "Arial", size=16, face="bold")
  ) +
  guides(fill = guide_colorbar(barheight = unit(2, "in" ),
                                frame.colour = "black",
                                frame.linewidth = 1))


        

time.mal.hm <- plot_heatmap(physeq.simper.time.mal, sample.label = "Treatment_Time",
                            sample.order = c("LowFat_Pre", "LowFat_Post", "HighFat_Pre", "HighFat_Post",
                                             "Saccharin_Pre","Saccharin_Post", "Stevia_Pre", "Stevia_Post"),
                            taxa.label = "OTU_Classification", taxa.order = "Phylum") +
  geom_tile(colour="gray40") +
  geom_text(size=5, family="Arial", aes(label=sprintf("%0.2f", round(Abundance, digits=2)))) +
  scale_fill_gradientn(name=expression("Mean Relative\nAbundance\n(%)"), limits=c(0,21),
                           breaks=c(0, 5.25, 10.5, 15.75, 21), labels=c("0", "6", "12", "18", "24"),
                         colours = c("#ffffee", "#f4fdc3", "#e0fc9b", "#c2fd74", "#97fe4e", "#6dfa76",
                                     "#40f395", "#00ebaf", "#00d6dd", "#00bbff", "#0097ff", "#3f62ff")) +
  scale_x_discrete(labels = c("Low Fat Pre", "Low Fat Post", "High Fat Pre", "High Fat Post",
                              "Saccharin Pre", "Saccharin Post", "Stevia Pre", "Stevia Post")) +
  scale_y_discrete(labels=c(expression(" "^B~"S24-7"), expression(" "^aC~italic("Bacteroides")), 
                            expression(" "^BC~"S24-7"), expression(" "^BCD~"S24-7"), 
                            expression(" "^BCD~italic("Ruminiclostridium")), expression(" "^BD~"Lachnospiraceae"),
                            expression(" "^AD~"Lachnospiraceae"), expression(" "^BCD~italic("Lactococcus")),
                            expression(" "^D~italic("Lactobacillus")), expression(" "^A~italic("NK4A136")))) +
  ylab("OTU Classification") + xlab("Male Group") +
  theme(panel.border=element_blank(),
        axis.text.x = element_text(angle=50, hjust=1.1, vjust=1.18, family="Arial", size=16, 
                                   margin = margin(t=0, r=0, b=0, l=0)),
        axis.text.y = element_text(family="Arial", size=16),
        axis.ticks.x=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_text(size=16, face="bold", family="Arial"),
        axis.title.y = element_text(margin = margin(t=0, r=0, b=0, l=0), size=16, face="bold", family="Arial"),
        axis.line=element_blank(),
        legend.title = element_text(family = "Arial", size=16, face="bold"),
        legend.text = element_text(family = "Arial", size=16),
        legend.margin = margin(t=0, r=-5, b=0, l=-8),
        plot.title = element_text(family = "Arial", size=16, face="bold")
  ) +
  guides(fill = guide_colorbar(barheight = unit(2, "in" ),
                                frame.colour = "black",
                                frame.linewidth = 1))
```

### HeatMap Plots
```{r}
tiff("hm.tiff", width=336, height = 150, units="mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(2,2, heights=c(0.05,1.00)))))
grid.text("A", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=1),
          gp=gpar(fontsize=16,fontface="bold",fontfamily="Arial"))
print(post.fem.hm, vp=viewport(layout.pos.row=2, layout.pos.col=1))
grid.text("B", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=2),
          gp=gpar(fontsize=16,fontface="bold",fontfamily="Arial"))
print(post.mal.hm, vp=viewport(layout.pos.row=2, layout.pos.col=2))
dev.off()

tiff("hm.supp.tiff", width=336, height = 300, units="mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(4,1, heights=c(0.05,1.00,0.05,1.00)))))
grid.text("A", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=1),
          gp=gpar(fontsize=16,fontface="bold",fontfamily="Arial"))
print(time.fem.hm, vp=viewport(layout.pos.row=2, layout.pos.col=1))
grid.text("B", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=3, layout.pos.col=1),
          gp=gpar(fontsize=16,fontface="bold",fontfamily="Arial"))
print(time.mal.hm, vp=viewport(layout.pos.row=4, layout.pos.col=1))
dev.off()

```



