---
title: "Code"
author: "Edna Chiang"
date: "July 17, 2018"
output: html_document
---
### Load Libraries
```{r}
library(ape)
library(dplyr)
library(ggplot2)
library(gplots)
library(phangorn)
library(tidyr)
library(vegan)
library(phyloseq)
library(grid)
library(pgirmess)
theme_set(theme_bw())
set.seed(1)
```

### Load Functions
```{r}
veganCovEllipse <- function(cov, center = c(0, 0), scale = 1, npoints = 100) {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
}
```

### Import Data
```{r}
# Link files
shared = "mothur_outputs/final.shared"
taxonomy = "mothur_outputs/final.taxonomy"


# Import mothur data
mothurdata = import_mothur(
  mothur_shared_file = shared,
  mothur_constaxonomy_file = taxonomy)

# Add OTU column in taxonomy table
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
                               row.names(tax_table(mothurdata)))

# Rename taxonomy table columns
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")

```

### Explore mothurdata object
```{r}
samp.sum <- data.frame(colSums(otu_table(mothurdata)))
colnames(samp.sum) <- "Sample_TotalSeqs"
samp.sum$sample <- row.names(samp.sum)
samp.sum <- arrange(samp.sum, Sample_TotalSeqs)

ggplot(samp.sum, aes(x=reorder(sample, Sample_TotalSeqs), y=Sample_TotalSeqs)) +
  ylab("Number of Sequences per Sample") +
  geom_bar(stat="identity", colour="black", fill="cornflowerblue") +
  xlab("Sample Name") +
  ggtitle("Total Number of Sequences per Sample") + 
  theme(axis.text.x = element_text(colour = "black", size=6, angle=45,hjust = 1,
                                   vjust = 1))

ggplot(data.frame(sum = sample_sums(mothurdata)), aes(sum)) + 
  geom_histogram(colour = "white", fill = "blue", bins=60) + 
  ggtitle("Sample read counts") + 
  xlab("total sequences")


# Min, Mean, Max of sample read counts
min(sample_sums(mothurdata))
mean(sample_sums(mothurdata))
median(sample_sums(mothurdata))
max(sample_sums(mothurdata))
```


### Create Phyloseq Object
```{r}
meta <- read.csv("metadata.csv")
colnames(meta)[1] <- "Sample_ID"
rownames(meta) <- meta$Sample
meta$Time <- ordered(meta$Time, levels=c("Pre-treatment", "Post-treatment"))
divsum <- read.table("mothur_outputs/final.summary", header=T)


# Add in diversity summaries
meta[,7:17] <- divsum[,3:12]

# Create intermin phyloseq object
physeq <- merge_phyloseq(mothurdata, sample_data(meta))

#save(physeq, file="Physeq.RData")

# Subset out paired samples
physeq.pair <- subset_samples(physeq, Sample_ID != "HF8C")
physeq.pair <- subset_samples(physeq.pair, Sample_ID != "SC4A")
physeq.pair <- subset_samples(physeq.pair, Sample_ID != "TV2A")
physeq.pair <- subset_samples(physeq.pair, Sample_ID != "TV8A")
#save(physeq.pair, file="Physeq.pair.RData")

# Subset out Pre vs. Post
physeq.pre <- subset_samples(physeq.pair, Time == "Pre-treatment")
#save(physeq.pre, file="Physeq.pre.RData")
physeq.post <- subset_samples(physeq.pair, Time == "Post-treatment")
#save(physeq.post, file="Physeq.post.RData")

# Subset Post w/o Low Fat (due to skewing)
physeq.post.rem <- subset_samples(physeq.post, Treatment != "Low Fat")
#save(physeq.post.rem, file="Physeq.post.rem.RData")

# Subset out Female vs. Male
physeq.fem <- subset_samples(physeq.pair, Sex == "Female")
#save(physeq.fem, file="Physeq.fem.RData")
physeq.mal <- subset_samples(physeq.pair, Sex == "Male")
#save(physeq.mal, file="Physeq.mal.RData")

# Subset out Sex + Time
physeq.pre.fem <- subset_samples(physeq.pre, Sex == "Female")
#save(physeq.pre.fem, file="Physeq.pre.fem.RData")
physeq.pre.mal <- subset_samples(physeq.pre, Sex == "Male")
#save(physeq.pre.mal, file="Physeq.pre.mal.RData")
physeq.post.fem <- subset_samples(physeq.post, Sex == "Female")
#save(physeq.post.fem, file="Physeq.post.fem.RData")
physeq.post.mal <- subset_samples(physeq.post, Sex == "Male")
#save(physeq.post.mal, file="Physeq.post.mal.RData")

# Remove Low Fat from Sex + Post subsets
physeq.post.fem.rem <- subset_samples(physeq.post.fem, Treatment != "Low Fat")
#save(physeq.post.fem.rem, file="Physeq.post.fem.rem.RData")
physeq.post.mal.rem <- subset_samples(physeq.post.mal, Treatment != "Low Fat")
#save(physeq.post.mal.rem, file="Physeq.post.mal.rem.RData")
```

### Load Phyloseq Object
```{r}
load("Physeq.RData")
load("Physeq.pair.RData")
load("Physeq.pre.RData")
load("Physeq.post.RData")
load("Physeq.post.rem.RData")
load("Physeq.fem.RData")
load("Physeq.mal.RData")
load("Physeq.pre.fem.RData")
load("Physeq.pre.mal.RData")
load("Physeq.post.fem.RData")
load("Physeq.post.mal.RData")
load("Physeq.post.fem.rem.RData")
load("Physeq.post.mal.rem.RData")

```

### Alpha Div
```{r}
adiv <- data.frame(sample_data(physeq))
adiv.pair <- data.frame(sample_data(physeq.pair))

### Coverage
# Plot
ggplot(adiv.pair, aes(x=Treatment, y= coverage, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  xlab("Treatment") +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  ylab("Coverage")
# Test normality
hist(adiv.pair$coverage, breaks=10)
qqnorm(adiv.pair$coverage)
qqline(adiv.pair$coverage)
shapiro.test(adiv.pair$coverage)
  # p-value = 0.003709
  # Not normal


### Total OTUs
otu.tot <- data.frame(sample_names(physeq.pair))
# Pull out # of OTUs from all samples
otu.tot$Total_OTUs <- rep("NA", 72)
for(i in 1:72){
  otu.tot[i,2] <- length(which(otu_table(mothurdata)[,i] != 0))
}
adiv.pair$Total_OTUs <- otu.tot$Total_OTUs
adiv.pair$Total_OTUs <- as.numeric(adiv.pair$Total_OTUs)
adiv.pair.pre <- adiv.pair[which(adiv.pair$Time == "Pre-treatment"),]
adiv.pair.post <- adiv.pair[which(adiv.pair$Time == "Post-treatment"),]
# Plot
ggplot(adiv.pair, aes(x=Treatment, y=Total_OTUs, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  xlab("Treatment") +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  ylab("Total OTUs")
# Test normality
hist(adiv.pair$Total_OTUs, breaks=10)
qqnorm(adiv.pair$Total_OTUs)
qqline(adiv.pair$Total_OTUs)
shapiro.test(adiv.pair$Total_OTUs)
  # p-value = 0.002107
  # Not normal
# Stats
kruskal.test(formula = Total_OTUs ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # All Pre-treatment
  # p-value = 0.003924
kruskalmc(resp = Total_OTUs ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Significant:  
      # Low fat - saccharin
kruskal.test(formula = Total_OTUs ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # All Post-treatment
  # p-value = 0.009035
kruskalmc(resp = Total_OTUs ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Significant:
    # High Fat - Low Fat
#friedman.test(formula = Total_OTUs ~ Treatment | Time, data = adiv.pair)
wilcox.test(Total_OTUs ~ Time, data=adiv.pair, paired=T)
  # p-value = 0.5245
wilcox.test(Total_OTUs ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 0.6015
wilcox.test(Total_OTUs ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.1589


### Chao
# Plot
tiff("Chao.tiff", width=6.5, height=3, units="in", res=600)
ggplot(adiv.pair, aes(x=Treatment, y=chao, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  xlab("Treatment") +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  ylab("Chao Richness")
dev.off()
# Test normality
hist(adiv.pair$chao, breaks=10)
qqnorm(adiv.pair$chao)
qqline(adiv.pair$chao)
shapiro.test(adiv.pair$chao)
  # p-value = 5.717e-05
  # Not normal
# Stats
kruskal.test(formula = chao ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # All Pre-treatment
  # p-value = 0.4731
kruskal.test(formula = chao ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # All Post-treatment
  # p-value = 0.0003939
kruskalmc(resp = chao ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Significant:
    # High Fat - Low Fat
    # Low Fat - Saccharin
#friedman.test(formula = chao ~ Treatment | Time, data = adiv.pair)
wilcox.test(chao ~ Time, data=adiv.pair, paired=T)
  # p-value = 0.02096
wilcox.test(chao ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "High Fat"),], paired=T)
  # High Fat
  # p-value = 0.003906
wilcox.test(chao ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Low Fat"),], paired=T)
  # Low Fat
  # p-value = 0.4316
wilcox.test(chao ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Saccharin"),], paired=T)
  # Saccharin
  # p-value = 0.07422
wilcox.test(chao ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Stevia"),], paired=T)
  # p-value = 0.3125
wilcox.test(chao ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 1
wilcox.test(chao ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.8147


### Berger-Parker
# Plot
ggplot(adiv.pair, aes(x=Treatment, y=bergerparker, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  xlab("Treatment") +
  ylab("Berger-Parker")
# Test normality
hist(adiv.pair$bergerparker, breaks=10)
qqnorm(adiv.pair$bergerparker)
qqline(adiv.pair$bergerparker)
shapiro.test(adiv.pair$bergerparker)
  # p-value = 0.00269
  # Not normal
# Stats
kruskal.test(formula = bergerparker ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # All Pre-treatment
  # p-value = 0.1931
kruskal.test(formula = bergerparker ~ Treatment, data=adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # All Post-treatment
  # p-value = 0.2489
#friedman.test(formula = bergerparker ~ Treatment | Time, data = adiv.pair)
wilcox.test(bergerparker ~ Time, data=adiv.pair, paired=T)
  # p-value = 0.01098
wilcox.test(bergerparker ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "High Fat"),], paired=T)
  # High Fat
  # p-value = 0.07422
wilcox.test(bergerparker ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Low Fat"),], paired=T)
  # Low Fat
  # p-value = 0.1934
wilcox.test(bergerparker ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Saccharin"),], paired=T)
  # Saccharin
  # p-value = 0.8203
wilcox.test(bergerparker ~ Time, data=adiv.pair[which(adiv.pair$Treatment == "Stevia"),], paired=T)
  # p-value = 0.1484
wilcox.test(bergerparker ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 0.6279
wilcox.test(bergerparker ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.006402
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Female"),], paired=T)
  # Female High Fat Time
  # p-value = 0.375
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Male"),], paired=T)
  # Male High Fat Time
  # p-value = 0.3125
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Female"),], paired=T)
  # Female Low Fat Time
  # p-value = 0.1875
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Male"),], paired=T)
  # Male Low Fat Time
  # p-value = 0.8125
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Female"),], paired=T)
  # Female Saccharin Time
  # p-value = 0.125
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Male"),], paired=T)
  # Male Saccharin Time
  # p-value = 1
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Female"),], paired=T)
  # Female Stevia Time
  # p-value = 0.625
wilcox.test(bergerparker ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Male"),], paired=T)
  # Male Stevia Time
  # p-value = 0.375


### Shannon
# Plot
ggplot(adiv.pair, aes(x=Treatment, y=shannon, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  xlab("Treatment") +
  ylab("Shannon Diversity")
# Test normality
hist(adiv.pair$shannon, breaks=10)
qqnorm(adiv.pair$shannon)
qqline(adiv.pair$shannon)
shapiro.test(adiv.pair$shannon)
  # p-value = 0.5704
  # Normal
# Stats
summary(aov(shannon ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),]))
  # Pre-treatment
  # P-value = 0.589
summary(aov(shannon ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),]))
  # Post-treatment
  # P-value = 0.043
TukeyHSD(aov(shannon ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),]))
  # Post-treamtent Significance:
    # Saccharin - Low Fat
t.test(shannon ~ Time, data = adiv.pair, paired=T)
  # p-value = 0.9899
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "High Fat"),], paired=T)
  # High Fat
  # p-value = 0.9751
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Low Fat"),], paired=T)
  # Low Fat
  # p-value = 0.03614
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Saccharin"),], paired=T)
  # Saccharin
  # p-value = 0.192
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Stevia"),], paired=T)
  # Stevia
  # p-value = 0.1537
t.test(shannon ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 0.6813
t.test(shannon ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.01769
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Female"),], paired=T)
  # Female High Fat Time
  # p-value = 0.4814
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Male"),], paired=T)
  # Male High Fat Time
  # p-value = 0.05131
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Female"),], paired=T)
  # Female Low Fat Time
  # p-value = 0.11
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Male"),], paired=T)
  # Male Low Fat Time
  # p-value = 0.2679
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Female"),], paired=T)
  # Female Saccharin Time
  # p-value = 0.1392
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Male"),], paired=T)
  # Male Saccharin Time
  # p-value = 0.2168
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Female"),], paired=T)
  # Female Stevia Time
  # p-value = 0.5392
t.test(shannon ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Male"),], paired=T)
  # Male Stevia Time
  # p-value = 0.05621

### Inverse Simpson
# Plot
tiff("InvSimp.tiff", width=6.5, height=3, units="in", res=600)
ggplot(adiv.pair, aes(x=Treatment, y= invsimpson, fill = Treatment)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Time) +
  scale_fill_manual(values=c("indianred1", "orange", "springgreen3", "deepskyblue2")) +
  xlab("Treatment") +
  ylab("Inverse Simpson Weighted Diversity")
dev.off()
# Test normality
hist(adiv.pair$invsimpson, breaks=10)
qqnorm(adiv.pair$invsimpson)
qqline(adiv.pair$invsimpson)
shapiro.test(adiv.pair$invsimpson)
  # p-value = 0.2751
  # Normal
# Stats
summary(aov(invsimpson ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),]))
  # Pre-treatment
  # P-value = 0.323
summary(aov(invsimpson ~ Treatment, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),]))
  # Post-treatment
t.test(invsimpson ~ Time, data = adiv.pair, paired=T)
  # p-value = 0.09364
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "High Fat"),], paired=T)
  # High Fat
  # p-value = 0.2415
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Low Fat"),], paired=T)
  # Low Fat
  # p-value = 0.0852
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Saccharin"),], paired=T)
  # Saccharin
  # p-value = 0.9167
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair$Treatment == "Stevia"),], paired=T)
  # Stevia
  # p-value = 0.7599
t.test(invsimpson ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Pre-treatment"),])
  # Pre-treatment Sex
  # p-value = 0.9731
t.test(invsimpson ~ Sex, data = adiv.pair[which(adiv.pair$Time == "Post-treatment"),])
  # Post-treatment Sex
  # p-value = 0.001503
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Female"),], paired=T)
  # Female High Fat Time
  # p-value = 0.5901
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "High Fat"),]$Sex == "Male"),], paired=T)
  # Male High Fat Time
  # p-value = 0.1063
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Female"),], paired=T)
  # Female Low Fat Time
  # p-value = 0.1735
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Low Fat"),]$Sex == "Male"),], paired=T)
  # Male Low Fat Time
  # p-value = 0.3996
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Female"),], paired=T)
  # Female Saccharin Time
  # p-value = 0.1378
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Saccharin"),]$Sex == "Male"),], paired=T)
  # Male Saccharin Time
  # p-value = 0.4341
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Female"),], paired=T)
  # Female Stevia Time
  # p-value = 0.6195
t.test(invsimpson ~ Time, data = adiv.pair[which(adiv.pair[which(adiv.pair$Treatment == "Stevia"),]$Sex == "Male"),], paired=T)
  # Male Stevia Time
  # p-value = 0.0892

```


### Examine Phyla
```{r}
# Merge samples with the same taxonomic rank
goodphy <- tax_glom(physeq.pair, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99 <- transform_sample_counts(goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <0.1% rel abund
phy99 <- prune_taxa(taxa_sums(phy99) > 0.01, phy99)

# Create rank abundance of phyla
barplot(sort(taxa_sums(phy99),TRUE)[1:20]/nsamples(phy99),las=2,cex.axis=.7)


# Summarize data
phy.df <- psmelt(phy99)
phy.df$Phylum <- ordered(phy.df$Phylum, levels=c("Firmicutes", "Bacteroidetes", "Verrucomicrobia", "Tenericutes", "Proteobacteria", "Actinobacteria", "Unclassified", "Cyanobacteria"))
phy.df$Phylum[which(is.na(phy.df$Phylum))] <- rep("Unclassified",length(which(is.na(phy.df$Phylum))))
phy.sum <- phy.df %>%
  group_by(Treatment, Time, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))

# Calculate IQR limits
phy.sum$iqr.min <- phy.sum$Median - 0.5*phy.sum$iqr
phy.sum[which(phy.sum$iqr.min < 0),10] <- 0
  # Any IQR min < 0, change to 0 (otherwise error bar won't plot)
phy.sum$iqr.max <- phy.sum$Median + 0.5*phy.sum$iqr


### Barplot ###
tiff("phyla.facet.tiff", width = 13, height = 8, units = "in", res = 300)
ggplot(phy.sum, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  facet_grid(Time ~ Treatment) +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 0.01%") +
  scale_y_continuous(limits=c(0,80), expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        panel.spacing=unit(1, "lines"),
        axis.title = element_text(size=20),
        strip.text.x = element_text(size=14),
        strip.text.y = element_text(size=14),
        axis.text.y = element_text(size=12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size=12))
dev.off()


### Testing barplot for sex + treatment + time
test <- phy.df %>%
  group_by(Treatment, Time, Sex, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))
test$iqr.min <- test$Median - 0.5*test$iqr
test[which(test$iqr.min < 0),10] <- 0
  # Any IQR min < 0, change to 0 (otherwise error bar won't plot)
test$iqr.max <- test$Median + 0.5*test$iqr
ggplot(test, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  facet_grid(Time + Sex ~ Treatment) +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 0.01%") +
  scale_y_continuous(limits=c(0,80), expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        panel.spacing=unit(1, "lines"),
        axis.title = element_text(size=20),
        strip.text.x = element_text(size=14),
        strip.text.y = element_text(size=14),
        axis.text.y = element_text(size=12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size=12))
test <- phy.df %>%
  group_by(Time, Sex, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))
test$iqr.min <- test$Median - 0.5*test$iqr
test[which(test$iqr.min < 0),10] <- 0
  # Any IQR min < 0, change to 0 (otherwise error bar won't plot)
test$iqr.max <- test$Median + 0.5*test$iqr
ggplot(test, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  facet_grid(Time~ Sex) +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 0.01%") +
  scale_y_continuous(limits=c(0,80), expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        panel.spacing=unit(1, "lines"),
        axis.title = element_text(size=20),
        strip.text.x = element_text(size=14),
        strip.text.y = element_text(size=14),
        axis.text.y = element_text(size=12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size=12))
```

### Bray-Curtis
```{r}
### Paired
bray.nmds <- ordinate(physeq=physeq.pair, method="NMDS", distance="bray")
  # stress = 8.822573e-05

plot_ordination(physeq=physeq.pair, ordination=bray.nmds, color="Treatment", shape="Time") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))

### Pre-treatment
bray.nmds.pre <- ordinate(physeq=physeq.pre, method="NMDS", distance="bray")
  # stress = 0.1847002 
plot_ordination(physeq=physeq.pre, ordination=bray.nmds.pre, color="Treatment", shape="Sex") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))



# Treatment Ellipses
sample_data(physeq.pre)$Elip.treat <- paste(sample_data(physeq.pre)$Treatment)
elip.nmds.pre.treat <- data.frame(MDS1 = bray.nmds.pre$points[,1], MDS2 = bray.nmds.pre$points[,2],
                        Group = sample_data(physeq.pre)$Elip.treat)
plot.new()
elip.ord.pre.treat <- ordiellipse(bray.nmds.pre, sample_data(physeq.pre)$Elip.treat, display="sites", kind="se", conf=0.95, label=T)
elip.pre.treat.df <- data.frame()
for(i in levels(elip.nmds.pre.treat$Group)){
  elip.pre.treat.df <- rbind(elip.pre.treat.df, cbind(as.data.frame(with(elip.nmds.pre.treat[elip.nmds.pre.treat$Group==i,],
                                                     veganCovEllipse(elip.ord.pre.treat[[i]]$cov,
                                                                     elip.ord.pre.treat[[i]]$center,
                                                                     elip.ord.pre.treat[[i]]$scale))),
                                  group=i))
  
}

# Plot w/ treatment ellip
plot_ordination(physeq=physeq.pre, ordination=bray.nmds.pre, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.pre.treat.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)

# Sex Ellipses
sample_data(physeq.pre)$Elip.sex <- paste(sample_data(physeq.pre)$Sex)
elip.nmds.pre.sex <- data.frame(MDS1 = bray.nmds.pre$points[,1], MDS2 = bray.nmds.pre$points[,2],
                        Group = sample_data(physeq.pre)$Elip.sex)
plot.new()
elip.ord.pre.sex <- ordiellipse(bray.nmds.pre, sample_data(physeq.pre)$Elip.sex, display="sites", kind="se", conf=0.95, label=T)
elip.pre.sex.df <- data.frame()
for(i in levels(elip.nmds.pre.sex$Group)){
  elip.pre.sex.df <- rbind(elip.pre.sex.df, cbind(as.data.frame(with(elip.nmds.pre.sex[elip.nmds.pre.sex$Group==i,],
                                                     veganCovEllipse(elip.ord.pre.sex[[i]]$cov,
                                                                     elip.ord.pre.sex[[i]]$center,
                                                                     elip.ord.pre.sex[[i]]$scale))),
                                  group=i))
}

# Plot w/ sex ellip
plot_ordination(physeq=physeq.pre, ordination=bray.nmds.pre, color="Sex") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.pre.sex.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)



### Post-treatment
bray.nmds.post <- ordinate(physeq=physeq.post, method="NMDS", distance="bray")
  # stress = 8.927466e-05

plot_ordination(physeq=physeq.post, ordination=bray.nmds.post, color="Treatment", shape="Sex") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))



### Post-treatment w/o Low Fat
bray.nmds.post.rem <- ordinate(physeq=physeq.post.rem, method="NMDS", distance="bray")
  # stress = 0.2067552

plot_ordination(physeq=physeq.post.rem, ordination=bray.nmds.post.rem, color="Treatment", shape="Sex") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))

# Treatment Ellipses
sample_data(physeq.post.rem)$Elip.treat <- paste(sample_data(physeq.post.rem)$Treatment)
elip.nmds.post.rem.treat <- data.frame(MDS1 = bray.nmds.post.rem$points[,1], MDS2 = bray.nmds.post.rem$points[,2],
                        Group = sample_data(physeq.post.rem)$Elip.treat)
plot.new()
elip.ord.post.rem.treat <- ordiellipse(bray.nmds.post.rem, sample_data(physeq.post.rem)$Elip.treat, display="sites", kind="se", conf=0.95, label=T)
elip.post.rem.treat.df <- data.frame()
for(i in levels(elip.nmds.post.rem.treat$Group)){
  elip.post.rem.treat.df <- rbind(elip.post.rem.treat.df, cbind(as.data.frame(with(elip.nmds.post.rem.treat[elip.nmds.post.rem.treat$Group==i,],
                                                     veganCovEllipse(elip.ord.post.rem.treat[[i]]$cov,
                                                                     elip.ord.post.rem.treat[[i]]$center,
                                                                     elip.ord.post.rem.treat[[i]]$scale))),
                                  group=i))
  
}

# Plot w/ treatment ellip
plot_ordination(physeq=physeq.post.rem, ordination=bray.nmds.post.rem, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.post.rem.treat.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)

# Sex Ellipses
sample_data(physeq.post.rem)$Elip.sex <- paste(sample_data(physeq.post.rem)$Sex)
elip.nmds.post.rem.sex <- data.frame(MDS1 = bray.nmds.post.rem$points[,1], MDS2 = bray.nmds.post.rem$points[,2],
                        Group = sample_data(physeq.post.rem)$Elip.sex)
plot.new()
elip.ord.post.rem.sex <- ordiellipse(bray.nmds.post.rem, sample_data(physeq.post.rem)$Elip.sex, display="sites", kind="se", conf=0.95, label=T)
elip.post.rem.sex.df <- data.frame()
for(i in levels(elip.nmds.post.rem.sex$Group)){
  elip.post.rem.sex.df <- rbind(elip.post.rem.sex.df, cbind(as.data.frame(with(elip.nmds.post.rem.sex[elip.nmds.post.rem.sex$Group==i,],
                                                     veganCovEllipse(elip.ord.post.rem.sex[[i]]$cov,
                                                                     elip.ord.post.rem.sex[[i]]$center,
                                                                     elip.ord.post.rem.sex[[i]]$scale))),
                                  group=i))
}

# Plot w/ sex ellip
plot_ordination(physeq=physeq.post.rem, ordination=bray.nmds.post.rem, color="Sex") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.post.rem.sex.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)



### All Female
bray.nmds.fem <- ordinate(physeq=physeq.fem, method="NMDS", distance="bray")
  # stress = 8.77398e-05

plot_ordination(physeq=physeq.fem, ordination=bray.nmds.fem, color="Treatment", shape="Time") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))



### All Male
bray.nmds.mal <- ordinate(physeq=physeq.mal, method="NMDS", distance="bray")
  # stress = 8.193224e-05 

plot_ordination(physeq=physeq.mal, ordination=bray.nmds.mal, color="Treatment", shape="Time") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  scale_shape_manual(values=c(19,2))



### Pre Female
bray.nmds.pre.fem <- ordinate(physeq=physeq.pre.fem, method="NMDS", distance="bray")
  # stress = 0.1965918 

plot_ordination(physeq=physeq.pre.fem, ordination=bray.nmds.pre.fem, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))

# Treatment Ellipses
sample_data(physeq.pre.fem)$Elip.treat <- paste(sample_data(physeq.pre.fem)$Treatment)
elip.nmds.pre.fem.treat <- data.frame(MDS1 = bray.nmds.pre.fem$points[,1], MDS2 = bray.nmds.pre.fem$points[,2],
                        Group = sample_data(physeq.pre.fem)$Elip.treat)
plot.new()
elip.ord.pre.fem.treat <- ordiellipse(bray.nmds.pre.fem, sample_data(physeq.pre.fem)$Elip.treat, display="sites", kind="se", conf=0.95, label=T)
elip.pre.fem.treat.df <- data.frame()
for(i in levels(elip.nmds.pre.fem.treat$Group)){
  elip.pre.fem.treat.df <- rbind(elip.pre.fem.treat.df, cbind(as.data.frame(with(elip.nmds.pre.fem.treat[elip.nmds.pre.fem.treat$Group==i,],
                                                     veganCovEllipse(elip.ord.pre.fem.treat[[i]]$cov,
                                                                     elip.ord.pre.fem.treat[[i]]$center,
                                                                     elip.ord.pre.fem.treat[[i]]$scale))),
                                  group=i))
}

# Plot w/ treatment ellip
plot_ordination(physeq=physeq.pre.fem, ordination=bray.nmds.pre.fem, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.pre.fem.treat.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)



### Pre Male
bray.nmds.pre.mal <- ordinate(physeq=physeq.pre.mal, method="NMDS", distance="bray")
  # stress = 0.1949269 
  # NO CONVERGENCE!!!

plot_ordination(physeq=physeq.pre.mal, ordination=bray.nmds.pre.mal, color="Treatment") #+
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))

# Treatment Ellipses
sample_data(physeq.pre.mal)$Elip.treat <- paste(sample_data(physeq.pre.mal)$Treatment)
elip.nmds.pre.mal.treat <- data.frame(MDS1 = bray.nmds.pre.mal$points[,1], MDS2 = bray.nmds.pre.mal$points[,2],
                        Group = sample_data(physeq.pre.mal)$Elip.treat)
plot.new()
elip.ord.pre.mal.treat <- ordiellipse(bray.nmds.pre.mal, sample_data(physeq.pre.mal)$Elip.treat, display="sites", kind="se", conf=0.95, label=T)
elip.pre.mal.treat.df <- data.frame()
for(i in levels(elip.nmds.pre.mal.treat$Group)){
  elip.pre.mal.treat.df <- rbind(elip.pre.mal.treat.df, cbind(as.data.frame(with(elip.nmds.pre.mal.treat[elip.nmds.pre.mal.treat$Group==i,],
                                                     veganCovEllipse(elip.ord.pre.mal.treat[[i]]$cov,
                                                                     elip.ord.pre.mal.treat[[i]]$center,
                                                                     elip.ord.pre.mal.treat[[i]]$scale))),
                                  group=i))
}

# Plot w/ treatment ellip
plot_ordination(physeq=physeq.pre.mal, ordination=bray.nmds.pre.mal, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.pre.mal.treat.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)


### Post Female
bray.nmds.post.fem <- ordinate(physeq=physeq.post.fem, method="NMDS", distance="bray")
  # stress = 8.335943e-05

plot_ordination(physeq=physeq.post.fem, ordination=bray.nmds.post.fem, color="Treatment") #+
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))

# Treatment Ellipses
sample_data(physeq.post.fem)$Elip.treat <- paste(sample_data(physeq.post.fem)$Treatment)
elip.nmds.post.fem.treat <- data.frame(MDS1 = bray.nmds.post.fem$points[,1], MDS2 = bray.nmds.post.fem$points[,2],
                        Group = sample_data(physeq.post.fem)$Elip.treat)
plot.new()
elip.ord.post.fem.treat <- ordiellipse(bray.nmds.post.fem, sample_data(physeq.post.fem)$Elip.treat, display="sites", kind="se", conf=0.95, label=T)
elip.post.fem.treat.df <- data.frame()
for(i in levels(elip.nmds.post.fem.treat$Group)){
  elip.post.fem.treat.df <- rbind(elip.post.fem.treat.df, cbind(as.data.frame(with(elip.nmds.post.fem.treat[elip.nmds.post.fem.treat$Group==i,],
                                                     veganCovEllipse(elip.ord.post.fem.treat[[i]]$cov,
                                                                     elip.ord.post.fem.treat[[i]]$center,
                                                                     elip.ord.post.fem.treat[[i]]$scale))),
                                  group=i))
}

# Plot w/ treatment ellip
plot_ordination(physeq=physeq.post.fem, ordination=bray.nmds.post.fem, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.post.fem.treat.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)


### Post Male
bray.nmds.post.mal <- ordinate(physeq=physeq.post.mal, method="NMDS", distance="bray")
  # stress = 8.658975e-05 

plot_ordination(physeq=physeq.post.mal, ordination=bray.nmds.post.mal, color="Treatment") #+
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))

# Treatment Ellipses
sample_data(physeq.post.mal)$Elip.treat <- paste(sample_data(physeq.post.mal)$Treatment)
elip.nmds.post.mal.treat <- data.frame(MDS1 = bray.nmds.post.mal$points[,1], MDS2 = bray.nmds.post.mal$points[,2],
                        Group = sample_data(physeq.post.mal)$Elip.treat)
plot.new()
elip.ord.post.mal.treat <- ordiellipse(bray.nmds.post.mal, sample_data(physeq.post.mal)$Elip.treat, display="sites", kind="se", conf=0.95, label=T)
elip.post.mal.treat.df <- data.frame()
for(i in levels(elip.nmds.post.mal.treat$Group)){
  elip.post.mal.treat.df <- rbind(elip.post.mal.treat.df, cbind(as.data.frame(with(elip.nmds.post.mal.treat[elip.nmds.post.mal.treat$Group==i,],
                                                     veganCovEllipse(elip.ord.post.mal.treat[[i]]$cov,
                                                                     elip.ord.post.mal.treat[[i]]$center,
                                                                     elip.ord.post.mal.treat[[i]]$scale))),
                                  group=i))
}

# Plot w/ treatment ellip
plot_ordination(physeq=physeq.post.mal, ordination=bray.nmds.post.mal, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.post.mal.treat.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)



### Post Female w/o Low Fat
bray.nmds.post.fem.rem <- ordinate(physeq=physeq.post.fem.rem, method="NMDS", distance="bray")
  # stress = 0.169206 

plot_ordination(physeq=physeq.post.fem.rem, ordination=bray.nmds.post.fem.rem, color="Treatment") #+
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))

# Treatment Ellipses
sample_data(physeq.post.fem.rem)$Elip.treat <- paste(sample_data(physeq.post.fem.rem)$Treatment)
elip.nmds.post.fem.rem.treat <- data.frame(MDS1 = bray.nmds.post.fem.rem$points[,1], MDS2 = bray.nmds.post.fem.rem$points[,2],
                        Group = sample_data(physeq.post.fem.rem)$Elip.treat)
plot.new()
elip.ord.post.fem.rem.treat <- ordiellipse(bray.nmds.post.fem.rem, sample_data(physeq.post.fem.rem)$Elip.treat, display="sites", kind="se", conf=0.95, label=T)
elip.post.fem.rem.treat.df <- data.frame()
for(i in levels(elip.nmds.post.fem.rem.treat$Group)){
  elip.post.fem.rem.treat.df <- rbind(elip.post.fem.rem.treat.df, cbind(as.data.frame(with(elip.nmds.post.fem.rem.treat[elip.nmds.post.fem.rem.treat$Group==i,],
                                                     veganCovEllipse(elip.ord.post.fem.rem.treat[[i]]$cov,
                                                                     elip.ord.post.fem.rem.treat[[i]]$center,
                                                                     elip.ord.post.fem.rem.treat[[i]]$scale))),
                                  group=i))
}

# Plot w/ treatment ellip
plot_ordination(physeq=physeq.post.fem.rem, ordination=bray.nmds.post.fem.rem, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.post.fem.rem.treat.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)



### Post Male w/o Low Fat
bray.nmds.post.mal.rem <- ordinate(physeq=physeq.post.mal.rem, method="NMDS", distance="bray")
  # stress = 0.160679

plot_ordination(physeq=physeq.post.mal.rem, ordination=bray.nmds.post.mal.rem, color="Treatment") #+
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00"))

# Treatment Ellipses
sample_data(physeq.post.mal.rem)$Elip.treat <- paste(sample_data(physeq.post.mal.rem)$Treatment)
elip.nmds.post.mal.rem.treat <- data.frame(MDS1 = bray.nmds.post.mal.rem$points[,1], MDS2 = bray.nmds.post.mal.rem$points[,2],
                        Group = sample_data(physeq.post.mal.rem)$Elip.treat)
plot.new()
elip.ord.post.mal.rem.treat <- ordiellipse(bray.nmds.post.mal.rem, sample_data(physeq.post.mal.rem)$Elip.treat, display="sites", kind="se", conf=0.95, label=T)
elip.post.mal.rem.treat.df <- data.frame()
for(i in levels(elip.nmds.post.mal.rem.treat$Group)){
  elip.post.mal.rem.treat.df <- rbind(elip.post.mal.rem.treat.df, cbind(as.data.frame(with(elip.nmds.post.mal.rem.treat[elip.nmds.post.mal.rem.treat$Group==i,],
                                                     veganCovEllipse(elip.ord.post.mal.rem.treat[[i]]$cov,
                                                                     elip.ord.post.mal.rem.treat[[i]]$center,
                                                                     elip.ord.post.mal.rem.treat[[i]]$scale))),
                                  group=i))
}

# Plot w/ treatment ellip
plot_ordination(physeq=physeq.post.mal.rem, ordination=bray.nmds.post.mal.rem, color="Treatment") +
  #scale_fill_manual(values=c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#f781bf", "#a65628", "#ffff33", "#ff7f00")) +
  geom_path(data=elip.post.mal.rem.treat.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)
```